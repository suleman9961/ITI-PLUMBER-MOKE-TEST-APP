<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mock Test Ncn - Admin Panel & Free Premium</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #E0F2FE; /* Light blue background */
            padding-bottom: 80px; /* Footer padding */
            overflow-x: hidden;
        }
        .premium-tag { background-color: #FFA726; color: black; }
        .free-tag { background-color: #66BB6A; color: white; }
        .start-now-button-original-style { background-color: #EC4899; } /* गुलाबी रंग */
        .plumber-tag { background-color: #FFCA28; color: #374151; } /* पीला रंग */
        .card-icon-placeholder { width: 50px; height: 50px; background-color: #E5E7EB; border-radius: 0.375rem; display: flex; align-items: center; justify-content: center; font-size: 0.75rem; color: #6B7280; flex-shrink: 0; }
        .practice-button { background-color: #3B82F6; } /* नीला रंग */
        .social-icon { width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; border-radius: 0.5rem; }
        .sidebar { transition: transform 0.3s ease-in-out; transform: translateX(-100%); }
        .sidebar.open { transform: translateX(0); }
        .sidebar-overlay { transition: opacity 0.3s ease-in-out; }
        .modal-container { background-color: rgba(0, 0, 0, 0.75); transition: opacity 0.3s ease-in-out, visibility 0.3s ease-in-out; }
        .modal-content { max-height: 90vh; transition: transform 0.3s ease-out, opacity 0.3s ease-out; transform: translateY(-20px) scale(0.95); opacity: 0; }
        .modal-container.active {
            opacity: 1;
            visibility: visible;
        }
        .modal-container.active .modal-content { transform: translateY(0) scale(1); opacity: 1; }

        .quiz-option { transition: background-color 0.2s ease, border-color 0.2s ease; }
        .quiz-option:hover { background-color: #d1e5fb; border-color: #3B82F6; }
        .quiz-option.selected { background-color: #3B82F6; color: white; border-color: #2563EB; }
        .quiz-option.correct { background-color: #10B981; color: white; border-color: #059669; }
        .quiz-option.incorrect { background-color: #EF4444; color: white; border-color: #DC2626; }
        .quiz-option.disabled { opacity: 0.5; pointer-events: none; }
        .lifeline-btn.disabled { opacity: 0.4; cursor: not-allowed; background-color: #9CA3AF !important; }
        .timer-bar { height: 8px; background-color: #3B82F6; transition: width 1s linear; width: 100%; }
        .audience-poll-bar { background-color: #3B82F6; transition: width 0.5s ease-out; }
        .coin-icon { width: 20px; height: 20px; margin-left: 5px; vertical-align: middle; }
        .sub-card-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 0.75rem; /* gap-3 */
            margin-top: 0.75rem; /* mt-3 */
        }
        .sub-card {
            padding: 0.75rem; /* p-3 */
            border-radius: 0.375rem; /* rounded-md */
            text-align: left;
            transition: background-color 0.2s ease;
            cursor: pointer;
        }
        .premium-sub-card {
            background-color: #4A5568; /* bg-slate-700 */
            color: white;
        }
        .premium-sub-card:hover {
            background-color: #2D3748; /* bg-slate-800 or darker */
        }
        
        .free-sub-card {
            background-color: #EBF8FF; /* bg-blue-50 */
            color: #2B6CB0; /* text-blue-700 */
            border: 1px solid #BEE3F8; /* border-blue-200 */
        }
        .free-sub-card:hover {
            background-color: #C3DAFE; /* bg-blue-200 */
        }
        .tab-button.active {
            border-bottom-color: #3B82F6; /* blue-600 */
            color: #3B82F6; /* blue-600 */
            font-weight: 600;
        }
        .error-message {
            color: #EF4444; /* text-red-500 */
            font-size: 0.875rem; /* text-sm */
            margin-top: 0.25rem; /* mt-1 */
        }
        .tool-category-header, .tool-subcategory-header {
            cursor: pointer;
            transition: background-color 0.2s ease;
        }
        .tool-category-header:hover, .tool-subcategory-header:hover {
            background-color: #e2e8f0; /* Tailwind gray-200 */
        }
        .tool-item {
            transition: background-color 0.2s ease;
        }
        .tool-item:hover {
            background-color: #f0f9ff; /* Tailwind sky-50 */
        }
        .tool-list-container, .tool-subcategory-container {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out;
        }
        .tool-list-container.open, .tool-subcategory-container.open {
            max-height: 1000px; /* जरूरत के अनुसार समायोजित करें */
        }
        .content-modal-tool-detail {
            margin-bottom: 0.75rem; /* mb-3 */
            padding: 0.75rem; /* p-3 */
            background-color: #f9fafb; /* bg-gray-50 */
            border-left: 4px solid #3b82f6; /* border-blue-500 */
            border-radius: 0.25rem; /* rounded-sm */
        }
        .content-modal-tool-detail strong {
            color: #1d4ed8; /* text-blue-700 */
        }
        .favorite-btn {
            background: none; border: none; cursor: pointer;
            color: #cbd5e1; /* Tailwind gray-300 */
            transition: color 0.2s;
        }
        .favorite-btn:hover { color: #f59e0b; /* Tailwind amber-500 */ }
        .favorite-btn.favorited { color: #fbbf24; /* Tailwind amber-400 */ }

        .whatsapp-share-button {
            background-color: #25D366;
            color: white;
            padding: 10px 15px;
            border-radius: 8px;
            text-decoration: none;
            font-weight: 500;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            transition: background-color 0.2s;
        }
        .whatsapp-share-button:hover { background-color: #1DAE50; }
        
        .modal-container {
            display: none; 
            opacity: 0;
            visibility: hidden;
        }
        .modal-container.active {
            display: flex; 
            opacity: 1;
            visibility: visible;
        }

        .gemini-loader {
            display: none; /* Hidden by default */
            align-items: center;
            justify-content: center;
            padding: 0.5rem;
            font-size: 0.875rem; /* text-sm */
            color: #1d4ed8; /* text-blue-700 */
        }
        .gemini-loader.active {
            display: flex;
        }
        .gemini-spinner {
            width: 1rem; /* w-4 */
            height: 1rem; /* h-4 */
            border-width: 2px;
            border-style: solid;
            border-color: currentColor;
            border-right-color: transparent;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 0.5rem; /* mr-2 */
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .quiz-ai-explanation {
            margin-top: 1rem; /* mt-4 */
            padding: 0.75rem; /* p-3 */
            background-color: #f3f4f6; /* bg-gray-100 */
            border-left: 4px solid #60a5fa; /* border-blue-400 */
            border-radius: 0.25rem; /* rounded-sm */
            font-size: 0.875rem; /* text-sm */
            color: #374151; /* text-gray-700 */
        }
        .admin-table th, .admin-table td {
            padding: 0.75rem;
            text-align: left;
            border-bottom: 1px solid #e5e7eb;
        }
        .admin-table th {
            background-color: #f3f4f6;
            font-weight: 600;
            color: #374151;
        }
    </style>
</head>
<body>

    <!-- Sidebar -->
    <div id="sidebar" class="sidebar fixed top-0 left-0 h-full w-64 sm:w-72 bg-slate-800 text-white z-[60] shadow-lg p-0 flex flex-col">
        <div class="bg-blue-600 p-4 flex items-center space-x-3">
            <img src="https://placehold.co/40x40/FFFFFF/3B82F6?text=Logo" alt="Logo" class="w-10 h-10 rounded-md bg-white p-1">
            <div>
                <h2 class="text-lg font-semibold">Mock Test</h2>
                <p class="text-sm text-blue-200">NcvtOnline</p>
            </div>
        </div>
        <nav class="flex-grow pt-4 space-y-1 overflow-y-auto">
            <a href="#" id="sidebarProfileLink" class="flex items-center px-4 py-3 text-sm text-slate-200 hover:bg-slate-700 rounded-md mx-2">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5 mr-3"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 6a3.75 3.75 0 1 1-7.5 0 3.75 3.75 0 0 1 7.5 0ZM4.501 20.118a7.5 7.5 0 0 1 14.998 0A17.933 17.933 0 0 1 12 21.75c-2.676 0-5.216-.584-7.499-1.632Z" /></svg> Profile (प्रोफ़ाइल)
            </a>
            <a href="#" id="sidebarTopScorerLink" class="flex items-center px-4 py-3 text-sm text-slate-200 hover:bg-slate-700 rounded-md mx-2">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5 mr-3"><path stroke-linecap="round" stroke-linejoin="round" d="M3 13.125C3 12.504 3.504 12 4.125 12h2.25c.621 0 1.125.504 1.125 1.125v6.75C7.5 20.496 6.996 21 6.375 21h-2.25A1.125 1.125 0 0 1 3 19.875v-6.75ZM9.75 8.625c0-.621.504-1.125 1.125-1.125h2.25c.621 0 1.125.504 1.125 1.125v11.25c0 .621-.504 1.125-1.125 1.125h-2.25a1.125 1.125 0 0 1-1.125-1.125V8.625ZM16.5 4.125c0-.621.504-1.125 1.125-1.125h2.25C20.496 3 21 3.504 21 4.125v15.75c0 .621-.504 1.125-1.125 1.125h-2.25a1.125 1.125 0 0 1-1.125-1.125V4.125Z" /></svg> Top Scorer (शीर्ष स्कोरर)
            </a>
            <a href="#" id="sidebarFavoriteQuestionLink" class="flex items-center px-4 py-3 text-sm text-slate-200 hover:bg-slate-700 rounded-md mx-2">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5 mr-3"><path stroke-linecap="round" stroke-linejoin="round" d="M17.593 3.322c1.1.128 1.907 1.077 1.907 2.185V21L12 17.5 4.5 21V5.507c0-1.108.806-2.057 1.907-2.185a48.507 48.507 0 0 1 11.186 0Z" /></svg> Favorite Question (पसंदीदा प्रश्न)
            </a>
            <a href="#" id="sidebarInviteFriendsLink" class="flex items-center px-4 py-3 text-sm text-slate-200 hover:bg-slate-700 rounded-md mx-2">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5 mr-3"><path stroke-linecap="round" stroke-linejoin="round" d="M18 7.5v3m0 0v3m0-3h3m-3 0h-3m-2.25-4.125a3.375 3.375 0 1 1-6.75 0 3.375 3.375 0 0 1 6.75 0ZM3 19.235v-.11a6.375 6.375 0 0 1 12.75 0v.109A12.318 12.318 0 0 1 9.374 21c-2.331 0-4.512-.645-6.374-1.766Z" /></svg> Invite friends (दोस्तों को आमंत्रित करें)
            </a>
            <a href="#" id="sidebarRaiseComplaintLink" class="flex items-center px-4 py-3 text-sm text-slate-200 hover:bg-slate-700 rounded-md mx-2">
                 <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5 mr-3"><path stroke-linecap="round" stroke-linejoin="round" d="M21.75 6.75v10.5a2.25 2.25 0 0 1-2.25 2.25h-15a2.25 2.25 0 0 1-2.25-2.25V6.75m19.5 0A2.25 2.25 0 0 0 19.5 4.5h-15a2.25 2.25 0 0 0-2.25 2.25m19.5 0v.243a2.25 2.25 0 0 1-1.07 1.916l-7.5 4.615a2.25 2.25 0 0 1-2.36 0L3.32 8.91a2.25 2.25 0 0 1-1.07-1.916V6.75" /></svg> Raise Complaint (शिकायत दर्ज करें)
            </a>
            <a href="#" id="sidebarInstructionLink" class="flex items-center px-4 py-3 text-sm text-slate-200 hover:bg-slate-700 rounded-md mx-2">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5 mr-3"><path stroke-linecap="round" stroke-linejoin="round" d="M3.75 6.75h16.5M3.75 12h16.5m-16.5 5.25H12" /></svg> Instruction (निर्देश)
            </a>
            <div class="border-t border-slate-700 my-2 mx-2"></div>
            <a href="#" id="sidebarAdminPanelLink" class="flex items-center px-4 py-3 text-sm text-yellow-300 hover:bg-slate-700 rounded-md mx-2">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5 mr-3"><path stroke-linecap="round" stroke-linejoin="round" d="M10.5 6h9.75M10.5 6a1.5 1.5 0 1 1-3 0m3 0a1.5 1.5 0 1 0-3 0M3.75 6H7.5m3 12h9.75m-9.75 0a1.5 1.5 0 0 1-3 0m3 0a1.5 1.5 0 0 0-3 0m-3.75 0H7.5m9-6h3.75m-3.75 0a1.5 1.5 0 0 1-3 0m3 0a1.5 1.5 0 0 0-3 0m-9.75 0h9.75" /></svg> Admin Panel (एडमिन पैनल)
            </a>
             <a href="#" id="sidebarLogoutLink" class="flex items-center px-4 py-3 text-sm text-slate-200 hover:bg-slate-700 rounded-md mx-2 mt-auto mb-2 hidden">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5 mr-3"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 9V5.25A2.25 2.25 0 0 0 13.5 3h-6a2.25 2.25 0 0 0-2.25 2.25v13.5A2.25 2.25 0 0 0 7.5 21h6a2.25 2.25 0 0 0 2.25-2.25V15m3 0h3m0 0-3-3m3 3-3 3" /></svg> Logout (लॉग आउट)
            </a>
        </nav>
    </div>
    <div id="sidebarOverlay" class="sidebar-overlay fixed inset-0 bg-black bg-opacity-50 z-50 hidden"></div>

    <!-- Header -->
    <header class="bg-blue-600 text-white p-4 shadow-md sticky top-0 z-40">
        <div class="container mx-auto flex items-center justify-between">
            <button id="hamburgerButton" aria-label="Open menu" class="p-1 -ml-1">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-7 h-7">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M3.75 6.75h16.5M3.75 12h16.5m-16.5 5.25h16.5" />
                </svg>
            </button>
            <h1 class="text-xl font-semibold">Mock Test Ncn</h1>
            <div class="flex items-center space-x-3">
                <a id="whatsappShareHeader" href="#" target="_blank" class="whatsapp-share-button text-sm p-2">
                    <i class="fab fa-whatsapp"></i> Share
                </a>
                <button id="headerUserIcon" aria-label="User profile or Login/Signup" class="focus:outline-none">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-7 h-7">
                      <path stroke-linecap="round" stroke-linejoin="round" d="M17.982 18.725A7.488 7.488 0 0 0 12 15.75a7.488 7.488 0 0 0-5.982 2.975m11.963 0a9 9 0 1 0-11.963 0m11.963 0A8.966 8.966 0 0 1 12 21a8.966 8.966 0 0 1-5.982-2.275M15 9.75a3 3 0 1 1-6 0 3 3 0 0 1 6 0Z" />
                    </svg>
                </button>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <div class="container mx-auto p-4">
        <!-- Loading Overlay -->
        <div id="loadingOverlay" class="fixed inset-0 bg-white bg-opacity-75 flex items-center justify-center z-[200]" style="display: none;">
            <div class="animate-spin rounded-full h-16 w-16 border-t-4 border-b-4 border-blue-500"></div>
            <p class="ml-3 text-blue-700 font-semibold">Loading data... (डेटा लोड हो रहा है...)</p>
        </div>

        <!-- User Profile Section -->
        <section class="bg-blue-500 text-white p-4 rounded-lg shadow-lg mt-1">
            <div class="flex items-center mb-2">
                <img id="userAvatarMain" src="https://placehold.co/60x60/FFFFFF/3B82F6?text=U" alt="User Avatar" class="w-12 h-12 rounded-full border-2 border-white mr-3">
                <div>
                    <h2 id="userNameMain" class="text-lg font-semibold">Guest User</h2>
                    <span id="userCoinsDisplay" class="ml-0 text-yellow-300 font-bold">(<span id="coinCount">0</span> 🪙)</span>
                    <div class="flex space-x-4 text-sm mt-1">
                        <span>ID: <span id="userIdDisplay" class="font-normal">N/A</span></span>
                    </div>
                </div>
            </div>
            <div class="mt-2 text-center">
                <span class="plumber-tag inline-block px-3 py-1 text-sm font-semibold rounded-md shadow">Plumber</span>
            </div>
        </section>

        <!-- Start Quiz Section -->
        <section class="bg-white p-5 rounded-lg shadow-lg mt-5">
            <div class="flex justify-between items-center">
                <h2 class="text-xl font-bold text-blue-700">Ncvt Online Learning</h2>
            </div>
            <button id="triggerQuizButton" class="start-now-button-original-style w-full text-white font-semibold py-3 px-4 rounded-lg mt-4 flex items-center justify-center text-lg hover:bg-pink-600 transition duration-150">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-6 h-6 mr-2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M5.25 5.653c0-.856.917-1.398 1.667-.986l11.54 6.347a1.125 1.125 0 0 1 0 1.972l-11.54 6.347a1.125 1.125 0 0 1-1.667-.986V5.653Z" />
                </svg>
                Start Now (Quiz) (अभी शुरू करें (क्विज))
            </button>
        </section>

        <!-- Mock Test Sections -->
        <section class="mt-6">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-semibold text-gray-800">All Mock Test For Your Trade (आपके ट्रेड के लिए सभी मॉक टेस्ट)</h3>
                <a href="#" class="text-blue-600 font-medium hover:underline text-sm">View All (सभी देखें)</a>
            </div>
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-5">
                <!-- Free Test Card -->
                <div id="freeTestCardPlumberEnglish" class="bg-white rounded-xl shadow-lg p-4 relative border-t-4 border-blue-500">
                    <span class="free-tag absolute top-3 right-3 px-2 py-1 text-xs font-semibold rounded">Free</span>
                    <div class="flex items-start space-x-3">
                        <div class="card-icon-placeholder">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-8 h-8 text-blue-500"><path stroke-linecap="round" stroke-linejoin="round" d="M12 6.042A8.967 8.967 0 0 0 6 3.75c-1.052 0-2.062.18-3 .512v14.25A8.987 8.987 0 0 1 6 18c2.305 0 4.408.867 6 2.292m0-14.25a8.966 8.966 0 0 1 6-2.292c1.052 0 2.062.18 3 .512v14.25A8.987 8.987 0 0 0 18 18a8.967 8.967 0 0 0-6-2.292m0 0V21M12 6.042A8.967 8.967 0 0 1 18 3.75m0 14.25V6.042" /></svg>
                        </div>
                        <div>
                            <h4 class="text-md font-bold text-gray-800">ITI Mock Test</h4>
                            <p class="text-sm text-gray-600 font-medium">Plumber All Subject</p>
                            <p class="text-xs text-gray-500">( English )</p>
                        </div>
                    </div>
                    <div class="mt-3 pt-3 border-t border-gray-200">
                        <p class="text-sm font-semibold text-blue-700 mb-2">Plumber - English Sections</p>
                        <div id="freePlumberEnglishSubCardsContainer" class="sub-card-grid">
                            <button class="sub-card free-sub-card" data-subtest="basic_concepts_en"><h5 class="font-semibold">Basic Concepts</h5><p class="text-xs">Learn fundamentals</p></button>
                            <button class="sub-card free-sub-card" data-subtest="safety_symbols_en"><h5 class="font-semibold">Safety Symbols</h5><p class="text-xs">Understand signs</p></button>
                            <button class="sub-card free-sub-card" data-subtest="measurement_tools_en"><h5 class="font-semibold">Measurement Tools</h5><p class="text-xs">Tool details</p></button>
                            <button class="sub-card free-sub-card" data-subtest="practice_drills_en"><h5 class="font-semibold">Practice Drills</h5><p class="text-xs">Quick exercises</p></button>
                        </div>
                    </div>
                </div>
                <!-- "Premium" now Free Test Card -->
                <div id="premiumTestCardPlumberHindi" class="bg-slate-800 text-white rounded-xl shadow-lg p-4 relative border-t-4 border-green-400">
                     <span class="free-tag absolute top-3 right-3 px-2 py-1 text-xs font-semibold rounded">Now Free!</span>
                     <div class="flex items-start space-x-3">
                        <div class="card-icon-placeholder bg-slate-700">
                             <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-8 h-8 text-green-400"><path stroke-linecap="round" stroke-linejoin="round" d="M13.5 10.5V6.75a4.5 4.5 0 1 0-9 0v3.75M3.75 21.75h16.5a1.5 1.5 0 0 0 1.5-1.5v-6.75a1.5 1.5 0 0 0-1.5-1.5H3.75a1.5 1.5 0 0 0-1.5 1.5v6.75a1.5 1.5 0 0 0 1.5 1.5Z" /></svg>
                        </div>
                        <div>
                            <h4 class="text-md font-bold text-white">ITI Mock Test (Hindi Section)</h4>
                            <p class="text-sm text-slate-300 font-medium">प्लम्बर सभी विषय</p>
                            <p class="text-xs text-slate-400">( English | हिंदी )</p>
                        </div>
                    </div>
                    <div class="mt-3 pt-3 border-t border-slate-700">
                        <div id="premiumPlumberHindiStatus" class="mb-2 text-sm text-green-300">यह सेक्शन अब सभी के लिए मुफ्त है!</div>
                        <div id="premiumPlumberHindiSubCardsContainer" class="sub-card-grid">
                            <button class="sub-card premium-sub-card" data-subtest="handwritten_notes_hi"><h5 class="font-semibold">हस्तलिखित नोट्स (PDF)</h5><p class="text-xs text-slate-400">विस्तृत नोट्स पढ़ें</p></button>
                            <button class="sub-card premium-sub-card" data-subtest="theory_hi"><h5 class="font-semibold">थ्योरी</h5><p class="text-xs text-slate-400">अवधारणाएं समझें</p></button>
                            <button class="sub-card premium-sub-card" data-subtest="mock_test_hi"><h5 class="font-semibold">मॉक टेस्ट (PDF)</h5><p class="text-xs text-slate-400">परीक्षा का अभ्यास करें</p></button>
                            <button class="sub-card premium-sub-card" data-subtest="test_preparation_hi"><h5 class="font-semibold">टेस्ट तैयारी (1000 MCQ)</h5><p class="text-xs text-slate-400">रणनीतियाँ और सुझाव</p></button>
                            <button class="sub-card premium-sub-card" data-subtest="file_making_hi"><h5 class="font-semibold">फाइल मेकिंग (Images)</h5><p class="text-xs text-slate-400">प्रैक्टिकल कार्य</p></button>
                            <button class="sub-card premium-sub-card" data-subtest="tools_detail_hi"><h5 class="font-semibold">उपकरण विवरण (AI)</h5><p class="text-xs text-slate-400">उपकरणों की जानकारी</p></button>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- All Tools Section -->
        <section class="bg-white p-5 rounded-lg shadow-lg mt-6">
            <div class="flex items-center mb-4">
                <div class="card-icon-placeholder bg-cyan-100 mr-3"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-7 h-7 text-cyan-600"><path stroke-linecap="round" stroke-linejoin="round" d="M11.42 15.17 17.25 21A2.652 2.652 0 0 0 21 17.25l-5.83-5.83M11.42 15.17A3 3 0 0 1 6.344 12.74l-2.531-2.531a2.25 2.25 0 0 1 0-3.182l2.25-2.25a2.25 2.25 0 0 1 3.182 0l2.531 2.531S15 10.585 15 12.75a3 3 0 0 1-3.58 2.42Z" /></svg></div>
                <h3 class="text-lg font-semibold text-gray-800">All Tools (सभी उपकरण)</h3>
            </div>
            <div id="allToolsContainer" class="space-y-3">
                <!-- Tools will be rendered here by JavaScript -->
            </div>
        </section>

        <!-- Important Q&A Section -->
        <section class="bg-white p-5 rounded-lg shadow-lg mt-6">
            <div class="flex items-center mb-3">
                <div class="card-icon-placeholder bg-teal-100 mr-3">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-7 h-7 text-teal-500">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M9.879 7.519c1.171-1.025 3.071-1.025 4.242 0 1.172 1.025 1.172 2.687 0 3.712-.203.179-.43.326-.67.442-.745.361-1.45.999-1.45 1.827v.75M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Zm-9 5.25h.008v.008H12v-.008Z" />
                    </svg>
                </div>
                <h3 class="text-md font-semibold text-gray-800">अति महत्वपूर्ण प्रश्न और उत्तर (Very Important Q&A)</h3>
            </div>
            <button id="showRandomImpQuestionBtn" class="w-full bg-sky-500 hover:bg-sky-600 text-white font-semibold py-3 px-4 rounded-lg mt-2 flex items-center justify-center text-lg transition duration-150">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6 mr-2"><path stroke-linecap="round" stroke-linejoin="round" d="M19.5 12c0-1.232-.046-2.453-.138-3.662a4.006 4.006 0 0 0-3.7-3.7 48.678 48.678 0 0 0-7.324 0 4.006 4.006 0 0 0-3.7 3.7c-.092 1.21-.138 2.43-.138 3.662v1.515A2.25 2.25 0 0 0 5.25 15h13.5a2.25 2.25 0 0 0 2.25-2.25V12Zm-15-1.5a.75.75 0 0 0-.75.75V12a.75.75 0 0 0 .75.75h13.5a.75.75 0 0 0 .75-.75V11.25a.75.75 0 0 0-.75-.75H4.5Z" /></svg>
                अगला महत्वपूर्ण प्रश्न देखें (Show Next Important Question)
            </button>
            <div id="importantQuestionDisplayArea" class="mt-4 p-4 bg-gray-100 rounded-md min-h-[100px] text-gray-700" style="display: none;">
                <h4 id="importantQuestionText" class="font-semibold text-md mb-2"></h4>
                <p id="importantAnswerText" class="text-sm"></p>
            </div>

            <!-- Gemini Q&A Section -->
            <div class="mt-6 pt-4 border-t border-gray-200">
                <h3 class="text-md font-semibold text-gray-800 mb-2">✨ अपना सवाल Gemini से पूछें (Ask Gemini Your Question)</h3>
                <div class="flex flex-col sm:flex-row gap-2">
                    <input type="text" id="userGeminiQuestion" placeholder="अपना प्लंबिंग सवाल यहाँ लिखें..." class="flex-grow p-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                    <button id="askGeminiButton" class="bg-purple-600 hover:bg-purple-700 text-white font-semibold py-2 px-4 rounded-lg transition flex items-center justify-center">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5 mr-2"><path stroke-linecap="round" stroke-linejoin="round" d="M9.813 15.904L9 18.75l-.813-2.846a4.5 4.5 0 00-3.09-3.09L1.25 9l2.846-.813a4.5 4.5 0 003.09-3.09L9 1.25l.813 2.846a4.5 4.5 0 003.09 3.09L15.75 9l-2.846.813a4.5 4.5 0 00-3.09 3.09Z"M18.25 10.875L17.5 13.5l-.75-2.625a3.375 3.375 0 00-2.625-2.625L10.5 7.5l2.625-.75a3.375 3.375 0 002.625-2.625L17.5 1.5l.75 2.625a3.375 3.375 0 002.625 2.625L23.25 7.5l-2.625.75a3.375 3.375 0 00-2.625 2.625Z" /></svg>
                        पूछें (Ask)
                    </button>
                </div>
                <div id="geminiQALoader" class="gemini-loader mt-2">
                    <div class="gemini-spinner"></div>
                    Gemini से पूछा जा रहा है...
                </div>
                <div id="geminiAnswerArea" class="mt-3 p-3 bg-purple-50 border border-purple-200 rounded-md text-gray-700 text-sm" style="display: none;">
                    <!-- Gemini's answer will appear here -->
                </div>
            </div>
        </section>
    </div>

    <!-- Footer Navigation -->
    <footer class="fixed bottom-0 left-0 right-0 bg-white shadow-t-lg border-t border-gray-200 p-3 flex justify-around items-center z-40">
        <button class="flex flex-col items-center text-blue-600 hover:text-blue-800"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-7 h-7"><path stroke-linecap="round" stroke-linejoin="round" d="m2.25 12 8.954-8.955c.44-.439 1.152-.439 1.591 0L21.75 12M4.5 9.75v10.125c0 .621.504 1.125 1.125 1.125H9.75v-4.875c0-.621.504-1.125 1.125-1.125h2.25c.621 0 1.125.504 1.125 1.125V21h4.125c.621 0 1.125-.504 1.125-1.125V9.75M8.25 21h7.5" /></svg><span class="text-xs mt-1">Home</span></button>
        <button class="flex flex-col items-center text-gray-500 hover:text-blue-600"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-7 h-7"><path stroke-linecap="round" stroke-linejoin="round" d="M12 6.042A8.967 8.967 0 0 0 6 3.75c-1.052 0-2.062.18-3 .512v14.25A8.987 8.987 0 0 1 6 18c2.305 0 4.408.867 6 2.292m0-14.25a8.966 8.966 0 0 1 6-2.292c1.052 0 2.062.18 3 .512v14.25A8.987 8.987 0 0 0 18 18a8.967 8.967 0 0 0-6-2.292m0 0V21M12 6.042A8.967 8.967 0 0 1 18 3.75m0 14.25V6.042" /></svg><span class="text-xs mt-1">Tests</span></button>
        <button id="footerProfileButton" class="flex flex-col items-center text-gray-500 hover:text-blue-600"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-7 h-7"><path stroke-linecap="round" stroke-linejoin="round" d="M17.982 18.725A7.488 7.488 0 0 0 12 15.75a7.488 7.488 0 0 0-5.982 2.975m11.963 0a9 9 0 1 0-11.963 0m11.963 0A8.966 8.966 0 0 1 12 21a8.966 8.966 0 0 1-5.982-2.275M15 9.75a3 3 0 1 1-6 0 3 3 0 0 1 6 0Z" /></svg><span class="text-xs mt-1">Profile</span></button>
    </footer>

    <!-- MODALS SECTION -->
    
    <!-- Authentication Modal -->
    <div id="authModal" class="modal-container fixed inset-0 z-[100] flex items-center justify-center p-4">
        <div class="modal-content bg-slate-50 w-full max-w-md rounded-xl shadow-2xl p-6 overflow-y-auto">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold text-blue-700">Profile / Authentication</h2>
                <button id="closeAuthModalButton" class="text-gray-500 hover:text-gray-700">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-7 h-7"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg>
                </button>
            </div>
            <div id="authStatus" class="mb-4 p-3 bg-blue-100 text-blue-700 rounded-md text-sm hidden"></div>
            <div class="mb-4 border-b border-gray-200">
                <nav class="flex space-x-4" aria-label="Tabs">
                    <button id="loginTabButton" class="tab-button py-3 px-1 border-b-2 border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 text-sm font-medium active">Login</button>
                    <button id="signupTabButton" class="tab-button py-3 px-1 border-b-2 border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 text-sm font-medium">Signup</button>
                </nav>
            </div>
            <form id="loginForm" class="space-y-4">
                <div><label for="loginEmail" class="block text-sm font-medium text-gray-700">Email</label><input type="email" id="loginEmail" name="loginEmail" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm"></div>
                <div><label for="loginPassword" class="block text-sm font-medium text-gray-700">Password</label><input type="password" id="loginPassword" name="loginPassword" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm"></div>
                <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-lg transition">Login</button>
                <p id="loginError" class="error-message hidden"></p>
            </form>
            <form id="signupForm" class="space-y-4 hidden">
                <div><label for="signupName" class="block text-sm font-medium text-gray-700">Full Name</label><input type="text" id="signupName" name="signupName" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm"></div>
                <div><label for="signupEmail" class="block text-sm font-medium text-gray-700">Email</label><input type="email" id="signupEmail" name="signupEmail" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm"></div>
                <div><label for="signupPassword" class="block text-sm font-medium text-gray-700">Password</label><input type="password" id="signupPassword" name="signupPassword" required minlength="6" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm"></div>
                <button type="submit" class="w-full bg-green-500 hover:bg-green-600 text-white font-semibold py-2 px-4 rounded-lg transition">Signup</button>
                <p id="signupError" class="error-message hidden"></p>
            </form>
        </div>
    </div>
    
    <!-- Top Scorer Modal -->
    <div id="topScorerModal" class="modal-container fixed inset-0 z-[95] flex items-center justify-center p-4">
        <div class="modal-content bg-slate-50 w-11/12 max-w-2xl rounded-xl shadow-2xl p-6 overflow-y-auto">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold text-blue-700">🏆 Top Scorers (शीर्ष स्कोरर) 🏆</h2>
                <button id="closeTopScorerModalButton" class="text-gray-500 hover:text-gray-700">
                     <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-7 h-7"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg>
                </button>
            </div>
            <div id="topScorerList" class="space-y-3"></div>
            <p class="mt-6 text-sm text-gray-600 text-center">Leaderboard data is fetched from Firebase. (लीडरबोर्ड डेटा फायरबेस से प्राप्त किया जाता है।)</p>
        </div>
    </div>
    
    <!-- Quiz Modal -->
    <div id="quizModal" class="modal-container fixed inset-0 z-[70] flex items-center justify-center p-4">
        <div class="modal-content bg-slate-50 w-11/12 max-w-5xl rounded-xl shadow-2xl p-6 overflow-y-auto">
            <!-- Quiz Setup Screen -->
            <div id="quizSetupScreen">
                <h2 class="text-2xl font-bold text-center text-blue-700 mb-6">प्लंबिंग क्विज़ (Plumbing Quiz)</h2>
                <p class="text-center text-gray-700 mb-2">आप कितने प्रश्न हल करना चाहते हैं?</p>
                <div class="flex justify-center space-x-3 mb-6">
                    <button data-count="5" class="num-questions-btn bg-blue-500 hover:bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg transition">5 प्रश्न</button>
                    <button data-count="10" class="num-questions-btn bg-blue-500 hover:bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg transition">10 प्रश्न</button>
                    <button data-count="15" class="num-questions-btn bg-blue-500 hover:bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg transition">15 प्रश्न</button>
                </div>
                <p class="text-center text-xs text-gray-500 mb-4">प्रत्येक प्रश्न के लिए 1 मिनट का समय होगा।</p>
                <button id="startSelectedQuizButton" class="w-full bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-4 rounded-lg text-lg transition disabled:opacity-50" disabled>क्विज़ शुरू करें</button>
                <button id="closeQuizSetupButton" class="mt-3 w-full bg-gray-300 hover:bg-gray-400 text-gray-800 font-semibold py-2 px-4 rounded-lg transition">बंद करें</button>
            </div>
            <!-- Quiz Interface Screen -->
            <div id="quizInterfaceScreen" class="hidden">
                <div class="flex justify-between items-center mb-1">
                    <h2 class="text-xl font-bold text-blue-700">प्रश्न <span id="currentQuestionNumber"></span>/<span id="totalQuizQuestions"></span></h2>
                    <div class="flex items-center">
                        <button id="favoriteQuestionButton" class="favorite-btn text-2xl"><i class="far fa-star"></i></button>
                        <div class="text-lg font-semibold text-red-500 ml-3">समय: <span id="quizTimer">01:00</span></div>
                    </div>
                </div>
                <div class="w-full bg-gray-300 rounded-full mb-4"><div id="questionTimerBar" class="timer-bar rounded-full"></div></div>
                <div id="questionImageContainer" class="mb-4 text-center hidden"><img id="questionImage" src="" alt="प्रश्न सम्बंधित चित्र" class="max-w-full h-auto max-h-60 sm:max-h-80 md:max-h-96 mx-auto rounded-lg shadow-md object-contain"></div>
                <p id="questionTextQuiz" class="text-lg sm:text-xl font-semibold text-gray-800 mb-5 min-h-[60px]"></p> 
                <div id="optionsContainer" class="space-y-3 mb-6"></div>
                
                <div id="geminiQuizExplanationLoader" class="gemini-loader mt-4"><div class="gemini-spinner"></div>AI से स्पष्टीकरण प्राप्त हो रहा है...</div>
                <div id="geminiQuizExplanationArea" class="quiz-ai-explanation" style="display: none;"></div>
                <div class="my-6">
                    <h3 class="text-md font-semibold text-gray-700 mb-2 text-center">लाइफलाइन (Lifelines):</h3>
                    <div class="flex justify-center space-x-2 sm:space-x-4">
                        <button id="lifeline5050" class="lifeline-btn bg-yellow-500 hover:bg-yellow-600 text-white font-semibold py-2 px-3 sm:px-4 rounded-lg flex items-center text-sm transition"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-5 h-5 mr-1 hidden sm:inline"><path stroke-linecap="round" stroke-linejoin="round" d="M12 6.75a.75.75 0 1 1 0-1.5.75.75 0 0 1 0 1.5ZM12 12.75a.75.75 0 1 1 0-1.5.75.75 0 0 1 0 1.5ZM12 18.75a.75.75 0 1 1 0-1.5.75.75 0 0 1 0 1.5Z" /></svg>50/50</button>
                        <button id="lifelineAudiencePoll" class="lifeline-btn bg-purple-500 hover:bg-purple-600 text-white font-semibold py-2 px-3 sm:px-4 rounded-lg flex items-center text-sm transition"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-5 h-5 mr-1 hidden sm:inline"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 6a3.75 3.75 0 1 1-7.5 0 3.75 3.75 0 0 1 7.5 0ZM4.501 20.118a7.5 7.5 0 0 1 14.998 0A17.933 17.933 0 0 1 12 21.75c-2.676 0-5.216-.584-7.499-1.632Z" /></svg>ऑडियंस पोल</button>
                    </div>
                </div>
                <div id="audiencePollResults" class="hidden mt-4 space-y-2"></div>
                <button id="nextQuestionButton" class="w-full bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-4 rounded-lg text-lg transition hidden">अगला प्रश्न</button>
                <button id="closeQuizInterfaceButton" class="mt-3 w-full bg-gray-300 hover:bg-gray-400 text-gray-800 font-semibold py-2 px-4 rounded-lg transition">क्विज़ बंद करें</button>
            </div>
            <!-- Quiz Results Screen -->
             <div id="quizResultsScreen" class="hidden text-center">
                <h2 class="text-3xl font-bold text-green-600 mb-4">क्विज़ समाप्त!</h2>
                <img src="https://placehold.co/100x100/E0F2FE/10B981?text=🏆" alt="Trophy" class="mx-auto mb-4 w-24 h-24">
                <p class="text-xl text-gray-800 mb-2">आपका स्कोर: <span id="finalScore"></span></p>
                <p class="text-lg text-gray-700 mb-2">सही उत्तर: <span id="correctAnswersCount"></span></p>
                <p class="text-lg text-gray-700 mb-6">आपने <span id="coinsEarnedInQuiz">0</span> सिक्के कमाए!</p>
                <div class="space-y-3 sm:space-y-0 sm:flex sm:space-x-4 justify-center">
                    <button id="playAgainButton" class="w-full sm:w-auto bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-6 rounded-lg text-lg transition">फिर से खेलें</button>
                    <button id="closeQuizResultsButton" class="w-full sm:w-auto bg-gray-500 hover:bg-gray-600 text-white font-semibold py-3 px-6 rounded-lg text-lg transition">बंद करें</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Content Modal (for free section items, tools, premium items, instructions) -->
    <div id="contentModal" class="modal-container fixed inset-0 z-[90] flex items-center justify-center p-4">
        <div class="modal-content bg-white w-11/12 max-w-4xl rounded-xl shadow-2xl p-6 overflow-y-auto">
            <div class="flex justify-between items-center mb-4">
                <h2 id="contentModalTitle" class="text-xl md:text-2xl font-bold text-blue-700">Content Title</h2>
                <button id="closeContentModalButton" class="text-gray-500 hover:text-gray-700">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-7 h-7"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg>
                </button>
            </div>
            <div id="contentModalImageContainer" class="mb-4 text-center hidden"><img id="contentModalImage" src="" alt="Content Image" class="max-w-full h-auto max-h-60 sm:max-h-80 md:max-h-96 mx-auto rounded-lg shadow-md object-contain"></div>
            <div id="contentModalBody" class="text-gray-700 space-y-2 text-sm sm:text-base md:text-lg"></div>
            <button id="getAdvancedToolInfoButton" class="hidden mt-3 w-full bg-indigo-500 hover:bg-indigo-600 text-white font-semibold py-2 px-3 rounded-lg transition flex items-center justify-center text-sm">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5 mr-2"><path stroke-linecap="round" stroke-linejoin="round" d="M9.813 15.904L9 18.75l-.813-2.846a4.5 4.5 0 00-3.09-3.09L1.25 9l2.846-.813a4.5 4.5 0 003.09-3.09L9 1.25l.813 2.846a4.5 4.5 0 003.09 3.09L15.75 9l-2.846.813a4.5 4.5 0 00-3.09 3.09Z"M18.25 10.875L17.5 13.5l-.75-2.625a3.375 3.375 0 00-2.625-2.625L10.5 7.5l2.625-.75a3.375 3.375 0 002.625-2.625L17.5 1.5l.75 2.625a3.375 3.375 0 002.625 2.625L23.25 7.5l-2.625.75a3.375 3.375 0 00-2.625 2.625Z" /></svg>
                ✨ Get Advanced Details with Gemini
            </button>
            <div id="geminiToolInfoLoader" class="gemini-loader mt-2"><div class="gemini-spinner"></div>Gemini से पूछा जा रहा है...</div>
            <div id="geminiToolInfoArea" class="mt-2 p-2 bg-indigo-50 border border-indigo-200 rounded-md text-gray-700 text-xs" style="display: none;"></div>
            <button id="shareContentButton" class="mt-4 w-full bg-yellow-400 hover:bg-yellow-500 text-white font-semibold py-2 px-4 rounded-lg transition"><i class="fas fa-share-alt mr-2"></i> Share This Content</button>
        </div>
    </div>
    
    <!-- Favorite Questions Modal -->
    <div id="favoriteQuestionsModal" class="modal-container fixed inset-0 z-[90] flex items-center justify-center p-4">
        <div class="modal-content bg-white w-11/12 max-w-3xl rounded-xl shadow-2xl p-6 overflow-y-auto">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold text-blue-700">पसंदीदा प्रश्न (Favorite Questions)</h2>
                <button id="closeFavoriteQuestionsModalButton" class="text-gray-500 hover:text-gray-700">
                     <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-7 h-7"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg>
                </button>
            </div>
            <div id="favoriteQuestionsList" class="space-y-4"></div>
        </div>
    </div>

    <!-- Complaint Modal -->
    <div id="complaintModal" class="modal-container fixed inset-0 z-[90] flex items-center justify-center p-4">
        <div class="modal-content bg-white w-full max-w-lg rounded-xl shadow-2xl p-6">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold text-blue-700">अपनी शिकायत दर्ज करें</h2>
                <button id="closeComplaintModalButton" class="text-gray-500 hover:text-gray-700">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-7 h-7"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg>
                </button>
            </div>
            <form id="complaintForm">
                <div class="mb-4">
                    <label for="complaintText" class="block text-sm font-medium text-gray-700 mb-1">आपकी समस्या/प्रश्न:</label>
                    <textarea id="complaintText" name="complaintText" rows="5" required class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"></textarea>
                </div>
                <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-lg transition">शिकायत भेजें</button>
            </form>
        </div>
    </div>
    
    <!-- Share Modal -->
    <div id="shareModal" class="modal-container fixed inset-0 z-[110] flex items-center justify-center p-4">
        <div class="modal-content bg-white w-full max-w-sm rounded-xl shadow-2xl p-6 text-center">
            <h2 class="text-xl font-bold text-gray-800 mb-4">Share (साझा करें)</h2>
            <p id="shareModalText" class="text-gray-700 mb-4 break-all"></p>
            <div class="flex justify-center space-x-3">
                <button id="copyShareTextButton" class="bg-blue-500 hover:bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg transition">Copy Text</button>
                <button id="closeShareModalButton" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-semibold py-2 px-4 rounded-lg transition">Close</button>
            </div>
        </div>
    </div>

    <!-- Admin Login Modal -->
    <div id="adminLoginModal" class="modal-container fixed inset-0 z-[120] flex items-center justify-center p-4">
        <div class="modal-content bg-slate-50 w-full max-w-sm rounded-xl shadow-2xl p-6">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold text-red-700">Admin Login</h2>
                <button id="closeAdminLoginModalButton" class="text-gray-500 hover:text-gray-700">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-7 h-7"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg>
                </button>
            </div>
            <form id="adminLoginForm" class="space-y-4">
                <div><label for="adminId" class="block text-sm font-medium text-gray-700">Admin ID</label><input type="text" id="adminId" name="adminId" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-red-500 focus:border-red-500 sm:text-sm"></div>
                <div><label for="adminPassword" class="block text-sm font-medium text-gray-700">Password</label><input type="password" id="adminPassword" name="adminPassword" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-red-500 focus:border-red-500 sm:text-sm"></div>
                <button type="submit" class="w-full bg-red-600 hover:bg-red-700 text-white font-semibold py-2 px-4 rounded-lg transition">Login</button>
                <p id="adminLoginError" class="error-message hidden"></p>
            </form>
        </div>
    </div>
    
    <!-- Admin Panel Modal -->
    <div id="adminPanelModal" class="modal-container fixed inset-0 z-[115] flex items-center justify-center p-4">
        <div class="modal-content bg-white w-11/12 max-w-4xl rounded-xl shadow-2xl p-6 overflow-y-auto">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold text-red-700">Admin Panel</h2>
                <button id="closeAdminPanelModalButton" class="text-gray-500 hover:text-gray-700">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-7 h-7"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg>
                </button>
            </div>
            <button id="openAddQuestionModalBtn" class="bg-green-600 hover:bg-green-700 text-white font-semibold py-2 px-4 rounded-lg mb-4 transition">+ Add New Question/Answer</button>
            <h3 class="text-xl font-semibold text-gray-800 mb-3">User Management</h3>
            <div class="overflow-x-auto">
                <table class="min-w-full bg-white admin-table">
                    <thead><tr><th>Name</th><th>Email</th><th>Coins</th></tr></thead>
                    <tbody id="adminUserList"></tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Add Question Modal -->
    <div id="addQuestionModal" class="modal-container fixed inset-0 z-[125] flex items-center justify-center p-4">
        <div class="modal-content bg-white w-11/12 max-w-2xl rounded-xl shadow-2xl p-6 overflow-y-auto">
             <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold text-green-700">Add New Question & Answer</h2>
                <button id="closeAddQuestionModalButton" class="text-gray-500 hover:text-gray-700">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-7 h-7"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg>
                </button>
            </div>
            <form id="addQuestionForm" class="space-y-4">
                <div>
                    <label for="questionSection" class="block text-sm font-medium text-gray-700">Section (सेक्शन)</label>
                    <select id="questionSection" name="questionSection" required class="mt-1 block w-full px-3 py-2 border border-gray-300 bg-white rounded-md shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500 sm:text-sm">
                        <option value="quiz">Quiz Question (क्विज़ प्रश्न)</option>
                        <option value="important">Important Q&A (महत्वपूर्ण प्रश्न)</option>
                    </select>
                </div>
                <div><label for="questionText" class="block text-sm font-medium text-gray-700">Question Text (प्रश्न)</label><input type="text" id="questionText" required class="mt-1 block w-full input-field"></div>
                <div id="answerTextInputContainer" class="hidden"><label for="answerText" class="block text-sm font-medium text-gray-700">Answer Text (उत्तर)</label><input type="text" id="answerText" class="mt-1 block w-full input-field"></div>
                
                <div id="quizOptionsContainer">
                    <div><label for="questionImage" class="block text-sm font-medium text-gray-700">Image URL (Optional)</label><input type="text" id="questionImage" placeholder="https://example.com/image.png" class="mt-1 block w-full input-field"></div>
                    <div><label for="option1" class="block text-sm font-medium text-gray-700">Option 1</label><input type="text" id="option1" required class="mt-1 block w-full input-field"></div>
                    <div><label for="option2" class="block text-sm font-medium text-gray-700">Option 2</label><input type="text" id="option2" required class="mt-1 block w-full input-field"></div>
                    <div><label for="option3" class="block text-sm font-medium text-gray-700">Option 3</label><input type="text" id="option3" required class="mt-1 block w-full input-field"></div>
                    <div><label for="option4" class="block text-sm font-medium text-gray-700">Option 4</label><input type="text" id="option4" required class="mt-1 block w-full input-field"></div>
                    <div>
                        <label for="correctAnswer" class="block text-sm font-medium text-gray-700">Correct Answer (सही उत्तर)</label>
                        <select id="correctAnswer" required class="mt-1 block w-full px-3 py-2 border border-gray-300 bg-white rounded-md shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500 sm:text-sm">
                            <option value="0">Option 1</option>
                            <option value="1">Option 2</option>
                            <option value="2">Option 3</option>
                            <option value="3">Option 4</option>
                        </select>
                    </div>
                </div>
                 <style>.input-field { px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500 sm:text-sm; }</style>
                <button type="submit" class="w-full bg-green-600 hover:bg-green-700 text-white font-semibold py-2 px-4 rounded-lg transition">Add Question</button>
            </form>
        </div>
    </div>

    <!-- ============================================================================== -->
    <!-- ===================== FIREBASE SDK IMPORTS START ============================= -->
    <!-- ============================================================================== -->
    <script type="module">
        // Firebase App (Core)
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        // Firebase Authentication
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        // Firestore Database
        import { getFirestore, doc, getDoc, setDoc, updateDoc, deleteDoc, onSnapshot, collection, query, where, addDoc, getDocs, serverTimestamp, runTransaction } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
    
        // Global Firebase instances (will be initialized in the main script)
        window.firebaseApp = null;
        window.firebaseDb = null;
        window.firebaseAuth = null;
        window.firebaseSDKLoaded = { // Make SDK functions available globally for the main script
            initializeApp,
            getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut,
            getFirestore, doc, getDoc, setDoc, updateDoc, deleteDoc, onSnapshot, collection, query, where, addDoc, getDocs, serverTimestamp, runTransaction
        };
        console.log("Firebase SDKs loaded via module script.");
    </script>
    <!-- ============================================================================== -->
    <!-- ===================== FIREBASE SDK IMPORTS END =============================== -->
    <!-- ============================================================================== -->


    <script defer> // Main Application Script - DEFER ADDED TO FIX RACE CONDITION
        // --- Gemini API Key Placeholder ---
        const GEMINI_API_KEY = "AIzaSyBpqWTCb4IeWcVTOI7t5zQvCymQEa9IVUo"; // For models other than gemini-2.0-flash or imagen-3.0-generate-002
        const GEMINI_API_URL_TEXT = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${GEMINI_API_KEY}`;

        // ============================================================================== //
        // ===================== FIREBASE SETUP START =================================== //
        // ============================================================================== //
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        let userProvidedFirebaseConfig = { 
            apiKey: "AIzaSyBNvDd6ALc0KVVHhsYfpiAF8eB1G3nkwzl",
            authDomain: "iti-app-e2fe8.firebaseapp.com",
            projectId: "iti-app-e2fe8",
            storageBucket: "iti-app-e2fe8.firebasestorage.app",
             messagingSenderId: "43689161734",
             appId: "1:43689161734:web:0372fccc7020d7594f3f87",
             measurementId: "G-NS90Y7EHZS",
            
        };
        
        let firebaseConfigToUse;
        if (typeof __firebase_config !== 'undefined' && __firebase_config && __firebase_config.trim() !== "") {
            try { firebaseConfigToUse = JSON.parse(__firebase_config); } catch (e) { firebaseConfigToUse = userProvidedFirebaseConfig; }
        } else { firebaseConfigToUse = userProvidedFirebaseConfig; }

        if (window.firebaseSDKLoaded) {
            try {
                window.firebaseApp = window.firebaseSDKLoaded.initializeApp(firebaseConfigToUse);
                window.firebaseAuth = window.firebaseSDKLoaded.getAuth(window.firebaseApp);
                window.firebaseDb = window.firebaseSDKLoaded.getFirestore(window.firebaseApp);
                console.log("Firebase initialized successfully with App ID:", appId);
            } catch (error) { console.error("Firebase initialization error:", error); }
        } else { console.error("Firebase SDK not loaded. Cannot initialize Firebase."); }
        // ============================================================================== //
        // ===================== FIREBASE SETUP END ===================================== //
        // ============================================================================== //


        // --- Global User Data Store ---
        let currentUserData = {
            userId: null, 
            displayName: "Guest User",
            email: null,
            coins: 0,
            favoriteQuestions: [], 
            isLoggedIn: false,
            isFirebaseUser: false
        };

        // DOM Elements
        const userNameMainEl = document.getElementById('userNameMain');
        const userAvatarMainEl = document.getElementById('userAvatarMain');
        const userIdDisplayEl = document.getElementById('userIdDisplay');
        const coinCountEl = document.getElementById('coinCount');
        const authModal = document.getElementById('authModal');
        const closeAuthModalButton = document.getElementById('closeAuthModalButton');
        const loginTabButton = document.getElementById('loginTabButton');
        const signupTabButton = document.getElementById('signupTabButton');
        const loginForm = document.getElementById('loginForm');
        const signupForm = document.getElementById('signupForm');
        const loginErrorEl = document.getElementById('loginError');
        const signupErrorEl = document.getElementById('signupError');
        const authStatusEl = document.getElementById('authStatus');
        const sidebarProfileLink = document.getElementById('sidebarProfileLink');
        const headerUserIcon = document.getElementById('headerUserIcon');
        const footerProfileButton = document.getElementById('footerProfileButton');
        const sidebarLogoutLink = document.getElementById('sidebarLogoutLink');
        const sidebarInstructionLink = document.getElementById('sidebarInstructionLink');
        const topScorerModal = document.getElementById('topScorerModal');
        const sidebarTopScorerLink = document.getElementById('sidebarTopScorerLink');
        const closeTopScorerModalButton = document.getElementById('closeTopScorerModalButton');
        const topScorerListEl = document.getElementById('topScorerList');
        const loadingOverlay = document.getElementById('loadingOverlay');
        const sidebarFavoriteQuestionLink = document.getElementById('sidebarFavoriteQuestionLink');
        const favoriteQuestionsModal = document.getElementById('favoriteQuestionsModal');
        const closeFavoriteQuestionsModalButton = document.getElementById('closeFavoriteQuestionsModalButton');
        const favoriteQuestionsListEl = document.getElementById('favoriteQuestionsList');
        const sidebarRaiseComplaintLink = document.getElementById('sidebarRaiseComplaintLink');
        const complaintModal = document.getElementById('complaintModal');
        const closeComplaintModalButton = document.getElementById('closeComplaintModalButton');
        const complaintForm = document.getElementById('complaintForm');
        const sidebarInviteFriendsLink = document.getElementById('sidebarInviteFriendsLink');
        const whatsappShareHeaderBtn = document.getElementById('whatsappShareHeader');
        const shareModal = document.getElementById('shareModal');
        const shareModalTextEl = document.getElementById('shareModalText');
        const copyShareTextButton = document.getElementById('copyShareTextButton');
        const closeShareModalButton = document.getElementById('closeShareModalButton');
        const showRandomImpQuestionBtn = document.getElementById('showRandomImpQuestionBtn');
        const importantQuestionDisplayArea = document.getElementById('importantQuestionDisplayArea');
        const importantQuestionTextEl = document.getElementById('importantQuestionText');
        const importantAnswerTextEl = document.getElementById('importantAnswerText');
        const premiumPlumberHindiSubCardsContainer = document.getElementById('premiumPlumberHindiSubCardsContainer');
        const userGeminiQuestionInput = document.getElementById('userGeminiQuestion');
        const askGeminiButton = document.getElementById('askGeminiButton');
        const geminiQALoader = document.getElementById('geminiQALoader');
        const geminiAnswerArea = document.getElementById('geminiAnswerArea');
        const getAdvancedToolInfoButton = document.getElementById('getAdvancedToolInfoButton');
        const geminiToolInfoLoader = document.getElementById('geminiToolInfoLoader');
        const geminiToolInfoArea = document.getElementById('geminiToolInfoArea');
        let currentToolForGemini = null; 
        const geminiQuizExplanationLoader = document.getElementById('geminiQuizExplanationLoader');
        const geminiQuizExplanationArea = document.getElementById('geminiQuizExplanationArea');
        
        // Admin Panel DOM elements
        const sidebarAdminPanelLink = document.getElementById('sidebarAdminPanelLink');
        const adminLoginModal = document.getElementById('adminLoginModal');
        const adminLoginForm = document.getElementById('adminLoginForm');
        const adminLoginError = document.getElementById('adminLoginError');
        const closeAdminLoginModalButton = document.getElementById('closeAdminLoginModalButton');
        const adminPanelModal = document.getElementById('adminPanelModal');
        const closeAdminPanelModalButton = document.getElementById('closeAdminPanelModalButton');
        const adminUserListEl = document.getElementById('adminUserList');
        const openAddQuestionModalBtn = document.getElementById('openAddQuestionModalBtn');
        const addQuestionModal = document.getElementById('addQuestionModal');
        const addQuestionForm = document.getElementById('addQuestionForm');
        const closeAddQuestionModalButton = document.getElementById('closeAddQuestionModalButton');
        const questionSectionSelect = document.getElementById('questionSection');
        const answerTextInputContainer = document.getElementById('answerTextInputContainer');
        const quizOptionsContainer = document.getElementById('quizOptionsContainer');

        // --- Firestore Helper Functions ---
        async function loadUserDataFromFirestore(userId) {
            if (!window.firebaseDb || !window.firebaseSDKLoaded) return null;
            const { doc, getDoc } = window.firebaseSDKLoaded;
            const userDocRef = doc(window.firebaseDb, "users", userId);
            try {
                const docSnap = await getDoc(userDocRef);
                return docSnap.exists() ? docSnap.data() : null;
            } catch (error) { console.error("Error loading user data:", error); return null; }
        }

        async function saveUserDataToFirestore(userId, userData) {
            if (!window.firebaseDb || !window.firebaseSDKLoaded) return { success: false, error: "Firestore not initialized" };
            const { doc, setDoc, serverTimestamp } = window.firebaseSDKLoaded;
            const userDocRef = doc(window.firebaseDb, "users", userId);
            try {
                const dataToSave = { ...userData, updatedAt: serverTimestamp() };
                if (!userData.createdAt) dataToSave.createdAt = serverTimestamp();
                await setDoc(userDocRef, dataToSave, { merge: true });
                return { success: true };
            } catch (error) { console.error("Error saving user data:", error); return { success: false, error: error.message }; }
        }
        
        async function loadAllUsersFromFirestore() {
            if (!window.firebaseDb || !window.firebaseSDKLoaded) return [];
            const { collection, getDocs } = window.firebaseSDKLoaded;
            const usersCollectionRef = collection(window.firebaseDb, "users");
            try {
                const querySnapshot = await getDocs(usersCollectionRef);
                const users = [];
                querySnapshot.forEach((doc) => users.push({ id: doc.id, ...doc.data() }));
                return users;
            } catch (error) { console.error("Error loading all users for admin:", error); return []; }
        }
        
        async function loadTopScorersFromFirestore() {
            const allUsers = await loadAllUsersFromFirestore();
            allUsers.sort((a, b) => (b.coins || 0) - (a.coins || 0));
            return allUsers.slice(0, 10);
        }

        // --- UI Update & Auth Logic ---
        function updateUIAfterAuthChange() {
            if (currentUserData.isLoggedIn && currentUserData.isFirebaseUser) { 
                userNameMainEl.textContent = currentUserData.displayName || "User";
                userIdDisplayEl.textContent = currentUserData.email || currentUserData.userId; 
                coinCountEl.textContent = currentUserData.coins || 0;
                sidebarLogoutLink.classList.remove('hidden');
                
                authStatusEl.textContent = `Logged in as: ${currentUserData.displayName || "User"} (${currentUserData.email || currentUserData.userId})`;
                authStatusEl.classList.remove('hidden');
                loginForm.classList.add('hidden'); 
                signupForm.classList.add('hidden');
                document.getElementById('loginTabButton').classList.add('hidden'); 
                document.getElementById('signupTabButton').classList.add('hidden'); 
            } else { 
                userNameMainEl.textContent = "Guest User (अतिथि)";
                userIdDisplayEl.textContent = "N/A";
                coinCountEl.textContent = 0;
                sidebarLogoutLink.classList.add('hidden');

                authStatusEl.classList.add('hidden');
                loginForm.classList.remove('hidden'); 
                signupForm.classList.add('hidden'); 
                document.getElementById('loginTabButton').classList.remove('hidden');
                document.getElementById('signupTabButton').classList.remove('hidden');
                loginTabButton.classList.add('active');
                signupTabButton.classList.remove('active');
            }
            updatePremiumTestUI();
            updateFavoriteQuestionIcons(); 
        }

        function openAuthModal() {
            authModal.classList.remove('hidden'); 
            setTimeout(() => authModal.classList.add('active'), 10); 
            document.body.style.overflow = 'hidden';
            loginErrorEl.classList.add('hidden');
            signupErrorEl.classList.add('hidden');
            loginForm.reset();
            signupForm.reset();
            updateUIAfterAuthChange(); 
        }
        
        closeAuthModalButton.addEventListener('click', () => {
            authModal.classList.remove('active');
            setTimeout(() => authModal.classList.add('hidden'), 300); 
            document.body.style.overflow = 'auto';
        });

        loginTabButton.addEventListener('click', () => {
            loginForm.classList.remove('hidden');
            signupForm.classList.add('hidden');
            loginTabButton.classList.add('active');
            signupTabButton.classList.remove('active');
        });

        signupTabButton.addEventListener('click', () => {
            loginForm.classList.add('hidden');
            signupForm.classList.remove('hidden');
            loginTabButton.classList.remove('active');
            signupTabButton.classList.add('active');
        });

        signupForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!window.firebaseAuth || !window.firebaseSDKLoaded) return;
            const { createUserWithEmailAndPassword } = window.firebaseSDKLoaded;

            const name = signupForm.signupName.value.trim();
            const email = signupForm.signupEmail.value.trim().toLowerCase();
            const password = signupForm.signupPassword.value;
            signupErrorEl.classList.add('hidden');

            loadingOverlay.style.display = 'flex';
            try {
                const userCredential = await createUserWithEmailAndPassword(window.firebaseAuth, email, password);
                const user = userCredential.user;
                const newUserFirestoreData = { displayName: name, email: user.email, coins: 100, favoriteQuestions: [] };
                await saveUserDataToFirestore(user.uid, newUserFirestoreData); 
                closeAuthModalButton.click(); 
            } catch (error) {
                signupErrorEl.textContent = error.message; 
                signupErrorEl.classList.remove('hidden');
            } finally {
                loadingOverlay.style.display = 'none';
            }
        });

        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!window.firebaseAuth || !window.firebaseSDKLoaded) return;
            const { signInWithEmailAndPassword } = window.firebaseSDKLoaded;
            const email = loginForm.loginEmail.value.trim().toLowerCase();
            const password = loginForm.loginPassword.value;
            loginErrorEl.classList.add('hidden');
            
            loadingOverlay.style.display = 'flex';
            try {
                await signInWithEmailAndPassword(window.firebaseAuth, email, password);
                closeAuthModalButton.click();
            } catch (error) {
                loginErrorEl.textContent = "गलत ईमेल या पासवर्ड।";
                loginErrorEl.classList.remove('hidden');
            } finally {
                loadingOverlay.style.display = 'none';
            }
        });
        
        sidebarLogoutLink.addEventListener('click', async (e) => {
            e.preventDefault();
            if (!window.firebaseAuth || !window.firebaseSDKLoaded) return;
            const { signOut } = window.firebaseSDKLoaded;
            try { await signOut(window.firebaseAuth); } 
            catch (error) { console.error("Firebase logout error:", error); }
            if (sidebar.classList.contains('open')) toggleSidebar();
        });

        sidebarProfileLink.addEventListener('click', (e) => { e.preventDefault(); openAuthModal(); });
        headerUserIcon.addEventListener('click', openAuthModal);
        footerProfileButton.addEventListener('click', openAuthModal);

        sidebarTopScorerLink.addEventListener('click', async (e) => {
            e.preventDefault();
            topScorerModal.classList.add('active');
            document.body.style.overflow = 'hidden';
            topScorerListEl.innerHTML = '<p class="text-center text-gray-500">Loading...</p>';
            const scorers = await loadTopScorersFromFirestore();
            topScorerListEl.innerHTML = ''; 
            if (scorers && scorers.length > 0) {
                scorers.forEach((scorer, index) => {
                    const scorerDiv = document.createElement('div');
                    scorerDiv.className = 'flex items-center justify-between p-3 bg-white rounded-lg shadow-sm border border-gray-200';
                    let medal = index === 0 ? '🥇 1.' : index === 1 ? '🥈 2.' : index === 2 ? '🥉 3.' : `${index + 1}.`;
                    scorerDiv.innerHTML = `
                        <div class="flex items-center">
                            <span class="text-lg font-semibold mr-3 ${index < 3 ? (index === 0 ? 'text-yellow-500' : index === 1 ? 'text-gray-400' : 'text-orange-400') : 'text-gray-700'}">${medal}</span>
                            <img src="https://placehold.co/40x40/${Math.random().toString(16).substr(-6)}/${Math.random().toString(16).substr(-6)}?text=${scorer.displayName ? scorer.displayName.charAt(0).toUpperCase() : 'U'}" alt="User" class="w-10 h-10 rounded-full mr-3">
                            <span class="font-medium text-gray-800">${scorer.displayName || 'Anonymous'}</span>
                        </div>
                        <span class="font-semibold text-blue-600">${scorer.coins || 0} 🪙</span>`;
                    topScorerListEl.appendChild(scorerDiv);
                });
            } else {
                topScorerListEl.innerHTML = '<p class="text-center text-gray-500">No scorers data found.</p>';
            }
        });
        closeTopScorerModalButton.addEventListener('click', () => {
            topScorerModal.classList.remove('active');
            document.body.style.overflow = 'auto';
        });

        function updatePremiumTestUI() {
            // This section is now free, so we just enable everything.
            premiumPlumberHindiSubCardsContainer.classList.remove('hidden');
            premiumPlumberHindiSubCardsContainer.querySelectorAll('.premium-sub-card').forEach(card => {
                card.classList.remove('disabled');
                card.onclick = () => openContentModalGeneric(card.dataset.subtest, true, false); 
            });
        }
        
        async function updateUserCoins(amount) {
            if (!currentUserData.isLoggedIn || !currentUserData.isFirebaseUser || !currentUserData.userId) return;
            const newCoins = (currentUserData.coins || 0) + amount;
            const saveResult = await saveUserDataToFirestore(currentUserData.userId, { coins: newCoins });
            if (saveResult.success) currentUserData.coins = newCoins;
            updateUIAfterAuthChange(); 
        }

        const sidebar = document.getElementById('sidebar');
        const sidebarOverlay = document.getElementById('sidebarOverlay');
        const hamburgerButton = document.getElementById('hamburgerButton');
        function toggleSidebar() {
            sidebar.classList.toggle('open');
            sidebarOverlay.classList.toggle('hidden');
            document.body.style.overflow = sidebar.classList.contains('open') ? 'hidden' : 'auto';
        }
        hamburgerButton.addEventListener('click', toggleSidebar);
        sidebarOverlay.addEventListener('click', toggleSidebar);

        let importantQuestions = [
            { q: "भारत में प्लंबिंग के लिए आमतौर पर किस प्रकार के पाइप का उपयोग किया जाता है?", a: "आमतौर पर पीवीसी (PVC), सीपीवीसी (CPVC), यूपीवीसी (UPVC), जीआई (GI - Galvanized Iron), और तांबे (Copper) के पाइप का उपयोग किया जाता है।" },
            { q: "पानी के रिसाव को रोकने के लिए सबसे अच्छा तरीका क्या है?", a: "नियमित रूप से पाइप और फिटिंग की जांच करें, उच्च गुणवत्ता वाली सामग्री का उपयोग करें, और सही स्थापना सुनिश्चित करें।" }
        ];
        let lastDisplayedImpQIndex = -1;

        function displayRandomImportantQuestion() {
            if (importantQuestions.length === 0) return;
            let randomIndex;
            do { randomIndex = Math.floor(Math.random() * importantQuestions.length); } while (importantQuestions.length > 1 && randomIndex === lastDisplayedImpQIndex);
            lastDisplayedImpQIndex = randomIndex;
            const item = importantQuestions[randomIndex];
            importantQuestionTextEl.textContent = `प्रश्न: ${item.q}`;
            importantAnswerTextEl.textContent = `उत्तर: ${item.a}`;
            importantQuestionDisplayArea.style.display = 'block';
        }
        showRandomImpQuestionBtn.addEventListener('click', displayRandomImportantQuestion);

        const triggerQuizButton = document.getElementById('triggerQuizButton');
        const quizModalEl = document.getElementById('quizModal'); 
        const quizSetupScreen = document.getElementById('quizSetupScreen');
        const quizInterfaceScreen = document.getElementById('quizInterfaceScreen');
        const quizResultsScreen = document.getElementById('quizResultsScreen');
        const numQuestionsButtons = document.querySelectorAll('.num-questions-btn');
        const startSelectedQuizButton = document.getElementById('startSelectedQuizButton');
        const closeQuizSetupButton = document.getElementById('closeQuizSetupButton');
        const currentQuestionNumberEl = document.getElementById('currentQuestionNumber');
        const totalQuizQuestionsEl = document.getElementById('totalQuizQuestions');
        const quizTimerEl = document.getElementById('quizTimer');
        const questionTimerBar = document.getElementById('questionTimerBar');
        const questionImageContainer = document.getElementById('questionImageContainer');
        const questionImageEl = document.getElementById('questionImage');
        const questionTextQuizEl = document.getElementById('questionTextQuiz'); 
        const optionsContainer = document.getElementById('optionsContainer');
        const lifeline5050Button = document.getElementById('lifeline5050');
        const lifelineAudiencePollButton = document.getElementById('lifelineAudiencePoll');
        const audiencePollResultsEl = document.getElementById('audiencePollResults');
        const nextQuestionButton = document.getElementById('nextQuestionButton');
        const closeQuizInterfaceButton = document.getElementById('closeQuizInterfaceButton');
        const finalScoreEl = document.getElementById('finalScore');
        const correctAnswersCountEl = document.getElementById('correctAnswersCount');
        const playAgainButton = document.getElementById('playAgainButton');
        const closeQuizResultsButton = document.getElementById('closeQuizResultsButton');
        const coinsEarnedInQuizEl = document.getElementById('coinsEarnedInQuiz');
        const favoriteQuestionButton = document.getElementById('favoriteQuestionButton');

        let allPlumbingQuestions = [
            { id: "pq1", text: "चित्र में दिखाए गए उपकरण का नाम क्या है? (What is the name of the tool shown in the picture?)", image: "https://placehold.co/300x200/E0F2FE/3B82F6?text=Pipe+Wrench", options: [{ text: "पाइप रिंच (Pipe Wrench)", correct: true },{ text: "समायोज्य रिंच (Adjustable Wrench)", correct: false },{ text: "सॉकेट रिंच (Socket Wrench)", correct: false },{ text: "टॉर्क रिंच (Torque Wrench)", correct: false }]},
            { id: "pq2", text: "पानी के रिसाव को रोकने के लिए पाइप थ्रेड्स पर आमतौर पर किस सामग्री का उपयोग किया जाता है? (What material is commonly used on pipe threads to prevent water leaks?)", image: null, options: [{ text: "टेफ्लॉन टेप (Teflon Tape)", correct: true },{ text: "डक्ट टेप (Duct Tape)", correct: false },{ text: "रबर सीमेंट (Rubber Cement)", correct: false },{ text: "सिलिकॉन सीलेंट (Silicone Sealant)", correct: false }]}
        ];
        let currentQuizQuestions = [];
        let currentQuestionIndex = 0;
        let score = 0;
        let correctAnswers = 0;
        let coinsThisQuiz = 0; 
        let timeLeft = 60; 
        let timerInterval;
        let selectedNumOfQuestions = 0;
        let lifelines = { fiftyFiftyUsed: false, audiencePollUsed: false };

        triggerQuizButton.addEventListener('click', () => {
            if (!currentUserData.isLoggedIn || !currentUserData.isFirebaseUser) { openAuthModal(); return; }
            quizModalEl.classList.add('active');
            document.body.style.overflow = 'hidden';
            showQuizScreen('setup');
        });

        function closeQuizModal() {
            quizModalEl.classList.remove('active');
            document.body.style.overflow = 'auto';
            if (timerInterval) clearInterval(timerInterval);
        }
        closeQuizSetupButton.addEventListener('click', closeQuizModal);
        closeQuizInterfaceButton.addEventListener('click', closeQuizModal);
        closeQuizResultsButton.addEventListener('click', closeQuizModal);

        numQuestionsButtons.forEach(button => {
            button.addEventListener('click', () => {
                selectedNumOfQuestions = parseInt(button.dataset.count);
                numQuestionsButtons.forEach(btn => btn.classList.remove('bg-green-500', 'text-white'));
                button.classList.add('bg-green-500', 'text-white');
                startSelectedQuizButton.disabled = false;
                startSelectedQuizButton.classList.remove('disabled:opacity-50');
            });
        });

        startSelectedQuizButton.addEventListener('click', () => {
            if (selectedNumOfQuestions > 0) {
                initializeQuiz();
                showQuizScreen('interface');
            }
        });
        
        function shuffleArray(array) { for (let i = array.length - 1; i > 0; i--) { const j = Math.floor(Math.random() * (i + 1)); [array[i], array[j]] = [array[j], array[i]]; } }

        function initializeQuiz() {
            currentQuizQuestions = [...allPlumbingQuestions];
            shuffleArray(currentQuizQuestions);
            currentQuizQuestions = currentQuizQuestions.slice(0, selectedNumOfQuestions);
            currentQuestionIndex = 0; score = 0; correctAnswers = 0; coinsThisQuiz = 0;
            lifelines = { fiftyFiftyUsed: false, audiencePollUsed: false };
            updateLifelineButtons();
        }

        function showQuizScreen(screenName) {
            quizSetupScreen.classList.add('hidden');
            quizInterfaceScreen.classList.add('hidden');
            quizResultsScreen.classList.add('hidden');

            if (screenName === 'setup') {
                quizSetupScreen.classList.remove('hidden');
                startSelectedQuizButton.disabled = true;
                startSelectedQuizButton.classList.add('disabled:opacity-50');
                numQuestionsButtons.forEach(btn => btn.classList.remove('bg-green-500', 'text-white'));
            } else if (screenName === 'interface') {
                quizInterfaceScreen.classList.remove('hidden');
                loadQuestion();
            } else if (screenName === 'results') {
                quizResultsScreen.classList.remove('hidden');
                finalScoreEl.textContent = `${score} / ${currentQuizQuestions.length * 10}`;
                correctAnswersCountEl.textContent = `${correctAnswers} / ${currentQuizQuestions.length}`;
                coinsThisQuiz = correctAnswers * 5; 
                coinsEarnedInQuizEl.textContent = coinsThisQuiz;
                updateUserCoins(coinsThisQuiz);
            }
        }
        
        function loadQuestion() {
            if (currentQuestionIndex >= currentQuizQuestions.length) {
                showQuizScreen('results');
                return;
            }
            const question = currentQuizQuestions[currentQuestionIndex];
            currentQuestionNumberEl.textContent = currentQuestionIndex + 1;
            totalQuizQuestionsEl.textContent = currentQuizQuestions.length;
            questionTextQuizEl.textContent = question.text;
            questionImageContainer.classList.toggle('hidden', !question.image);
            if(question.image) questionImageEl.src = question.image;

            optionsContainer.innerHTML = '';
            const shuffledOptions = [...question.options];
            shuffleArray(shuffledOptions); 

            shuffledOptions.forEach(option => {
                const button = document.createElement('button');
                button.className = 'quiz-option block w-full text-left p-3 border-2 border-gray-300 rounded-lg hover:bg-blue-100 transition';
                button.textContent = option.text;
                button.onclick = () => handleAnswer(option.correct, button, Array.from(optionsContainer.children), option.text);
                optionsContainer.appendChild(button);
            });
            
            updateFavoriteQuestionButton(question.id);
            nextQuestionButton.classList.add('hidden');
            geminiQuizExplanationArea.style.display = 'none';
            geminiQuizExplanationArea.innerHTML = '';
            resetTimer();
            startTimer();
            audiencePollResultsEl.classList.add('hidden');
            optionsContainer.querySelectorAll('.quiz-option').forEach(opt => opt.classList.remove('disabled'));
        }

        function handleAnswer(isCorrect, selectedButton, allDisplayedOptions, selectedOptionText) {
            if (timerInterval) clearInterval(timerInterval);
            allDisplayedOptions.forEach(opt => {
                opt.classList.add('disabled'); 
                const originalOption = currentQuizQuestions[currentQuestionIndex].options.find(o => o.text === opt.textContent);
                if (originalOption?.correct) opt.classList.add('correct');
                else if (opt === selectedButton) opt.classList.add('incorrect'); 
            });

            if (isCorrect) { score += 10; correctAnswers++; }
            
            const currentQuestion = currentQuizQuestions[currentQuestionIndex];
            getQuizExplanationFromGemini(currentQuestion, selectedOptionText, isCorrect);
            nextQuestionButton.classList.remove('hidden');
        }

        async function getQuizExplanationFromGemini(question, selectedOptionText, isCorrect) {
            geminiQuizExplanationLoader.classList.add('active');
            geminiQuizExplanationArea.style.display = 'none';
            geminiQuizExplanationArea.innerHTML = '';
            const correctAnswerText = question.options.find(opt => opt.correct).text;
            let prompt = isCorrect ? 
                `The question is: "${question.text}". The user correctly chose: "${selectedOptionText}". Please explain why this answer is correct in simple Hindi.` : 
                `The question is: "${question.text}". The user incorrectly chose: "${selectedOptionText}". The correct answer is: "${correctAnswerText}". Explain why the user's answer was wrong and the correct one is right, in simple Hindi.`;
            await callGeminiAPI(prompt, geminiQuizExplanationLoader, geminiQuizExplanationArea, true);
        }

        nextQuestionButton.addEventListener('click', () => { currentQuestionIndex++; loadQuestion(); });

        function startTimer() {
            timeLeft = 60;
            quizTimerEl.textContent = `01:00`;
            questionTimerBar.style.width = '100%';
            questionTimerBar.style.backgroundColor = '#3B82F6'; 
            timerInterval = setInterval(() => {
                timeLeft--;
                quizTimerEl.textContent = `00:${timeLeft.toString().padStart(2, '0')}`;
                questionTimerBar.style.width = `${(timeLeft / 60) * 100}%`;
                if (timeLeft <= 10) questionTimerBar.style.backgroundColor = timeLeft > 5 ? '#F59E0B' : '#EF4444'; 
                if (timeLeft <= 0) {
                    clearInterval(timerInterval);
                    handleAnswer(false, null, Array.from(optionsContainer.children), "Time out");
                }
            }, 1000);
        }
        function resetTimer() { if (timerInterval) clearInterval(timerInterval); }

        lifeline5050Button.addEventListener('click', () => {
            if (lifelines.fiftyFiftyUsed || !optionsContainer.children.length) return;
            const question = currentQuizQuestions[currentQuestionIndex];
            let incorrectOptions = Array.from(optionsContainer.children).filter(btn => !question.options.find(o => o.text === btn.textContent && o.correct));
            shuffleArray(incorrectOptions);
            for (let i = 0; i < 2 && incorrectOptions[i]; i++) incorrectOptions[i].classList.add('hidden');
            lifelines.fiftyFiftyUsed = true;
            updateLifelineButtons();
        });

        lifelineAudiencePollButton.addEventListener('click', () => {
            if (lifelines.audiencePollUsed || !optionsContainer.children.length) return;
            audiencePollResultsEl.innerHTML = '';
            const question = currentQuizQuestions[currentQuestionIndex];
            const options = Array.from(optionsContainer.children).filter(opt => !opt.classList.contains('hidden')); 
            let votes = options.map(opt => ({ text: opt.textContent, percent: Math.floor(Math.random() * 30) + (question.options.find(o => o.text === opt.textContent)?.correct ? 40 : 5) }));
            let totalVotes = votes.reduce((sum, v) => sum + v.percent, 0);
            votes.forEach(vote => {
                const barDiv = document.createElement('div');
                barDiv.className = 'flex items-center justify-between text-sm';
                const normalizedPercent = totalVotes > 0 ? Math.round((vote.percent / totalVotes) * 100) : 0;
                barDiv.innerHTML = `<span>${vote.text}</span><div class="w-3/5 bg-gray-200 rounded-full h-4"><div class="audience-poll-bar h-4 rounded-full text-xs text-white text-center" style="width: ${normalizedPercent}%">${normalizedPercent}%</div></div>`;
                audiencePollResultsEl.appendChild(barDiv);
            });
            audiencePollResultsEl.classList.remove('hidden');
            lifelines.audiencePollUsed = true;
            updateLifelineButtons();
        });

        function updateLifelineButtons() {
            lifeline5050Button.disabled = lifelines.fiftyFiftyUsed;
            lifelineAudiencePollButton.disabled = lifelines.audiencePollUsed;
            lifeline5050Button.classList.toggle('disabled', lifelines.fiftyFiftyUsed);
            lifelineAudiencePollButton.classList.toggle('disabled', lifelines.audiencePollUsed);
        }
        playAgainButton.addEventListener('click', () => { showQuizScreen('setup'); });

        async function toggleFavoriteQuestion(question) {
            const questionId = question.id;
            let currentFavorites = Array.isArray(currentUserData.favoriteQuestions) ? currentUserData.favoriteQuestions : [];
            const isFavorited = currentFavorites.some(fav => fav.id === questionId);
            currentUserData.favoriteQuestions = isFavorited ? currentFavorites.filter(fav => fav.id !== questionId) : [...currentFavorites, { id: question.id, text: question.text, image: question.image }];
            updateFavoriteQuestionButton(questionId);
            if (currentUserData.userId) await saveUserDataToFirestore(currentUserData.userId, { favoriteQuestions: currentUserData.favoriteQuestions });
        }
        favoriteQuestionButton.addEventListener('click', () => {
            if (!currentUserData.isLoggedIn || !currentUserData.isFirebaseUser || !currentQuizQuestions[currentQuestionIndex]) return;
            toggleFavoriteQuestion(currentQuizQuestions[currentQuestionIndex]);
        });
        
        function updateFavoriteQuestionButton(questionId) {
            if (!currentUserData.isLoggedIn || !currentUserData.isFirebaseUser) { favoriteQuestionButton.innerHTML = '<i class="far fa-star"></i>'; favoriteQuestionButton.classList.remove('favorited'); return; }
            const isFavorited = (currentUserData.favoriteQuestions || []).some(fav => fav.id === questionId);
            favoriteQuestionButton.innerHTML = isFavorited ? '<i class="fas fa-star"></i>' : '<i class="far fa-star"></i>';
            favoriteQuestionButton.classList.toggle('favorited', isFavorited);
        }
        
        function updateFavoriteQuestionIcons() { if (quizInterfaceScreen.style.display !== 'hidden' && currentQuizQuestions.length > 0) updateFavoriteQuestionButton(currentQuizQuestions[currentQuestionIndex].id); }

        sidebarFavoriteQuestionLink.addEventListener('click', (e) => {
            e.preventDefault();
            if (!currentUserData.isLoggedIn || !currentUserData.isFirebaseUser) { openAuthModal(); return; }
            favoriteQuestionsListEl.innerHTML = ''; 
            const favorites = currentUserData.favoriteQuestions || [];
            if (favorites.length === 0) { favoriteQuestionsListEl.innerHTML = '<p class="text-center text-gray-500">No favorite questions saved.</p>'; } 
            else {
                favorites.forEach(fav => {
                    const div = document.createElement('div');
                    div.className = 'p-3 border rounded-md bg-blue-50 shadow-sm';
                    div.innerHTML = `<h4 class="font-semibold text-blue-700">${fav.text}</h4><button data-id="${fav.id}" class="remove-favorite-btn mt-2 text-xs text-red-500 hover:text-red-700">Remove</button>`;
                    favoriteQuestionsListEl.appendChild(div);
                });
                document.querySelectorAll('.remove-favorite-btn').forEach(btn => btn.addEventListener('click', async function() {
                    currentUserData.favoriteQuestions = (currentUserData.favoriteQuestions || []).filter(q => q.id !== this.dataset.id);
                    if (currentUserData.userId) await saveUserDataToFirestore(currentUserData.userId, { favoriteQuestions: currentUserData.favoriteQuestions });
                    sidebarFavoriteQuestionLink.click();
                    updateFavoriteQuestionIcons(); 
                }));
            }
            favoriteQuestionsModal.classList.add('active');
            document.body.style.overflow = 'hidden';
        });
        closeFavoriteQuestionsModalButton.addEventListener('click', () => { favoriteQuestionsModal.classList.remove('active'); document.body.style.overflow = 'auto'; });

        sidebarRaiseComplaintLink.addEventListener('click', (e) => { e.preventDefault(); complaintModal.classList.add('active'); document.body.style.overflow = 'hidden'; });
        closeComplaintModalButton.addEventListener('click', () => { complaintModal.classList.remove('active'); document.body.style.overflow = 'auto'; });
        complaintForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const complaintText = document.getElementById('complaintText').value.trim();
            if (!complaintText) return;
            const subject = "Mock Test App Complaint/Feedback";
            const body = `User: ${currentUserData.email || currentUserData.userId || 'N/A'}\n\nComplaint:\n${complaintText}`;
            window.location.href = `mailto:kidsfation@gmail.com?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
            complaintForm.reset();
            closeComplaintModalButton.click();
        });

        function setupShareButtons() {
            const appUrl = window.location.href;
            const shareMessage = `Check out this Mock Test App for ITI Plumbers: ${appUrl}`;
            const shareAction = async (shareData) => {
                if (navigator.share) {
                    try { await navigator.share(shareData); } catch (err) { openShareModal(shareData.text || shareData.url); }
                } else { openShareModal(shareData.text || shareData.url); }
            };
            sidebarInviteFriendsLink.addEventListener('click', (e) => { e.preventDefault(); shareAction({ title: 'ITI Mock Test App', text: shareMessage, url: appUrl }); });
            whatsappShareHeaderBtn.href = `https://api.whatsapp.com/send?text=${encodeURIComponent(shareMessage)}`;
            document.getElementById('shareContentButton').addEventListener('click', () => {
                const title = document.getElementById('contentModalTitle').textContent;
                shareAction({ title, text: `Check out: "${title}" on ITI Mock Test App: ${appUrl}`, url: appUrl });
            });
        }

        function openShareModal(textToShare) {
            shareModalTextEl.textContent = textToShare;
            shareModal.classList.add('active');
        }
        copyShareTextButton.addEventListener('click', () => navigator.clipboard.writeText(shareModalTextEl.textContent).then(() => alert("Text copied!")));
        closeShareModalButton.addEventListener('click', () => shareModal.classList.remove('active'));

        const contentModalEl = document.getElementById('contentModal');
        const contentModalTitle = document.getElementById('contentModalTitle');
        const contentModalImageContainer = document.getElementById('contentModalImageContainer');
        const contentModImage = document.getElementById('contentModalImage');
        const contentModalBody = document.getElementById('contentModalBody');
        const closeContentModalButton = document.getElementById('closeContentModalButton');
        
        const freeContentData = {
            "basic_concepts_en": { title: "Basic Plumbing Concepts", content: "<p>Water supply systems, drainage systems, types of pipes, common fittings.</p>" },
            "safety_symbols_en": { title: "Safety Symbols", content: "<p>Common safety signs: Danger, Warning, Caution.</p>" },
            "measurement_tools_en": { title: "Measurement Tools", content: "<p>Measuring tapes, rulers, calipers, levels.</p>" },
            "practice_drills_en": { title: "Practice Drills", content: "<p>Simple exercises: Identify fittings, match tools to tasks.</p>" },
            "instructions_sidebar": { title: "Instructions (निर्देश)", content: "<h3>Welcome!</h3><p>Use this app to prepare for your ITI Plumber exams. Practice quizzes, learn concepts, and use the admin panel to manage content.</p>" }
        };
        const premiumContentData = { // Now free
            "handwritten_notes_hi": { title: "हस्तलिखित नोट्स (PDF)", content: "<p>विस्तृत हस्तलिखित नोट्स। (सामग्री जल्द ही आ रही है)</p>" },
            "theory_hi": { title: "थ्योरी", content: "<p>प्लंबिंग के महत्वपूर्ण सिद्धांत। (सामग्री जल्द ही आ रही है)</p>" },
            "mock_test_hi": { title: "मॉक टेस्ट (PDF)", content: "<p>परीक्षा पैटर्न पर आधारित मॉक टेस्ट। (सामग्री जल्द ही आ रही है)</p>" },
            "test_preparation_hi": { title: "टेस्ट तैयारी (1000 MCQ)", content: "<p>1000+ महत्वपूर्ण बहुविकल्पीय प्रश्न। (सामग्री जल्द ही आ रही है)</p>" },
            "file_making_hi": { title: "फाइल मेकिंग (Images)", content: "<p>आईटीआई प्रैक्टिकल फाइल बनाने के लिए मार्गदर्शन। (सामग्री जल्द ही आ रही है)</p>" },
            "tools_detail_hi": { title: "उपकरण विवरण (AI)", content: "<p>विभिन्न प्लंबिंग उपकरणों का विस्तृत विवरण।</p>" }
        };

        
const allToolsData = {
    "hand_tools": { 
        name: "Hand Tools (हस्त उपकरण)", 
        icon: "fas fa-tools", 
        subcategories: { 
            "wrenches": { 
                name: "Wrenches", 
                items: [ 
                    { name: "Pipe Wrench", desc: "For pipes." },
                    { name: "Adjustable Wrench", desc: "Adjustable jaw for various sizes." },
                    { name: "Torque Wrench", desc: "Applies specific torque." },
                    { name: "Combination Wrench", desc: "Open and box-end." },
                    { name: "Ratchet Wrench", desc: "For quick fastening." }
                ] 
            },
            "screwdrivers": { 
                name: "Screwdrivers", 
                items: [ 
                    { name: "Phillips Screwdriver", desc: "For cross-head screws." },
                    { name: "Flathead Screwdriver", desc: "For slotted screws." },
                    { name: "Torx Screwdriver", desc: "For star-shaped screws." },
                    { name: "Precision Screwdriver", desc: "For small screws." }
                ] 
            },
            "hammers": { 
                name: "Hammers", 
                items: [ 
                    { name: "Claw Hammer", desc: "For nails and prying." },
                    { name: "Sledge Hammer", desc: "For heavy demolition." },
                    { name: "Ball Peen Hammer", desc: "For metalworking." },
                    { name: "Rubber Mallet", desc: "For soft strikes." }
                ] 
            },
            "pliers": { 
                name: "Pliers", 
                items: [ 
                    { name: "Needle Nose Pliers", desc: "For precision work." },
                    { name: "Slip Joint Pliers", desc: "Adjustable for gripping." },
                    { name: "Locking Pliers", desc: "For secure holding." },
                    { name: "Cutting Pliers", desc: "For cutting wires." }
                ] 
            },
            "saws": { 
                name: "Saws", 
                items: [ 
                    { name: "Hand Saw", desc: "For cutting wood." },
                    { name: "Hacksaw", desc: "For cutting metal." },
                    { name: "Coping Saw", desc: "For intricate cuts." },
                    { name: "Bow Saw", desc: "For rough cutting." }
                ] 
            }
        } 
    },
    "power_tools": { 
        name: "Power Tools (शक्ति उपकरण)", 
        icon: "fas fa-bolt", 
        subcategories: { 
            "drills": { 
                name: "Drills", 
                items: [ 
                    { name: "Cordless Drill", desc: "For holes." },
                    { name: "Hammer Drill", desc: "For masonry drilling." },
                    { name: "Impact Drill", desc: "For high-torque drilling." },
                    { name: "Drill Press", desc: "For precise drilling." }
                ] 
            },
            "saws": { 
                name: "Saws", 
                items: [ 
                    { name: "Circular Saw", desc: "For straight cuts." },
                    { name: "Jigsaw", desc: "For curved cuts." },
                    { name: "Reciprocating Saw", desc: "For demolition." },
                    { name: "Miter Saw", desc: "For angled cuts." }
                ] 
            },
            "grinders": { 
                name: "Grinders", 
                items: [ 
                    { name: "Angle Grinder", desc: "For grinding and cutting." },
                    { name: "Bench Grinder", desc: "For sharpening tools." },
                    { name: "Die Grinder", desc: "For precision grinding." },
                    { name: "Belt Grinder", desc: "For surface finishing." }
                ] 
            },
            "sanders": { 
                name: "Sanders", 
                items: [ 
                    { name: "Orbital Sander", desc: "For smooth sanding." },
                    { name: "Belt Sander", desc: "For heavy sanding." },
                    { name: "Detail Sander", desc: "For tight spaces." },
                    { name: "Disc Sander", desc: "For large surfaces." }
                ] 
            }
        } 
    },
    "safety_equipment": { 
        name: "Safety Equipment (सुरक्षा उपकरण)", 
        icon: "fas fa-hard-hat", 
        subcategories: { 
            "ppe": { 
                name: "PPE", 
                items: [ 
                    { name: "Safety Glasses", desc: "Protect eyes." },
                    { name: "Hard Hat", desc: "Protects head." },
                    { name: "Work Gloves", desc: "Protects hands." },
                    { name: "Ear Plugs", desc: "Protects hearing." },
                    { name: "Safety Vest", desc: "High visibility." }
                ] 
            },
            "respiratory": { 
                name: "Respiratory Protection", 
                items: [ 
                    { name: "Dust Mask", desc: "For dust protection." },
                    { name: "Respirator", desc: "For chemical fumes." },
                    { name: "Full-Face Respirator", desc: "For complete protection." }
                ] 
            },
            "fall_protection": { 
                name: "Fall Protection", 
                items: [ 
                    { name: "Safety Harness", desc: "For working at heights." },
                    { name: "Lanyard", desc: "Connects harness to anchor." },
                    { name: "Anchor Point", desc: "Secures lanyard." }
                ] 
            }
        } 
    },
    "measuring_tools": { 
        name: "Measuring Tools (माप उपकरण)", 
        icon: "fas fa-ruler", 
        subcategories: { 
            "tapes": { 
                name: "Tapes and Rulers", 
                items: [ 
                    { name: "Measuring Tape", desc: "For length measurement." },
                    { name: "Steel Ruler", desc: "For precise straight lines." },
                    { name: "Folding Ruler", desc: "For portable measurement." }
                ] 
            },
            "levels": { 
                name: "Levels", 
                items: [ 
                    { name: "Spirit Level", desc: "For checking alignment." },
                    { name: "Laser Level", desc: "For precise leveling." }
                ] 
            }
        } 
    }
};          
     
                const catDiv = document.createElement('div');
                catDiv.className = 'mb-3 border border-gray-200 rounded-lg shadow-sm';
                const header = document.createElement('div');
                header.className = 'tool-category-header bg-gray-100 p-3 flex justify-between items-center rounded-t-lg';
                header.innerHTML = `<h4 class="font-semibold text-gray-700 flex items-center"><i class="${cat.icon} mr-2 text-blue-500"></i> ${cat.name}</h4><i class="fas fa-chevron-down transform"></i>`;
                const listContainer = document.createElement('div');
                listContainer.className = 'tool-list-container bg-white p-3 rounded-b-lg';
                for (const subCatKey in cat.subcategories) {
                    const subCat = cat.subcategories[subCatKey];
                    const subCatHeader = document.createElement('div');
                    subCatHeader.className = 'tool-subcategory-header p-2 my-1 bg-blue-50 rounded flex justify-between items-center';
                    subCatHeader.innerHTML = `<h5 class="font-medium text-blue-700">${subCat.name}</h5><i class="fas fa-plus transform text-sm"></i>`;
                    const subCatItemsContainer = document.createElement('div');
                    subCatItemsContainer.className = 'tool-subcategory-container pl-2 border-l-2 ml-1';
                    subCat.items.forEach(item => {
                        const itemDiv = document.createElement('div');
                        itemDiv.className = 'tool-item p-2 hover:bg-blue-50 rounded cursor-pointer';
                        itemDiv.textContent = item.name;
                        itemDiv.onclick = () => openContentModalGeneric(item.name, false, true, item);
                        subCatItemsContainer.appendChild(itemDiv);
                    });
                    subCatHeader.onclick = (e) => { e.stopPropagation(); subCatItemsContainer.classList.toggle('open'); subCatHeader.querySelector('i').classList.toggle('fa-plus'); subCatHeader.querySelector('i').classList.toggle('fa-minus'); };
                    listContainer.appendChild(subCatHeader); listContainer.appendChild(subCatItemsContainer);
                }
                header.onclick = () => { listContainer.classList.toggle('open'); header.querySelector('i.fas').classList.toggle('fa-chevron-down'); header.querySelector('i.fas').classList.toggle('fa-chevron-up'); };
                catDiv.appendChild(header); catDiv.appendChild(listContainer); allToolsContainer.appendChild(catDiv);
            }
        }
        
        function openContentModalGeneric(key, isPremium, isTool, toolData, isInstruction) {
            let data;
            currentToolForGemini = null; 
            geminiToolInfoArea.style.display = 'none'; 
            geminiToolInfoArea.innerHTML = '';
            getAdvancedToolInfoButton.classList.add('hidden');
            if (isTool) { data = { title: toolData.name, content: `<p>${toolData.desc}</p>` }; currentToolForGemini = toolData; getAdvancedToolInfoButton.classList.remove('hidden'); }
            else { data = isPremium ? premiumContentData[key] : (isInstruction ? freeContentData['instructions_sidebar'] : freeContentData[key]); }
            if (!data) return;

            contentModalTitle.textContent = data.title;
            contentModalBody.innerHTML = data.content; 
            contentModalImageContainer.classList.toggle('hidden', !data.image);
            if(data.image) contentModalImage.src = data.image;
            contentModalEl.classList.add('active');
            document.body.style.overflow = 'hidden';
        }
        
        document.querySelectorAll('#freePlumberEnglishSubCardsContainer .free-sub-card').forEach(c => c.addEventListener('click', () => openContentModalGeneric(c.dataset.subtest)));
        sidebarInstructionLink.addEventListener('click', (e) => { e.preventDefault(); openContentModalGeneric(null, false, false, null, true); if(sidebar.classList.contains('open')) toggleSidebar(); });
        closeContentModalButton.addEventListener('click', () => { contentModalEl.classList.remove('active'); document.body.style.overflow = 'auto'; });

        // --- Gemini API Integration ---
        async function callGeminiAPI(promptText, loaderElement, answerElement) {
            if (!promptText) return;
            loaderElement.classList.add('active');
            answerElement.style.display = 'none';
            try {
                const response = await fetch(GEMINI_API_URL_TEXT, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ contents: [{ role: "user", parts: [{ text: promptText }] }] }) });
                if (!response.ok) throw new Error(`API request failed: ${response.statusText}`);
                const result = await response.json();
                if (result.candidates?.[0]?.content?.parts?.[0]?.text) {
                    answerElement.innerHTML = result.candidates[0].content.parts[0].text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>').replace(/\n/g, '<br>');
                } else { answerElement.textContent = "Sorry, couldn't get a response."; }
            } catch (error) { console.error('Error calling Gemini API:', error); answerElement.textContent = `Error: ${error.message}.`; } 
            finally { loaderElement.classList.remove('active'); answerElement.style.display = 'block'; }
        }

        askGeminiButton.addEventListener('click', () => {
            const prompt = `You are a helpful assistant for ITI Plumber students. Answer the following in simple Hindi or English: "${userGeminiQuestionInput.value.trim()}"`;
            callGeminiAPI(prompt, geminiQALoader, geminiAnswerArea);
        });
        
        getAdvancedToolInfoButton.addEventListener('click', () => {
            if (currentToolForGemini) {
                const prompt = `Provide advanced details for the plumbing tool: "${currentToolForGemini.name}". Include common problems, safety precautions, and usage tips, in simple Hindi or English.`;
                callGeminiAPI(prompt, geminiToolInfoLoader, geminiToolInfoArea);
            }
        });

        // --- Admin Panel Logic ---
        sidebarAdminPanelLink.addEventListener('click', (e) => {
            e.preventDefault();
            adminLoginModal.classList.add('active');
            if (sidebar.classList.contains('open')) toggleSidebar();
        });
        
        closeAdminLoginModalButton.addEventListener('click', () => adminLoginModal.classList.remove('active'));

        adminLoginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const id = adminLoginForm.adminId.value;
            const pass = adminLoginForm.adminPassword.value;
            adminLoginError.classList.add('hidden');
            if (id === 'admin' && pass === 'admin123') {
                adminLoginModal.classList.remove('active');
                adminPanelModal.classList.add('active');
                adminUserListEl.innerHTML = `<tr><td colspan="3" class="text-center">Loading users...</td></tr>`;
                const users = await loadAllUsersFromFirestore();
                adminUserListEl.innerHTML = '';
                users.forEach(user => {
                    const row = document.createElement('tr');
                    row.innerHTML = `<td>${user.displayName || 'N/A'}</td><td>${user.email || 'N/A'}</td><td>${user.coins || 0}</td>`;
                    adminUserListEl.appendChild(row);
                });
            } else {
                adminLoginError.textContent = "Invalid Admin ID or Password.";
                adminLoginError.classList.remove('hidden');
            }
        });
        
        closeAdminPanelModalButton.addEventListener('click', () => adminPanelModal.classList.remove('active'));

        openAddQuestionModalBtn.addEventListener('click', () => {
            addQuestionModal.classList.add('active');
            addQuestionForm.reset();
            questionSectionSelect.dispatchEvent(new Event('change')); // Trigger change to set initial view
        });

        closeAddQuestionModalButton.addEventListener('click', () => addQuestionModal.classList.remove('active'));

        questionSectionSelect.addEventListener('change', (e) => {
            const isQuiz = e.target.value === 'quiz';
            quizOptionsContainer.classList.toggle('hidden', !isQuiz);
            answerTextInputContainer.classList.toggle('hidden', isQuiz);
            document.getElementById('questionText').required = true;
            document.getElementById('answerText').required = !isQuiz;
            ['option1', 'option2', 'option3', 'option4', 'correctAnswer'].forEach(id => document.getElementById(id).required = isQuiz);
        });

        addQuestionForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const section = addQuestionForm.questionSection.value;
            const qText = addQuestionForm.questionText.value;

            if (section === 'quiz') {
                const options = [
                    { text: addQuestionForm.option1.value, correct: false },
                    { text: addQuestionForm.option2.value, correct: false },
                    { text: addQuestionForm.option3.value, correct: false },
                    { text: addQuestionForm.option4.value, correct: false },
                ];
                options[parseInt(addQuestionForm.correctAnswer.value)].correct = true;
                const newQuestion = {
                    id: 'pq' + (allPlumbingQuestions.length + 1) + Date.now(),
                    text: qText,
                    image: addQuestionForm.questionImage.value || null,
                    options: options
                };
                allPlumbingQuestions.push(newQuestion);
                alert(`Quiz question "${qText}" added!`);

            } else { // Important Q&A
                const aText = addQuestionForm.answerText.value;
                importantQuestions.push({ q: qText, a: aText });
                alert(`Important Q&A "${qText}" added!`);
            }
            
            addQuestionForm.reset();
            closeAddQuestionModalButton.click();
        });


        // --- Authentication State Listener & Initial Sign-in ---
        async function initializeAuthAndListeners() {
            if (!window.firebaseAuth || !window.firebaseSDKLoaded) {
                currentUserData = { userId: crypto.randomUUID(), displayName: "Guest (Auth Error)", isLoggedIn: false, isFirebaseUser: false };
                updateUIAfterAuthChange(); return;
            }
            const { onAuthStateChanged, signInAnonymously, signInWithCustomToken } = window.firebaseSDKLoaded;
            onAuthStateChanged(window.firebaseAuth, async (user) => {
                if (user) {
                    const userDataFromDb = await loadUserDataFromFirestore(user.uid);
                    if (userDataFromDb) {
                        currentUserData = { ...userDataFromDb, userId: user.uid, email: user.email || userDataFromDb.email, displayName: user.displayName || userDataFromDb.displayName, isLoggedIn: true, isFirebaseUser: true, };
                        if (typeof currentUserData.coins === 'undefined') currentUserData.coins = 0;
                        if (!Array.isArray(currentUserData.favoriteQuestions)) currentUserData.favoriteQuestions = [];
                    } else {
                        const newName = user.isAnonymous ? "Guest " + user.uid.substring(0, 5) : (user.email.split('@')[0]);
                        currentUserData = { userId: user.uid, displayName: user.displayName || newName, email: user.email, coins: user.isAnonymous ? 0 : 100, favoriteQuestions: [], isLoggedIn: true, isFirebaseUser: true, };
                        await saveUserDataToFirestore(user.uid, { displayName: currentUserData.displayName, email: currentUserData.email, coins: currentUserData.coins, favoriteQuestions: [] });
                    }
                } else {
                    currentUserData = { userId: crypto.randomUUID(), displayName: "Guest", isLoggedIn: false, isFirebaseUser: false };
                }
                updateUIAfterAuthChange(); 
            });
            try {
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) await signInWithCustomToken(window.firebaseAuth, __initial_auth_token);
                else if (!window.firebaseAuth.currentUser) await signInAnonymously(window.firebaseAuth);
            } catch (error) {
                console.error("Error during initial sign-in:", error);
                if (!window.firebaseAuth.currentUser) try { await signInAnonymously(window.firebaseAuth); } catch (e) { console.error("Retry anon sign-in failed", e); }
            }
        }


        // --- Initial Setup on DOMContentLoaded ---
        document.addEventListener('DOMContentLoaded', () => {
            if (window.firebaseApp) initializeAuthAndListeners(); 
            else { currentUserData = { userId: crypto.randomUUID(), displayName: "Guest (FB Init Error)", isLoggedIn: false, isFirebaseUser: false }; updateUIAfterAuthChange(); }
            renderAllTools();
            displayRandomImportantQuestion();
            setupShareButtons();
            updatePremiumTestUI();
        });

    </script>

</body>
</html>
