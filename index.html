<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mock Test Ncn - Firebase & Gemini Features</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
  
    <!-- Font Awesome for Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    
    
    <style>
        body 
        #threeStepOnboardingOverlay {
    /* Controlled by JavaScript to prevent content flash */
    display: none;
}

.onboarding-image {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    object-fit: cover; /* This will cover the entire screen */
    opacity: 0;
    transition: opacity 0.5s ease-in-out;
}

.onboarding-image.active {
    opacity: 1;
}
        
        {
            font-family: 'Inter', sans-serif;
            background-color: #E0F2FE; /* Light blue background */
            padding-bottom: 80px; /* Footer padding */
            overflow-x: hidden;
        }
        .premium-tag { background-color: #FFA726; color: black; }
        .free-tag { background-color: #66BB6A; color: white; }
        .start-now-button-original-style { background-color: #EC4899; } /* गुलाबी रंग */
        .plumber-tag { background-color: #FFCA28; color: #374151; } /* पीला रंग */
        .card-icon-placeholder { width: 50px; height: 50px; background-color: #E5E7EB; border-radius: 0.375rem; display: flex; align-items: center; justify-content: center; font-size: 0.75rem; color: #6B7280; flex-shrink: 0; }
        .practice-button { background-color: #3B82F6; } /* नीला रंग */
        .social-icon { width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; border-radius: 0.5rem; }
        .sidebar { transition: transform 0.3s ease-in-out; transform: translateX(-100%); }
        .sidebar.open { transform: translateX(0); }
        .sidebar-overlay { transition: opacity 0.3s ease-in-out; }
        .auth-modal, .quiz-modal, .content-modal-container, .confirmation-modal, .top-scorer-modal, .favorite-questions-modal, .complaint-modal, .important-questions-list-modal { background-color: rgba(0, 0, 0, 0.75); transition: opacity 0.3s ease-in-out, visibility 0.3s ease-in-out; }
        .auth-modal-content, .quiz-modal-content, .content-modal-content, .confirmation-modal-content, .top-scorer-modal-content, .favorite-questions-modal-content, .complaint-modal-content, .important-questions-list-modal-content { max-height: 90vh; transition: transform 0.3s ease-out, opacity 0.3s ease-out; transform: translateY(-20px) scale(0.95); opacity: 0; }
        .auth-modal.active,
        .quiz-modal.active,
        .content-modal-container.active,
        .confirmation-modal.active,
        .top-scorer-modal.active,
        .favorite-questions-modal.active,
        .complaint-modal.active,
        .important-questions-list-modal.active {
            opacity: 1;
            visibility: visible;
        }
        .auth-modal.active .auth-modal-content,
        .quiz-modal.active .quiz-modal-content,
        .content-modal-container.active .content-modal-content,
        .confirmation-modal.active .confirmation-modal-content,
        .top-scorer-modal.active .top-scorer-modal-content,
        .favorite-questions-modal.active .favorite-questions-modal-content,
        .complaint-modal.active .complaint-modal-content,
        .important-questions-list-modal.active .important-questions-list-modal-content { transform: translateY(0) scale(1); opacity: 1; }

        .quiz-option { transition: background-color 0.2s ease, border-color 0.2s ease; }
        .quiz-option:hover { background-color: #d1e5fb; border-color: #3B82F6; }
        .quiz-option.selected { background-color: #3B82F6; color: white; border-color: #2563EB; }
        .quiz-option.correct { background-color: #10B981; color: white; border-color: #059669; }
        .quiz-option.incorrect { background-color: #EF4444; color: white; border-color: #DC2626; }
        .quiz-option.disabled { opacity: 0.5; pointer-events: none; }
        .lifeline-btn.disabled { opacity: 0.4; cursor: not-allowed; background-color: #9CA3AF !important; }
        .timer-bar { height: 8px; background-color: #3B82F6; transition: width 1s linear; width: 100%; }
        .audience-poll-bar { background-color: #3B82F6; transition: width 0.5s ease-out; }
        .coin-icon { width: 20px; height: 20px; margin-left: 5px; vertical-align: middle; }
        .sub-card-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 0.75rem; /* gap-3 */
            margin-top: 0.75rem; /* mt-3 */
        }
        .sub-card {
            padding: 0.75rem; /* p-3 */
            border-radius: 0.375rem; /* rounded-md */
            text-align: left;
            transition: background-color 0.2s ease;
            cursor: pointer;
        }
        .premium-sub-card {
            background-color: #4A5568; /* bg-slate-700 */
            color: white;
        }
        .premium-sub-card:hover {
            background-color: #2D3748; /* bg-slate-800 or darker */
        }
        .premium-sub-card.disabled {
            background-color: #718096; /* Lighter slate for disabled */
            color: #A0AEC0;
            cursor: not-allowed;
            opacity: 0.7;
        }
        .free-sub-card {
            background-color: #EBF8FF; /* bg-blue-50 */
            color: #2B6CB0; /* text-blue-700 */
            border: 1px solid #BEE3F8; /* border-blue-200 */
        }
        .free-sub-card:hover {
            background-color: #C3DAFE; /* bg-blue-200 */
        }
        .tab-button.active {
            border-bottom-color: #3B82F6; /* blue-600 */
            color: #3B82F6; /* blue-600 */
            font-weight: 600;
        }
        .error-message {
            color: #EF4444; /* text-red-500 */
            font-size: 0.875rem; /* text-sm */
            margin-top: 0.25rem; /* mt-1 */
        }
        .tool-category-header, .tool-subcategory-header, .collapsible-header {
            cursor: pointer;
            transition: background-color 0.2s ease;
        }
        .tool-category-header:hover, .tool-subcategory-header:hover, .collapsible-header:hover {
            background-color: #e2e8f0; /* Tailwind gray-200 */
        }
        .tool-list-container, .tool-subcategory-container, .collapsible-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out;
        }
        .tool-list-container.open, .tool-subcategory-container.open, .collapsible-content.open {
            max-height: 1500px; /* Adjust as needed */
        }
        .content-modal-tool-detail {
            margin-bottom: 0.75rem; /* mb-3 */
            padding: 0.75rem; /* p-3 */
            background-color: #f9fafb; /* bg-gray-50 */
            border-left: 4px solid #3b82f6; /* border-blue-500 */
            border-radius: 0.25rem; /* rounded-sm */
        }
        .content-modal-tool-detail strong {
            color: #1d4ed8; /* text-blue-700 */
        }
        .favorite-btn {
            background: none; border: none; cursor: pointer;
            color: #cbd5e1; /* Tailwind gray-300 */
            transition: color 0.2s;
        }
        .favorite-btn:hover { color: #f59e0b; /* Tailwind amber-500 */ }
        .favorite-btn.favorited { color: #fbbf24; /* Tailwind amber-400 */ }

        .auth-modal, .quiz-modal, .content-modal-container, .confirmation-modal, .top-scorer-modal, .favorite-questions-modal, .complaint-modal, .important-questions-list-modal {
            display: none; 
            opacity: 0;
            visibility: hidden;
        }
        .auth-modal.active, .quiz-modal.active, .content-modal-container.active, .confirmation-modal.active, .top-scorer-modal.active, .favorite-questions-modal.active, .complaint-modal.active, .important-questions-list-modal.active {
            display: flex; 
            opacity: 1;
            visibility: visible;
        }
        .gemini-loader {
            display: none; /* Hidden by default */
            align-items: center;
            justify-content: center;
            padding: 0.5rem;
            font-size: 0.875rem; /* text-sm */
            color: #1d4ed8; /* text-blue-700 */
        }
        .gemini-loader.active {
            display: flex;
        }
        .gemini-spinner {
            width: 1rem; /* w-4 */
            height: 1rem; /* h-4 */
            border-width: 2px;
            border-style: solid;
            border-color: currentColor;
            border-right-color: transparent;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 0.5rem; /* mr-2 */
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .quiz-ai-explanation {
            margin-top: 1rem; /* mt-4 */
            padding: 0.75rem; /* p-3 */
            background-color: #f3f4f6; /* bg-gray-100 */
            border-left: 4px solid #60a5fa; /* border-blue-400 */
            border-radius: 0.25rem; /* rounded-sm */
            font-size: 0.875rem; /* text-sm */
            color: #374151; /* text-gray-700 */
        }

/* News Ticker Styles */
        .news-ticker-container {
            background-color: #1E40AF; /* Dark Blue */
            color: white;
            padding: 0.5rem;
            border-radius: 0.5rem;
            display: flex;
            align-items: center;
            overflow: hidden;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .news-ticker-container .title {
            background-color: #EF4444; /* Red */
            padding: 0.25rem 0.75rem;
            border-radius: 0.375rem;
            font-weight: 700;
            font-size: 0.875rem;
            flex-shrink: 0;
            margin-right: 1rem;
        }

        .news-ticker {
            overflow: hidden;
            width: 100%;
        }

        .news-ticker p {
            white-space: nowrap;
            display: inline-block;
            padding-left: 100%;
            animation: ticker-scroll 25s linear infinite;
        }

        @keyframes ticker-scroll {
            0% { transform: translateX(0); }
            100% { transform: translateX(-100%); }
        }

        /* Animated Banner Styles */
        .animated-banner-container {
            position: relative;
            width: 100%;
            max-width: 800px; /* Aap isko adjust kar sakte hain */
            margin-left: auto;
            margin-right: auto;
            border-radius: 0.75rem; /* rounded-xl */
            overflow: hidden;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
        }

        .banner-slider {
            position: relative;
            width: 100%;
            /* Aspect ratio set karne ke liye padding-top ka istemal */
            padding-top: 56.25%; /* 16:9 Aspect Ratio */
            background-color: #e5e7eb;
        }

        .banner-item {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            opacity: 0;
            transition: opacity 0.8s ease-in-out;
            visibility: hidden;
        }

        .banner-item.active {
            opacity: 1;
            visibility: visible;
        }

        .banner-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .banner-content {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            padding: 1rem;
            background: linear-gradient(to top, rgba(0,0,0,0.7), transparent);
            color: white;
        }

        .banner-content p {
            font-weight: 600;
            font-size: 1.125rem;
            text-shadow: 1px 1px 3px rgba(0,0,0,0.5);
        }

        .banner-dots {
            position: absolute;
            bottom: 10px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 8px;
        }

        .dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background-color: rgba(255, 255, 255, 0.5);
            cursor: pointer;
            transition: background-color 0.3s ease;
        }

        .dot.active {
            background-color: white;
        }


 {
            font-family: 'Inter', sans-serif;
        }
        /* Yeh CSS news ticker ke animation ke liye hai */
        .ticker-wrap {
            width: 100%;
            overflow: hidden;
        }
        .ticker-move {
            display: inline-block;
            white-space: nowrap;
            animation: ticker 15s linear infinite;
        }
        @keyframes ticker {
            0% { transform: translateX(100%); }
            100% { transform: translateX(-100%); }
        }



        
/* ---Important images  --- */
         {
            background-color: #f0f9ff; /* Light blue background to match your app */
            font-family: 'Inter', sans-serif;
        }
        /* --- Neon Button Animation --- */
        .neon-button {
            position: relative;
            z-index: 1;
            overflow: hidden;
            transition: color 0.3s;
        }
        .neon-button:hover {
            color: white;
        }
        .neon-button::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 200%;
            height: 200%;
            z-index: -2;
            background: conic-gradient(
                transparent,
                #0ea5e9, /* sky-500 */
                #ec4899, /* pink-500 */
                #f59e0b, /* amber-500 */
                transparent 30%
            );
            animation: rotate 4s linear infinite;
            transform-origin: center center;
            transform: translate(-50%, -50%);
        }
        .neon-button::after {
            content: '';
            position: absolute;
            top: 2px;
            left: 2px;
            right: 2px;
            bottom: 2px;
            background: #ffffff;
            border-radius: 0.625rem;
            z-index: -1;
            transition: background 0.3s;
        }
        .neon-button:hover::after {
            background: #1e293b;
        }
        @keyframes rotate {
            100% {
                transform: translate(-50%, -50%) rotate(360deg);
            }
        }
        
        /* --- Collapsible Content Animation --- */
        .collapsible-content {
            max-height: 0;
            overflow: hidden;
            opacity: 0;
            transition: max-height 0.7s ease-in-out, opacity 0.5s ease-in-out, padding 0.5s ease-in-out;
            padding: 0 1.25rem;
        }
        .collapsible-content.open {
            max-height: 1500px;
            opacity: 1;
            padding: 1.25rem;
        }
        /* Style for the full-screen image modal */
        .image-modal {
            background-color: rgba(0, 0, 0, 0.9);
            transition: opacity 0.3s ease-in-out;
        }
        .image-container-9-16 {
            width: 100%;
            max-width: 48vh;
            margin: auto;
            display: flex;
            align-items: center;
            justify-content: center;
        }

/* new login form */

        

    </style>
</head>
<body>

    <!-- Sidebar -->
    <div id="sidebar" class="sidebar fixed top-0 left-0 h-full w-64 sm:w-72 bg-slate-800 text-white z-[60] shadow-lg p-0 flex flex-col">
        <div class="bg-blue-600 p-4 flex items-center space-x-3">
            <img src="https://placehold.co/40x40/FFFFFF/3B82F6?text=Logo" alt="Logo" class="w-10 h-10 rounded-md bg-white p-1">
            <div>
                <h2 class="text-lg font-semibold">Mock Test</h2>
                <p class="text-sm text-blue-200">NcvtOnline</p>
            </div>
        </div>
        <nav class="flex-grow pt-4 space-y-1 overflow-y-auto">
            <a href="#" id="sidebarProfileLink" class="flex items-center px-4 py-3 text-sm text-slate-200 hover:bg-slate-700 rounded-md mx-2">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5 mr-3">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 6a3.75 3.75 0 1 1-7.5 0 3.75 3.75 0 0 1 7.5 0ZM4.501 20.118a7.5 7.5 0 0 1 14.998 0A17.933 17.933 0 0 1 12 21.75c-2.676 0-5.216-.584-7.499-1.632Z" />
                </svg> Profile (प्रोफ़ाइल)
            </a>
            <a href="#" id="sidebarTopScorerLink" class="flex items-center px-4 py-3 text-sm text-slate-200 hover:bg-slate-700 rounded-md mx-2">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5 mr-3">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M3 13.125C3 12.504 3.504 12 4.125 12h2.25c.621 0 1.125.504 1.125 1.125v6.75C7.5 20.496 6.996 21 6.375 21h-2.25A1.125 1.125 0 0 1 3 19.875v-6.75ZM9.75 8.625c0-.621.504-1.125 1.125-1.125h2.25c.621 0 1.125.504 1.125 1.125v11.25c0 .621-.504 1.125-1.125 1.125h-2.25a1.125 1.125 0 0 1-1.125-1.125V8.625ZM16.5 4.125c0-.621.504-1.125 1.125-1.125h2.25C20.496 3 21 3.504 21 4.125v15.75c0 .621-.504 1.125-1.125 1.125h-2.25a1.125 1.125 0 0 1-1.125-1.125V4.125Z" />
                </svg> Top Scorer (शीर्ष स्कोरर)
            </a>
             <a href="#" class="flex items-center px-4 py-3 text-sm text-slate-200 hover:bg-slate-700 rounded-md mx-2">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5 mr-3">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M2.25 18 9 11.25l4.306 4.306a11.95 11.95 0 0 1 5.814-5.518l2.74-1.22m0 0-5.94-2.281m5.94 2.28-2.28 5.941" />
                </svg> Statistics (सांख्यिकी)
            </a>
            <a href="#" class="flex items-center px-4 py-3 text-sm text-slate-200 hover:bg-slate-700 rounded-md mx-2">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5 mr-3">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M14.857 17.082a23.848 23.848 0 0 0 5.454-1.31A8.967 8.967 0 0 1 18 9.75V9A6 6 0 0 0 6 9v.75a8.967 8.967 0 0 1-2.312 6.022c1.733.64 3.56 1.085 5.455 1.31m5.714 0a24.255 24.255 0 0 1-5.714 0m5.714 0a3 3 0 1 1-5.714 0" />
                </svg> Notification (अधिसूचना)
            </a>
            <a href="#" id="sidebarFavoriteQuestionLink" class="flex items-center px-4 py-3 text-sm text-slate-200 hover:bg-slate-700 rounded-md mx-2">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5 mr-3">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M17.593 3.322c1.1.128 1.907 1.077 1.907 2.185V21L12 17.5 4.5 21V5.507c0-1.108.806-2.057 1.907-2.185a48.507 48.507 0 0 1 11.186 0Z" />
                </svg> Favorite Question (पसंदीदा प्रश्न)
            </a>
            <a href="#" id="sidebarRaiseComplaintLink" class="flex items-center px-4 py-3 text-sm text-slate-200 hover:bg-slate-700 rounded-md mx-2">
                 <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5 mr-3">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M21.75 6.75v10.5a2.25 2.25 0 0 1-2.25 2.25h-15a2.25 2.25 0 0 1-2.25-2.25V6.75m19.5 0A2.25 2.25 0 0 0 19.5 4.5h-15a2.25 2.25 0 0 0-2.25 2.25m19.5 0v.243a2.25 2.25 0 0 1-1.07 1.916l-7.5 4.615a2.25 2.25 0 0 1-2.36 0L3.32 8.91a2.25 2.25 0 0 1-1.07-1.916V6.75" />
                </svg> Raise Complaint (शिकायत दर्ज करें)
            </a>
            <a href="#" id="sidebarInstructionLink" class="flex items-center px-4 py-3 text-sm text-slate-200 hover:bg-slate-700 rounded-md mx-2">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5 mr-3">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M3.75 6.75h16.5M3.75 12h16.5m-16.5 5.25H12" />
                </svg> Instruction (निर्देश)
            </a>
             <a href="#" id="sidebarLogoutLink" class="flex items-center px-4 py-3 text-sm text-slate-200 hover:bg-slate-700 rounded-md mx-2 mt-auto mb-2 hidden">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5 mr-3">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 9V5.25A2.25 2.25 0 0 0 13.5 3h-6a2.25 2.25 0 0 0-2.25 2.25v13.5A2.25 2.25 0 0 0 7.5 21h6a2.25 2.25 0 0 0 2.25-2.25V15m3 0h3m0 0-3-3m3 3-3 3" />
                </svg> Logout (लॉग आउट)
            </a>
        </nav>
    </div>
    <div id="sidebarOverlay" class="sidebar-overlay fixed inset-0 bg-black bg-opacity-50 z-50 hidden"></div>

    <!-- Header -->
    <header class="bg-blue-600 text-white p-4 shadow-md sticky top-0 z-40">
        <div class="container mx-auto flex items-center justify-between">
            <button id="hamburgerButton" aria-label="Open menu" class="p-1 -ml-1">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-7 h-7">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M3.75 6.75h16.5M3.75 12h16.5m-16.5 5.25h16.5" />
                </svg>
            </button>
            <h1 class="text-xl font-semibold">Mock Test Ncn</h1>
            <div class="flex items-center space-x-3">
                <button id="headerUserIcon" aria-label="User profile or Login/Signup" class="focus:outline-none">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-7 h-7">
                      <path stroke-linecap="round" stroke-linejoin="round" d="M17.982 18.725A7.488 7.488 0 0 0 12 15.75a7.488 7.488 0 0 0-5.982 2.975m11.963 0a9 9 0 1 0-11.963 0m11.963 0A8.966 8.966 0 0 1 12 21a8.966 8.966 0 0 1-5.982-2.275M15 9.75a3 3 0 1 1-6 0 3 3 0 0 1 6 0Z" />
                    </svg>
                </button>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <div class="container mx-auto p-4">
        <!-- Loading Overlay -->
        <div id="loadingOverlay" class="fixed inset-0 bg-white bg-opacity-75 flex items-center justify-center z-[200]" style="display: none;">
            <div class="animate-spin rounded-full h-16 w-16 border-t-4 border-b-4 border-blue-500"></div>
            <p class="ml-3 text-blue-700 font-semibold">Loading data... (डेटा लोड हो रहा है...)</p>
        </div>

        <!-- User Profile Section -->
        <section class="bg-blue-500 text-white p-4 rounded-lg shadow-lg mt-1">
            <div class="flex items-center mb-2">
                <img id="userAvatarMain" src="https://placehold.co/60x60/FFFFFF/3B82F6?text=U" alt="User Avatar" class="w-12 h-12 rounded-full border-2 border-white mr-3">
                <div>
                    <h2 id="userNameMain" class="text-lg font-semibold">Guest User</h2>
                    <span id="userCoinsDisplay" class="ml-0 text-yellow-300 font-bold">(<span id="coinCount">0</span> 🪙)</span>
                    <div class="flex space-x-4 text-sm mt-1">
                        <span>ID: <span id="userIdDisplay" class="font-normal">N/A</span></span>
                    </div>
                </div>
            </div>
            <div class="mt-2 text-center">
                <span class="plumber-tag inline-block px-3 py-1 text-sm font-semibold rounded-md shadow">Plumber</span>
            </div>
        </section>


<!-- News Ticker Section -->
    <!-- Is section ko "Start Quiz" section ke theek upar paste karein -->
    <section class="mt-5">
        <div class="news-ticker-container">
            <span class="title">LATEST</span>
            <div class="news-ticker">
                <p>
                    ITI Plumber 2nd Year classes will start from August 1st. *** New premium mock tests have been added for advanced preparation. *** Stay updated with our YouTube channel for practical videos. *** </p>
            </div>
        </div>
    </section>

    <!-- Animated Banner Section -->
    <!-- Is section ko News Ticker ke theek neeche paste karein -->
    <section class="mt-5">
        <div class="animated-banner-container">
            <div id="bannerSlider" class="banner-slider">
                <!-- Banner Item 1 -->
                <a href="https://youtu.be/u0Gu65lLSho?si=DPSPWpkM-P2byg-3" target="_blank" class="banner-item active">
                    <img src="https://placehold.co/800x450/3B82F6/FFFFFF?text=Plumbing+Basics" alt="Video 1 Thumbnail">
                    <div class="banner-content">
                        <p>What is plumbing (प्लंबिंग की मूल बातें)</p>
                    </div>
                </a>
                <!-- Banner Item 2 -->
                <a href="https://youtu.be/4Ufu_c8YYTg?si=kep0TxAiXKvHJ1vy" target="_blank" class="banner-item">
                    <img src="https://placehold.co/800x450/EC4899/FFFFFF?text=Pipe+Fitting" alt="Video 2 Thumbnail">
                    <div class="banner-content">
                        <p>Advanced Pipe Fitting Techniques (पाइप फिटिंग तकनीक)</p>
                    </div>
                </a>
                <!-- Banner Item 3 -->
                <a href="https://youtu.be/HExfLxLa5ME?si=KWpl77AAfs4_vHNv" target="_blank" class="banner-item">
                    <img src="https://ibb.co/cSrv125r" alt="Video 3 Thumbnail">
                    <div class="banner-content">
                        <p>Types of Pipes (पाइप्स कितने प्रकार के होते है)</p>
                    </div>
                </a>
                <!-- Banner Item 4 -->
                <a href="https://www.youtube.com/" target="_blank" class="banner-item">
                    <img src="https://placehold.co/800x450/F59E0B/FFFFFF?text=Tool+Guide" alt="Video 4 Thumbnail">
                    <div class="banner-content">
                        <p>Guide to Essential Plumber Tools (आवश्यक उपकरण)</p>
                    </div>
                </a>
            </div>
            <div id="bannerDots" class="banner-dots">
                <!-- Dots will be generated by JavaScript -->
            </div>
        </div>
    </section>
        

        <!-- Start Quiz Section -->
        <section class="bg-white p-5 rounded-lg shadow-lg mt-5">
            <div class="flex justify-between items-center">
                <h2 class="text-xl font-bold text-blue-700">Ncvt Online Learning</h2>
            </div>
            <button id="triggerQuizButton" class="start-now-button-original-style w-full text-white font-semibold py-3 px-4 rounded-lg mt-4 flex items-center justify-center text-lg hover:bg-pink-600 transition duration-150">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-6 h-6 mr-2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M5.25 5.653c0-.856.917-1.398 1.667-.986l11.54 6.347a1.125 1.125 0 0 1 0 1.972l-11.54 6.347a1.125 1.125 0 0 1-1.667-.986V5.653Z" />
                </svg>
                Start Now (Quiz) (अभी शुरू करें (क्विज))
            </button>
        </section>

        <!-- Mock Test Sections -->
        <section class="mt-6">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-semibold text-gray-800">All Mock Test For Your Trade (आपके ट्रेड के लिए सभी मॉक टेस्ट)</h3>
                <a href="#" class="text-blue-600 font-medium hover:underline text-sm">View All (सभी देखें)</a>
            </div>
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-5">
                <!-- Free Test Card -->
                <div id="freeTestCardPlumberEnglish" class="bg-white rounded-xl shadow-lg p-4 relative border-t-4 border-blue-500">
                    <span class="free-tag absolute top-3 right-3 px-2 py-1 text-xs font-semibold rounded">Free</span>
                    <div class="flex items-start space-x-3">
                        <div class="card-icon-placeholder">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-8 h-8 text-blue-500"><path stroke-linecap="round" stroke-linejoin="round" d="M12 6.042A8.967 8.967 0 0 0 6 3.75c-1.052 0-2.062.18-3 .512v14.25A8.987 8.987 0 0 1 6 18c2.305 0 4.408.867 6 2.292m0-14.25a8.966 8.966 0 0 1 6-2.292c1.052 0 2.062.18 3 .512v14.25A8.987 8.987 0 0 0 18 18a8.967 8.967 0 0 0-6-2.292m0 0V21M12 6.042A8.967 8.967 0 0 1 18 3.75m0 14.25V6.042" /></svg>
                        </div>
                        <div>
                            <h4 class="text-md font-bold text-gray-800">ITI Mock Test</h4>
                            <p class="text-sm text-gray-600 font-medium">Plumber All Subject</p>
                            <p class="text-xs text-gray-500">( English )</p>
                        </div>
                    </div>
                    <div class="mt-3 pt-3 border-t border-gray-200">
                        <p class="text-sm font-semibold text-blue-700 mb-2">Plumber - English Sections</p>
                        <div id="freePlumberEnglishSubCardsContainer" class="sub-card-grid">
                            <button class="sub-card free-sub-card" data-subtest="basic_concepts_en"><h5 class="font-semibold">Basic Concepts</h5><p class="text-xs">Learn fundamentals</p></button>
                            <button class="sub-card free-sub-card" data-subtest="safety_symbols_en"><h5 class="font-semibold">Safety Symbols</h5><p class="text-xs">Understand signs</p></button>
                            <button class="sub-card free-sub-card" data-subtest="measurement_tools_en"><h5 class="font-semibold">Measurement Tools</h5><p class="text-xs">Tool details</p></button>
                            <button class="sub-card free-sub-card" data-subtest="practice_drills_en"><h5 class="font-semibold">Practice Drills</h5><p class="text-xs">Quick exercises</p></button>
                        </div>
                    </div>
                </div>
                <!-- Premium Test Card -->
                <div id="premiumTestCardPlumberHindi" class="bg-slate-800 text-white rounded-xl shadow-lg p-4 relative border-t-4 border-yellow-400">
                     <span class="premium-tag absolute top-3 right-3 px-2 py-1 text-xs font-semibold rounded">Premium</span>
                     <div class="flex items-start space-x-3">
                        <div class="card-icon-placeholder bg-slate-700">
                             <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-8 h-8 text-yellow-400"><path stroke-linecap="round" stroke-linejoin="round" d="M16.5 10.5V6.75a4.5 4.5 0 1 0-9 0v3.75m-.75 11.25h10.5a2.25 2.25 0 0 0 2.25-2.25v-6.75a2.25 2.25 0 0 0-2.25-2.25H6.75a2.25 2.25 0 0 0-2.25 2.25v6.75a2.25 2.25 0 0 0 2.25 2.25Z" /></svg>
                        </div>
                        <div>
                            <h4 class="text-md font-bold text-white">ITI Mock Test (Premium Section)</h4>
                            <p class="text-sm text-slate-300 font-medium">प्लम्बर सभी विषय</p>
                            <p class="text-xs text-slate-400">( English | हिंदी )</p>
                        </div>
                    </div>
                    <div class="mt-3 pt-3 border-t border-slate-700">
                        <div id="premiumPlumberHindiStatus" class="mb-2 text-sm text-yellow-200">Loading status...</div>
                        <button id="unlockPremiumPlumberHindiButton" data-testid="premium_plumber_hindi" data-cost="500" class="mb-3 w-full bg-green-600 hover:bg-green-700 text-white font-semibold py-2 px-3 rounded-lg text-sm transition opacity-50 cursor-not-allowed" disabled>Check Status</button>
                        <div id="premiumPlumberHindiSubCardsContainer" class="sub-card-grid hidden">
                            <button class="sub-card premium-sub-card disabled" data-subtest="handwritten_notes_hi"><h5 class="font-semibold">हस्तलिखित नोट्स (PDF)</h5><p class="text-xs text-slate-400">विस्तृत नोट्स पढ़ें</p></button>
                            <button class="sub-card premium-sub-card disabled" data-subtest="theory_hi"><h5 class="font-semibold">थ्योरी</h5><p class="text-xs text-slate-400">अवधारणाएं समझें</p></button>
                            <button class="sub-card premium-sub-card disabled" data-subtest="mock_test_hi"><h5 class="font-semibold">मॉक टेस्ट (PDF)</h5><p class="text-xs text-slate-400">परीक्षा का अभ्यास करें</p></button>
                            <button class="sub-card premium-sub-card disabled" data-subtest="test_preparation_hi"><h5 class="font-semibold">टेस्ट तैयारी (1000 MCQ)</h5><p class="text-xs text-slate-400">रणनीतियाँ और सुझाव</p></button>
                            <button class="sub-card premium-sub-card disabled" data-subtest="file_making_hi"><h5 class="font-semibold">फाइल मेकिंग (Images)</h5><p class="text-xs text-slate-400">प्रैक्टिकल कार्य</p></button>
                            <button class="sub-card premium-sub-card disabled" data-subtest="tools_detail_hi"><h5 class="font-semibold">उपकरण विवरण (AI)</h5><p class="text-xs text-slate-400">उपकरणों की जानकारी</p></button>
                        </div>
                    </div>
                </div>
                <!-- Free PDF Notes Card -->
                <div id="freePdfNotesCard" class="bg-white rounded-xl shadow-lg p-4 relative border-t-4 border-green-500">
                    <span class="free-tag absolute top-3 right-3 px-2 py-1 text-xs font-semibold rounded">Free</span>
                    <div class="flex items-start space-x-3">
                        <div class="card-icon-placeholder bg-green-100">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-8 h-8 text-green-600">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 14.25v-2.625a3.375 3.375 0 0 0-3.375-3.375h-1.5A1.125 1.125 0 0 1 13.5 7.125v-1.5a3.375 3.375 0 0 0-3.375-3.375H8.25m2.25 0H5.625c-.621 0-1.125.504-1.125 1.125v17.25c0 .621.504 1.125 1.125 1.125h12.75c.621 0 1.125-.504 1.125-1.125V11.25a9 9 0 0 0-9-9Z" />
                            </svg>
                        </div>
                        <div>
                            <h4 class="text-md font-bold text-gray-800">Free PDF Notes / Books</h4>
                            <p class="text-sm text-gray-600 font-medium">All Subjects</p>
                            <p class="text-xs text-gray-500">( Hindi & English )</p>
                        </div>
                    </div>
                    <div class="mt-3 pt-3 border-t border-gray-200">
                        <button id="viewPdfNotesButton" class="w-full bg-green-500 hover:bg-green-600 text-white font-semibold py-2 px-3 rounded-lg text-sm transition">
                            View All Notes (सभी नोट्स देखें)
                        </button>
                    </div>
                </div>
            </div>
        </section>

        <!-- Bathroom Fitting Height Chart Section -->
        <section class="bg-white p-5 rounded-lg shadow-lg mt-6">
            <div id="heightChartToggle" class="collapsible-header bg-gray-100 p-3 flex justify-between items-center rounded-lg">
                <div class="flex items-center">
                    <div class="card-icon-placeholder bg-purple-100 mr-3">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-7 h-7 text-purple-600">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M3.75 3.75v4.5m0-4.5h4.5m-4.5 0L9 9M3.75 20.25v-4.5m0 4.5h4.5m-4.5 0L9 15M20.25 3.75h-4.5m4.5 0v4.5m0-4.5L15 9m5.25 11.25h-4.5m4.5 0v-4.5m0 4.5L15 15" />
                        </svg>
                    </div>
                    <h3 class="text-lg font-semibold text-gray-800">Bathroom Fitting Height Chart</h3>
                </div>
                <i class="fas fa-chevron-down text-gray-500 transform transition-transform"></i>
            </div>
            <div id="heightChartContainer" class="collapsible-content mt-2">
                <div class="overflow-x-auto">
                    <table class="w-full text-sm text-left text-gray-600">
                        <thead class="text-xs text-gray-700 uppercase bg-gray-100">
                            <tr>
                                <th scope="col" class="px-4 py-3">🔧 फिटिंग का नाम</th>
                                <th scope="col" class="px-4 py-3">📏 ऊंचाई (फिनिश फ्लोर लेवल से)</th>
                                <th scope="col" class="px-4 py-3">📝 उपयोग / स्थान</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr class="bg-white border-b"><td class="px-4 py-3 font-medium">✅ Wash Basin (Top Level)</td><td class="px-4 py-3">800 – 850 mm</td><td class="px-4 py-3">Center या Wall-hung बेसिन</td></tr>
                            <tr class="bg-gray-50 border-b"><td class="px-4 py-3 font-medium">✅ Mixer Tap for Basin</td><td class="px-4 py-3">900 – 950 mm</td><td class="px-4 py-3">Basin के ऊपर या काउंटर टॉप पर</td></tr>
                            <tr class="bg-white border-b"><td class="px-4 py-3 font-medium">✅ Angle Valve (for Basin)</td><td class="px-4 py-3">600 mm</td><td class="px-4 py-3">Basin के नीचे, wall से</td></tr>
                            <tr class="bg-gray-50 border-b"><td class="px-4 py-3 font-medium">✅ Mirror Center Height</td><td class="px-4 py-3">1350 – 1500 mm</td><td class="px-4 py-3">Eye level पर, Basin के ऊपर</td></tr>
                            <tr class="bg-white border-b"><td class="px-4 py-3 font-medium">✅ Overhead Shower Head</td><td class="px-4 py-3">2100 mm</td><td class="px-4 py-3">Floor से शॉवर सेंटर तक</td></tr>
                            <tr class="bg-gray-50 border-b"><td class="px-4 py-3 font-medium">✅ Shower Arm / Pipe Inlet</td><td class="px-4 py-3">1950 – 2000 mm</td><td class="px-4 py-3">Pipe या concealed fitting</td></tr>
                            <tr class="bg-white border-b"><td class="px-4 py-3 font-medium">✅ Wall Mixer for Shower</td><td class="px-4 py-3">1050 – 1150 mm</td><td class="px-4 py-3">Hot/cold mix, शॉवर या टब के लिए</td></tr>
                            <tr class="bg-gray-50 border-b"><td class="px-4 py-3 font-medium">✅ Hand Shower Hook</td><td class="px-4 py-3">1000 – 1100 mm</td><td class="px-4 py-3">Wall-mounted</td></tr>
                            <tr class="bg-white border-b"><td class="px-4 py-3 font-medium">✅ Health Faucet (Jet Spray)</td><td class="px-4 py-3">400 – 450 mm</td><td class="px-4 py-3">WC के बगल में</td></tr>
                            <tr class="bg-gray-50 border-b"><td class="px-4 py-3 font-medium">✅ Angle Valve for Jet Spray</td><td class="px-4 py-3">250 – 300 mm</td><td class="px-4 py-3">WC के पास</td></tr>
                            <tr class="bg-white border-b"><td class="px-4 py-3 font-medium">✅ Western Toilet Seat Top</td><td class="px-4 py-3">400 – 425 mm</td><td class="px-4 py-3">Standard Sitting Height</td></tr>
                            <tr class="bg-gray-50 border-b"><td class="px-4 py-3 font-medium">✅ Flush Tank (PVC)</td><td class="px-4 py-3">1900 – 2000 mm</td><td class="px-4 py-3">Gravity flushing</td></tr>
                            <tr class="bg-white border-b"><td class="px-4 py-3 font-medium">✅ Flush Valve (Concealed)</td><td class="px-4 py-3">1000 – 1100 mm</td><td class="px-4 py-3">Push plate or flush button</td></tr>
                            <tr class="bg-gray-50 border-b"><td class="px-4 py-3 font-medium">✅ Urinal Rim Height (Jigger)</td><td class="px-4 py-3">600 – 650 mm</td><td class="px-4 py-3">Floor से Rim तक</td></tr>
                            <tr class="bg-white border-b"><td class="px-4 py-3 font-medium">✅ Urinal Flush Valve</td><td class="px-4 py-3">1050 mm</td><td class="px-4 py-3">Rim के ऊपर wall-mounted</td></tr>
                            <tr class="bg-gray-50 border-b"><td class="px-4 py-3 font-medium">✅ Towel Rod / Bar</td><td class="px-4 py-3">1200 – 1400 mm</td><td class="px-4 py-3">Easy reach</td></tr>
                            <tr class="bg-white border-b"><td class="px-4 py-3 font-medium">✅ Towel Ring (Near Basin)</td><td class="px-4 py-3">1050 – 1100 mm</td><td class="px-4 py-3">Basin के पास</td></tr>
                            <tr class="bg-gray-50 border-b"><td class="px-4 py-3 font-medium">✅ Robe Hook / Cloth Hook</td><td class="px-4 py-3">1700 – 1800 mm</td><td class="px-4 py-3">Door/Wall पर</td></tr>
                            <tr class="bg-white border-b"><td class="px-4 py-3 font-medium">✅ Soap Dish (Shower Area)</td><td class="px-4 py-3">1050 – 1100 mm</td><td class="px-4 py-3">Easily reachable in shower</td></tr>
                            <tr class="bg-gray-50 border-b"><td class="px-4 py-3 font-medium">✅ Shampoo Shelf / Niche</td><td class="px-4 py-3">1100 – 1200 mm</td><td class="px-4 py-3">Shower area में</td></tr>
                            <tr class="bg-white border-b"><td class="px-4 py-3 font-medium">✅ Toilet Paper Holder</td><td class="px-4 py-3">600 – 650 mm</td><td class="px-4 py-3">WC seat के साथ</td></tr>
                            <tr class="bg-gray-50 border-b"><td class="px-4 py-3 font-medium">✅ Geyser Point (Water Inlet)</td><td class="px-4 py-3">1800 – 2100 mm</td><td class="px-4 py-3">High-mounted geyser</td></tr>
                            <tr class="bg-white border-b"><td class="px-4 py-3 font-medium">✅ Floor Trap (Nahani Trap)</td><td class="px-4 py-3">Floor level</td><td class="px-4 py-3">Drainage</td></tr>
                            <tr class="bg-gray-50 border-b"><td class="px-4 py-3 font-medium">✅ Exhaust Fan</td><td class="px-4 py-3">2100 – 2300 mm</td><td class="px-4 py-3">Wall/window near ceiling</td></tr>
                            <tr class="bg-white"><td class="px-4 py-3 font-medium">✅ Electrical Switches</td><td class="px-4 py-3">1200 – 1350 mm</td><td class="px-4 py-3">Side of mirror or basin</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </section>

        <!-- All Tools Section -->
        <section class="bg-white p-5 rounded-lg shadow-lg mt-6">
            <div class="flex items-center mb-4">
                <div class="card-icon-placeholder bg-cyan-100 mr-3"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-7 h-7 text-cyan-600"><path stroke-linecap="round" stroke-linejoin="round" d="M11.42 15.17 17.25 21A2.652 2.652 0 0 0 21 17.25l-5.83-5.83M11.42 15.17A3 3 0 0 1 6.344 12.74l-2.531-2.531a2.25 2.25 0 0 1 0-3.182l2.25-2.25a2.25 2.25 0 0 1 3.182 0l2.531 2.531S15 10.585 15 12.75a3 3 0 0 1-3.58 2.42Z" /></svg></div>
                <h3 class="text-lg font-semibold text-gray-800">All Tools (सभी उपकरण)</h3>
            </div>
            <div id="allToolsContainer" class="space-y-3">
                <!-- Tools will be rendered here by JavaScript -->
            </div>
        </section>

        <!-- Important Q&A Section -->
        <section class="bg-white p-5 rounded-lg shadow-lg mt-6">
            <div class="flex items-center mb-3">
                <div class="card-icon-placeholder bg-teal-100 mr-3">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-7 h-7 text-teal-500">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M9.879 7.519c1.171-1.025 3.071-1.025 4.242 0 1.172 1.025 1.172 2.687 0 3.712-.203.179-.43.326-.67.442-.745.361-1.45.999-1.45 1.827v.75M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Zm-9 5.25h.008v.008H12v-.008Z" />
                    </svg>
                </div>
                <h3 class="text-md font-semibold text-gray-800">अति महत्वपूर्ण प्रश्न और उत्तर (Very Important Q&A)</h3>
            </div>
            <button id="showRandomImpQuestionBtn" class="w-full bg-sky-500 hover:bg-sky-600 text-white font-semibold py-3 px-4 rounded-lg mt-2 flex items-center justify-center text-lg transition duration-150">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6 mr-2"><path stroke-linecap="round" stroke-linejoin="round" d="M19.5 12c0-1.232-.046-2.453-.138-3.662a4.006 4.006 0 0 0-3.7-3.7 48.678 48.678 0 0 0-7.324 0 4.006 4.006 0 0 0-3.7 3.7c-.092 1.21-.138 2.43-.138 3.662v1.515A2.25 2.25 0 0 0 5.25 15h13.5a2.25 2.25 0 0 0 2.25-2.25V12Zm-15-1.5a.75.75 0 0 0-.75.75V12a.75.75 0 0 0 .75.75h13.5a.75.75 0 0 0 .75-.75V11.25a.75.75 0 0 0-.75-.75H4.5Z" /></svg>
                अगला महत्वपूर्ण प्रश्न देखें (Show Next Important Question)
            </button>
            <div id="importantQuestionDisplayArea" class="mt-4 p-4 bg-gray-100 rounded-md min-h-[100px] text-gray-700" style="display: none;">
                <h4 id="importantQuestionText" class="font-semibold text-md mb-2"></h4>
                <p id="importantAnswerText" class="text-sm"></p>
            </div>

            <!-- Gemini Q&A Section -->
            <div class="mt-6 pt-4 border-t border-gray-200">
                <h3 class="text-md font-semibold text-gray-800 mb-2">✨ अपना सवाल Gemini से पूछें (Ask Gemini Your Question)</h3>
                <div class="flex flex-col sm:flex-row gap-2">
                    <input type="text" id="userGeminiQuestion" placeholder="अपना प्लंबिंग सवाल यहाँ लिखें..." class="flex-grow p-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                    <button id="askGeminiButton" class="bg-purple-600 hover:bg-purple-700 text-white font-semibold py-2 px-4 rounded-lg transition flex items-center justify-center">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5 mr-2"><path stroke-linecap="round" stroke-linejoin="round" d="M9.813 15.904L9 18.75l-.813-2.846a4.5 4.5 0 00-3.09-3.09L1.25 9l2.846-.813a4.5 4.5 0 003.09-3.09L9 1.25l.813 2.846a4.5 4.5 0 003.09 3.09L15.75 9l-2.846.813a4.5 4.5 0 00-3.09 3.09Z"M18.25 10.875L17.5 13.5l-.75-2.625a3.375 3.375 0 00-2.625-2.625L10.5 7.5l2.625-.75a3.375 3.375 0 002.625-2.625L17.5 1.5l.75 2.625a3.375 3.375 0 002.625 2.625L23.25 7.5l-2.625.75a3.375 3.375 0 00-2.625 2.625Z" /></svg>
                        पूछें (Ask)
                    </button>
                </div>
                <div id="geminiQALoader" class="gemini-loader mt-2">
                    <div class="gemini-spinner"></div>
                    Gemini से पूछा जा रहा है...
                </div>
                <div id="geminiAnswerArea" class="mt-3 p-3 bg-purple-50 border border-purple-200 rounded-md text-gray-700 text-sm" style="display: none;">
                    <!-- Gemini's answer will appear here -->
                </div>
            </div>
        </section>
    </div>

    <!-- Footer Navigation -->
    <footer class="fixed bottom-0 left-0 right-0 bg-white shadow-t-lg border-t border-gray-200 p-3 flex justify-around items-center z-40">
        <button class="flex flex-col items-center text-blue-600 hover:text-blue-800"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-7 h-7"><path stroke-linecap="round" stroke-linejoin="round" d="m2.25 12 8.954-8.955c.44-.439 1.152-.439 1.591 0L21.75 12M4.5 9.75v10.125c0 .621.504 1.125 1.125 1.125H9.75v-4.875c0-.621.504-1.125 1.125-1.125h2.25c.621 0 1.125.504 1.125 1.125V21h4.125c.621 0 1.125-.504 1.125-1.125V9.75M8.25 21h7.5" /></svg><span class="text-xs mt-1">Home</span></button>
        <button id="footerTestButton" class="flex flex-col items-center text-gray-500 hover:text-blue-600"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-7 h-7"><path stroke-linecap="round" stroke-linejoin="round" d="M12 6.042A8.967 8.967 0 0 0 6 3.75c-1.052 0-2.062.18-3 .512v14.25A8.987 8.987 0 0 1 6 18c2.305 0 4.408.867 6 2.292m0-14.25a8.966 8.966 0 0 1 6-2.292c1.052 0 2.062.18 3 .512v14.25A8.987 8.987 0 0 0 18 18a8.967 8.967 0 0 0-6-2.292m0 0V21M12 6.042A8.967 8.967 0 0 1 18 3.75m0 14.25V6.042" /></svg><span class="text-xs mt-1">Tests</span></button>
        <button id="footerProfileButton" class="flex flex-col items-center text-gray-500 hover:text-blue-600"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-7 h-7"><path stroke-linecap="round" stroke-linejoin="round" d="M17.982 18.725A7.488 7.488 0 0 0 12 15.75a7.488 7.488 0 0 0-5.982 2.975m11.963 0a9 9 0 1 0-11.963 0m11.963 0A8.966 8.966 0 0 1 12 21a8.966 8.966 0 0 1-5.982-2.275M15 9.75a3 3 0 1 1-6 0 3 3 0 0 1 6 0Z" /></svg><span class="text-xs mt-1">Profile</span></button>
    </footer>

    <!-- Authentication Modal -->
    <div id="authModal" class="auth-modal fixed inset-0 z-[100] flex items-center justify-center p-4">
        <div class="auth-modal-content bg-slate-50 w-full max-w-md rounded-xl shadow-2xl p-6 overflow-y-auto">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold text-blue-700">Profile / Authentication (प्रोफ़ाइल / प्रमाणीकरण)</h2>
                <button id="closeAuthModalButton" class="text-gray-500 hover:text-gray-700">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-7 h-7"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg>
                </button>
            </div>
            <div id="authStatus" class="mb-4 p-3 bg-blue-100 text-blue-700 rounded-md text-sm hidden"></div>
            <div class="mb-4 border-b border-gray-200">
                <nav class="flex space-x-4" aria-label="Tabs">
                    <button id="loginTabButton" class="tab-button py-3 px-1 border-b-2 border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 text-sm font-medium active">Login (लॉग इन करें)</button>
                    <button id="signupTabButton" class="tab-button py-3 px-1 border-b-2 border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 text-sm font-medium">Signup (साइन अप करें)</button>
                </nav>
            </div>

            
          <form id="loginForm" class="space-y-4">
                <div><label for="loginEmail" class="block text-sm font-medium text-gray-700">Email (ईमेल)</label><input type="email" id="loginEmail" name="loginEmail" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm"></div>
                <div><label for="loginPassword" class="block text-sm font-medium text-gray-700">Password (पासवर्ड)</label><input type="password" id="loginPassword" name="loginPassword" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm"></div>
                <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-lg transition">Login</button>
                <p id="loginError" class="error-message hidden"></p>
            </form>
            <form id="signupForm" class="space-y-4 hidden">
                <div><label for="signupName" class="block text-sm font-medium text-gray-700">Full Name (पूरा नाम)</label><input type="text" id="signupName" name="signupName" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm"></div>
                <div><label for="signupEmail" class="block text-sm font-medium text-gray-700">Email (ईमेल)</label><input type="email" id="signupEmail" name="signupEmail" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm"></div>
                <div><label for="signupPassword" class="block text-sm font-medium text-gray-700">Password (पासवर्ड)</label><input type="password" id="signupPassword" name="signupPassword" required minlength="6" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm"></div>
                <button type="submit" class="w-full bg-green-500 hover:bg-green-600 text-white font-semibold py-2 px-4 rounded-lg transition">Signup</button>
                <p id="signupError" class="error-message hidden"></p>
            </form>
        </div>
    </div> 


    
    
    <!-- Top Scorer Modal -->
    <div id="topScorerModal" class="top-scorer-modal fixed inset-0 z-[95] flex items-center justify-center p-4">
        <div class="top-scorer-modal-content bg-slate-50 w-11/12 max-w-2xl rounded-xl shadow-2xl p-6 overflow-y-auto">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold text-blue-700">🏆 Top Scorers (शीर्ष स्कोरर) 🏆</h2>
                <button id="closeTopScorerModalButton" class="text-gray-500 hover:text-gray-700">
                     <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-7 h-7"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg>
                </button>
            </div>
            <div id="topScorerList" class="space-y-3"></div>
            <p class="mt-6 text-sm text-gray-600 text-center">Note: Leaderboard data is fetched from Google Sheets or Firebase. (लीडरबोर्ड डेटा गूगल शीट्स या फायरबेस से प्राप्त किया जाता है।)</p>
        </div>
    </div>

    <!-- Quiz Modal -->
    <div id="quizModal" class="quiz-modal fixed inset-0 z-[70] flex items-center justify-center p-4">
        <div class="quiz-modal-content bg-slate-50 w-11/12 max-w-5xl rounded-xl shadow-2xl p-6 overflow-y-auto">
            <!-- Quiz Setup Screen -->
            <div id="quizSetupScreen">
                <h2 class="text-2xl font-bold text-center text-blue-700 mb-6">प्लंबिंग क्विज़ (Plumbing Quiz)</h2>
                <p class="text-center text-gray-700 mb-2">आप कितने प्रश्न हल करना चाहते हैं?</p>
                <div class="flex justify-center space-x-3 mb-6">
                    <button data-count="5" class="num-questions-btn bg-blue-500 hover:bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg transition">5 प्रश्न</button>
                    <button data-count="10" class="num-questions-btn bg-blue-500 hover:bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg transition">10 प्रश्न</button>
                    <button data-count="15" class="num-questions-btn bg-blue-500 hover:bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg transition">15 प्रश्न</button>
                </div>
                <p class="text-center text-xs text-gray-500 mb-4">प्रत्येक प्रश्न के लिए 1 मिनट का समय होगा।</p>
                <button id="startSelectedQuizButton" class="w-full bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-4 rounded-lg text-lg transition disabled:opacity-50" disabled>क्विज़ शुरू करें</button>
                <button id="closeQuizSetupButton" class="mt-3 w-full bg-gray-300 hover:bg-gray-400 text-gray-800 font-semibold py-2 px-4 rounded-lg transition">बंद करें</button>
            </div>
            <!-- Quiz Interface Screen -->
            <div id="quizInterfaceScreen" class="hidden">
                <div class="flex justify-between items-center mb-1">
                    <h2 class="text-xl font-bold text-blue-700">प्रश्न <span id="currentQuestionNumber"></span>/<span id="totalQuizQuestions"></span></h2>
                    <div class="flex items-center">
                        <button id="favoriteQuestionButton" class="favorite-btn text-2xl"><i class="far fa-star"></i></button>
                        <div class="text-lg font-semibold text-red-500 ml-3">समय: <span id="quizTimer">01:00</span></div>
                    </div>
                </div>
                <div class="w-full bg-gray-300 rounded-full mb-4"><div id="questionTimerBar" class="timer-bar rounded-full"></div></div>
                <div id="questionImageContainer" class="mb-4 text-center hidden"><img id="questionImage" src="" alt="प्रश्न सम्बंधित चित्र" class="max-w-full h-auto max-h-60 sm:max-h-80 md:max-h-96 mx-auto rounded-lg shadow-md object-contain"></div>
                <p id="questionTextQuiz" class="text-lg sm:text-xl font-semibold text-gray-800 mb-5 min-h-[60px]"></p> 
                <div id="optionsContainer" class="space-y-3 mb-6"></div>
                
                <!-- AI Explanation Area -->
                <div id="geminiQuizExplanationLoader" class="gemini-loader mt-4">
                    <div class="gemini-spinner"></div>
                    TEACHER से स्पष्टीकरण प्राप्त हो रहा है...
                </div>
                <div id="geminiQuizExplanationArea" class="quiz-ai-explanation" style="display: none;">
                    <!-- Gemini's quiz explanation will appear here -->
                </div>

                <div class="my-6"> <!-- Added margin-top and margin-bottom for spacing -->
                    <h3 class="text-md font-semibold text-gray-700 mb-2 text-center">लाइफलाइन (Lifelines):</h3>
                    <div class="flex justify-center space-x-2 sm:space-x-4">
                        <button id="lifeline5050" class="lifeline-btn bg-yellow-500 hover:bg-yellow-600 text-white font-semibold py-2 px-3 sm:px-4 rounded-lg flex items-center text-sm transition"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-5 h-5 mr-1 hidden sm:inline"><path stroke-linecap="round" stroke-linejoin="round" d="M12 6.75a.75.75 0 1 1 0-1.5.75.75 0 0 1 0 1.5ZM12 12.75a.75.75 0 1 1 0-1.5.75.75 0 0 1 0 1.5ZM12 18.75a.75.75 0 1 1 0-1.5.75.75 0 0 1 0 1.5Z" /></svg>50/50</button>
                        <button id="lifelineAudiencePoll" class="lifeline-btn bg-purple-500 hover:bg-purple-600 text-white font-semibold py-2 px-3 sm:px-4 rounded-lg flex items-center text-sm transition"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-5 h-5 mr-1 hidden sm:inline"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 6a3.75 3.75 0 1 1-7.5 0 3.75 3.75 0 0 1 7.5 0ZM4.501 20.118a7.5 7.5 0 0 1 14.998 0A17.933 17.933 0 0 1 12 21.75c-2.676 0-5.216-.584-7.499-1.632Z" /></svg>ऑडियंस पोल</button>
                    </div>
                </div>
                <div id="audiencePollResults" class="hidden mt-4 space-y-2"></div>
                <button id="nextQuestionButton" class="w-full bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-4 rounded-lg text-lg transition hidden">अगला प्रश्न</button>
                <button id="closeQuizInterfaceButton" class="mt-3 w-full bg-gray-300 hover:bg-gray-400 text-gray-800 font-semibold py-2 px-4 rounded-lg transition">क्विज़ बंद करें</button>
            </div>
            <!-- Quiz Results Screen -->
             <div id="quizResultsScreen" class="hidden text-center">
                <h2 class="text-3xl font-bold text-green-600 mb-4">क्विज़ समाप्त!</h2>
                <img src="https://placehold.co/100x100/E0F2FE/10B981?text=🏆" alt="Trophy" class="mx-auto mb-4 w-24 h-24">
                <p class="text-xl text-gray-800 mb-2">आपका स्कोर: <span id="finalScore"></span></p>
                <p class="text-lg text-gray-700 mb-2">सही उत्तर: <span id="correctAnswersCount"></span></p>
                <p class="text-lg text-gray-700 mb-6">आपने <span id="coinsEarnedInQuiz">0</span> सिक्के कमाए!</p>
                <div class="space-y-3 sm:space-y-0 sm:flex sm:space-x-4 justify-center">
                    <button id="playAgainButton" class="w-full sm:w-auto bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-6 rounded-lg text-lg transition">फिर से खेलें</button>
                    <button id="closeQuizResultsButton" class="w-full sm:w-auto bg-gray-500 hover:bg-gray-600 text-white font-semibold py-3 px-6 rounded-lg text-lg transition">बंद करें</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Confirmation Modal -->
    <div id="confirmationModal" class="confirmation-modal fixed inset-0 z-[80] flex items-center justify-center p-4">
        <div class="confirmation-modal-content bg-white w-full max-w-md rounded-xl shadow-2xl p-6">
            <h2 id="confirmationTitle" class="text-xl font-bold text-gray-800 mb-4">Confirm Purchase</h2>
            <p id="confirmationMessage" class="text-gray-700 mb-6">Are you sure?</p>
            <div class="flex justify-end space-x-3">
                <button id="cancelUnlockButton" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-semibold py-2 px-4 rounded-lg transition">Cancel</button>
                <button id="confirmUnlockButton" class="bg-green-500 hover:bg-green-600 text-white font-semibold py-2 px-4 rounded-lg transition">Confirm</button>
            </div>
        </div>
    </div>

    <!-- Content Modal (for free section items, tools, premium items, instructions) -->
    <div id="contentModal" class="content-modal-container fixed inset-0 z-[90] flex items-center justify-center p-4">
        <div class="content-modal-content bg-white w-11/12 max-w-4xl rounded-xl shadow-2xl p-6 overflow-y-auto">
            <div class="flex justify-between items-center mb-4">
                <h2 id="contentModalTitle" class="text-xl md:text-2xl font-bold text-blue-700">Content Title</h2>
                <button id="closeContentModalButton" class="text-gray-500 hover:text-gray-700">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-7 h-7"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg>
                </button>
            </div>
            <div id="contentModalImageContainer" class="mb-4 text-center hidden">
                <img id="contentModalImage" src="" alt="Content Image" class="max-w-full h-auto max-h-60 sm:max-h-80 md:max-h-96 mx-auto rounded-lg shadow-md object-contain">
            </div>
            <div id="contentModalBody" class="text-gray-700 space-y-2 text-sm sm:text-base md:text-lg">
                <!-- Content will be injected here -->
            </div>
            <button id="getAdvancedToolInfoButton" class="hidden mt-3 w-full bg-indigo-500 hover:bg-indigo-600 text-white font-semibold py-2 px-3 rounded-lg transition flex items-center justify-center text-sm">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5 mr-2"><path stroke-linecap="round" stroke-linejoin="round" d="M9.813 15.904L9 18.75l-.813-2.846a4.5 4.5 0 00-3.09-3.09L1.25 9l2.846-.813a4.5 4.5 0 003.09-3.09L9 1.25l.813 2.846a4.5 4.5 0 003.09 3.09L15.75 9l-2.846.813a4.5 4.5 0 00-3.09 3.09Z"M18.25 10.875L17.5 13.5l-.75-2.625a3.375 3.375 0 00-2.625-2.625L10.5 7.5l2.625-.75a3.375 3.375 0 002.625-2.625L17.5 1.5l.75 2.625a3.375 3.375 0 002.625 2.625L23.25 7.5l-2.625.75a3.375 3.375 0 00-2.625 2.625Z" /></svg>
                ✨ Get Advanced Details with TEACHERS 
            </button>
            <div id="geminiToolInfoLoader" class="gemini-loader mt-2">
                <div class="gemini-spinner"></div>
                TEACHER से पूछा जा रहा है...
            </div>
            <div id="geminiToolInfoArea" class="mt-2 p-2 bg-indigo-50 border border-indigo-200 rounded-md text-gray-700 text-xs" style="display: none;">
            </div>
        </div>
    </div>

    <!-- Favorite Questions Modal -->
    <div id="favoriteQuestionsModal" class="favorite-questions-modal fixed inset-0 z-[90] flex items-center justify-center p-4">
        <div class="favorite-questions-modal-content bg-white w-11/12 max-w-3xl rounded-xl shadow-2xl p-6 overflow-y-auto">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold text-blue-700">पसंदीदा प्रश्न (Favorite Questions)</h2>
                <button id="closeFavoriteQuestionsModalButton" class="text-gray-500 hover:text-gray-700">
                     <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-7 h-7"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg>
                </button>
            </div>
            <div id="favoriteQuestionsList" class="space-y-4">
                <!-- Favorite questions will be listed here -->
            </div>
        </div>
    </div>
    
    <!-- Important Questions List Modal -->
    <div id="importantQuestionsListModal" class="important-questions-list-modal fixed inset-0 z-[90] flex items-center justify-center p-4">
        <div class="important-questions-list-modal-content bg-white w-11/12 max-w-3xl rounded-xl shadow-2xl p-6 overflow-y-auto">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold text-teal-600">अति महत्वपूर्ण प्रश्न सूची (Important Questions List)</h2>
                <button id="closeImportantQuestionsListModalButton" class="text-gray-500 hover:text-gray-700">
                     <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-7 h-7"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg>
                </button>
            </div>
            <div id="importantQuestionsListContainer" class="space-y-4">
                <!-- Important questions list will be populated here -->
            </div>
        </div>
    </div>

    <!-- Complaint Modal -->
    <div id="complaintModal" class="complaint-modal fixed inset-0 z-[90] flex items-center justify-center p-4">
        <div class="complaint-modal-content bg-white w-full max-w-lg rounded-xl shadow-2xl p-6">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold text-blue-700">अपनी शिकायत दर्ज करें (Raise Your Complaint)</h2>
                <button id="closeComplaintModalButton" class="text-gray-500 hover:text-gray-700">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-7 h-7"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg>
                </button>
            </div>
            <form id="complaintForm">
                <div class="mb-4">
                    <label for="complaintText" class="block text-sm font-medium text-gray-700 mb-1">आपकी समस्या/प्रश्न (Your Issue/Question):</label>
                    <textarea id="complaintText" name="complaintText" rows="5" required class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"></textarea>
                </div>
                <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-lg transition">शिकायत भेजें (Send Complaint)</button>
            </form>
        </div>
    </div>

<div id="threeStepOnboardingOverlay" class="fixed inset-0 bg-white z-[200] transition-opacity duration-500">
    <!-- Image Container -->
    <div class="relative w-full h-full">
        <!-- Image 1 -->
        <img id="onboardingImage1" src="https://placehold.co/360x640/3B82F6/FFFFFF?text=Step+1:%0AWelcome!" alt="Onboarding Step 1" class="onboarding-image active">
        <!-- Image 2 -->
        <img id="onboardingImage2" src="https://placehold.co/360x640/EC4899/FFFFFF?text=Step+2:%0ALearn+Skills" alt="Onboarding Step 2" class="onboarding-image">
        <!-- Image 3 -->
        <img id="onboardingImage3" src="https://placehold.co/360x640/10B981/FFFFFF?text=Step+3:%0AGet+Started" alt="Onboarding Step 3" class="onboarding-image">
    </div>

    <!-- Next Button -->
    <button id="threeStepNextBtn" class="fixed bottom-8 right-8 bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-full text-lg shadow-lg transition-all duration-300 hover:scale-105 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 z-[210]">
        Next &rarr;
    </button>
</div>

<!-- ===== MAIN PAGE CONTAINER ===== -->
    <!-- `h-screen` poori screen ki height leta hai. -->
    <!-- `flex flex-col` elements ko upar se neeche line mein lagaata hai. -->
    <div class="w-full max-w-md mx-auto bg-gray-50 h-screen flex flex-col">

        <!-- 1. Header (Fixed) -->
        <header class="bg-blue-600 text-white p-4 flex justify-between items-center shadow-lg flex-shrink-0">
            <h1 class="text-xl font-bold">SULEMAN ITI TOPPER</h1>
            
        </header>

        <!-- 2. Main Content Area (Scrollable) -->
        <!-- ===== YEH SABSE IMPORTANT PART HAI ===== -->
        <!-- `flex-grow` isse kehta hai ki jitni bhi khali jagah bache, le lo. -->
        <!-- `overflow-y-auto` isse scrollable banata hai jab content zyada ho. -->
        <main class="flex-grow overflow-y-auto p-4">
            
            <!-- Banner 16:9 -->
            <div class="w-full aspect-video bg-gray-300 rounded-lg mb-4 flex items-center justify-center">
                <p class="text-gray-500"></p>
            </div>

            <!-- News Ticker -->
            <div class="bg-white p-2 rounded-lg shadow-sm mb-4 ticker-wrap">
                <div class="ticker-move">
                    <span class="text-red-500 font-bold">Breaking News:</span> Plumber ki fees badh gayi hai...
                    <span class="mx-4">|</span>
                    <span class="text-blue-500 font-bold">Offer:</span> Geyser repair par 20% off...
                </div>
            </div>

            <!-- Q&A Box -->
            <div class="bg-white p-4 rounded-lg shadow-md mb-4">
                <p class="mb-2 text-gray-800"><strong class="font-bold">प्रश्न:</strong> सुरक्षा के लिए गैस पाइपलाइन पर काम करते समय क्या सावधानियां बरतनी चाहिए?</p>
                <p class="text-gray-700"><strong class="font-bold">उत्तर:</strong> मुख्य गैस आपूर्ति बंद करें, क्षेत्र को हवादार करें, ज्वलनशील पदार्थों को दूर रखें...</p>
            </div>

            <!-- Aap yahan aur bhi content daal sakte hain, page apne aap scrollable rahega -->
            <div class="h-20"></div> <!-- Extra space to demonstrate scrolling -->

        </main>




        
    <!-- ===================== IMPORTANT IMAGES SECTION START ========================= -->
    
    <section class="container mx-auto">
        <div class="bg-white rounded-xl shadow-lg overflow-hidden">
            <!-- Section Header (Always Visible) -->
            <div id="gallery-header" class="p-5 cursor-pointer bg-gray-50 hover:bg-gray-100 transition-colors">
                <div class="flex items-center justify-between">
                    <div class="flex items-center">
                        <div class="flex items-center justify-center w-12 h-12 rounded-md bg-pink-100 mr-4">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-7 h-7 text-pink-600">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M2.25 15.75l5.159-5.159a2.25 2.25 0 013.182 0l5.159 5.159m-1.5-1.5l1.409-1.409a2.25 2.25 0 013.182 0l2.909 2.909m-18 3.75h16.5a1.5 1.5 0 001.5-1.5V6a1.5 1.5 0 00-1.5-1.5H3.75A1.5 1.5 0 002.25 6v12a1.5 1.5 0 001.5 1.5zm10.5-11.25h.008v.008h-.008V8.25zm.375 0a.375.375 0 11-.75 0 .375.375 0 01.75 0z" />
                            </svg>
                        </div>
                        <h3 class="text-xl font-bold text-gray-800">Important Images (महत्वपूर्ण चित्र)</h3>
                    </div>
                    <!-- The Neon Button -->
                    <button id="toggle-gallery-btn" class="neon-button relative inline-flex items-center justify-center px-4 py-2 rounded-xl font-semibold text-gray-700">
                        <span id="toggle-text">Show</span>
                        <i id="toggle-icon" class="fas fa-chevron-down ml-2 transition-transform duration-300"></i>
                    </button>
                </div>
            </div>
            <!-- Collapsible Image Gallery -->
            <div id="image-gallery-container" class="collapsible-content">
                <div id="image-gallery" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-4">
                    <!-- JavaScript will populate this area -->
                </div>
            </div>
        </div>
    </section>
    <!-- ============================================================================== -->
    <!-- ====================== IMPORTANT IMAGES SECTION END ========================== -->
    <!-- ============================================================================== -->
    <!-- ============================================================================== -->
    <!-- ==================== FULL SCREEN IMAGE MODAL START =========================== -->
    <!-- ============================================================================== -->
    <div id="image-modal" class="image-modal fixed inset-0 z-[200] flex items-center justify-center p-4 hidden">
        <!-- Close Button -->
        <button id="close-modal-btn" class="absolute top-4 right-4 text-white hover:text-gray-300 text-4xl z-[210] transition-colors">
            <i class="fas fa-times"></i>
        </button>
        <!-- 9:16 Aspect Ratio Image Container -->
        <div class="image-container-9-16">
            <img id="fullscreen-image" src="" alt="Full-screen view" class="w-full h-auto object-contain rounded-lg shadow-2xl">
        </div>
    </div>
    <!-- ============================================================================== -->
    <!-- ===================== FULL SCREEN IMAGE MODAL END ============================ -->


        
        <!-- 3. Bottom Navigation (Fixed) -->
        <footer class="bg-white shadow-[0_-2px_5px_rgba(0,0,0,0.1)] p-2 flex justify-around items-center flex-shrink-0">
            <button class="flex flex-col items-center text-blue-600">
                <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20"><path d="M10.707 2.293a1 1 0 00-1.414 0l-7 7a1 1 0 001.414 1.414L4 10.414V17a1 1 0 001 1h2a1 1 0 001-1v-2a1 1 0 011-1h2a1 1 0 011 1v2a1 1 0 001 1h2a1 1 0 001-1v-6.586l.293.293a1 1 0 001.414-1.414l-7-7z"></path></svg>
                <span class="text-xs">Home</span>
            </button>
            <button class="flex flex-col items-center text-gray-500">
                <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20"><path d="M9 2a1 1 0 000 2h2a1 1 0 100-2H9z"></path><path fill-rule="evenodd" d="M4 5a2 2 0 012-2 3 3 0 003 3h2a3 3 0 003-3 2 2 0 012 2v11a2 2 0 01-2 2H6a2 2 0 01-2-2V5zm3 4a1 1 0 000 2h.01a1 1 0 100-2H7zm3 0a1 1 0 000 2h3a1 1 0 100-2h-3zm-3 4a1 1 0 100 2h.01a1 1 0 100-2H7zm3 0a1 1 0 100 2h3a1 1 0 100-2h-3z" clip-rule="evenodd"></path></svg>
                <span class="text-xs">Tests</span>
            </button>
            <button class="flex flex-col items-center text-gray-500">
                <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-6-3a2 2 0 11-4 0 2 2 0 014 0zm-2 4a5 5 0 00-4.546 2.916A5.986 5.986 0 0010 16a5.986 5.986 0 004.546-2.084A5 5 0 0012 11z" clip-rule="evenodd"></path></svg>
                <span class="text-xs">Profile</span>
            </button>
        </footer>

    </div>



    


    
    
    <!-- ============================================================================== -->
    <!-- ===================== FIREBASE SDK IMPORTS START ============================= -->
    <!-- ============================================================================== -->
    <script type="module">
        // Firebase App (Core)
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        // Firebase Authentication
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        // Firestore Database
        import { getFirestore, doc, getDoc, setDoc, updateDoc, deleteDoc, onSnapshot, collection, query, where, addDoc, getDocs, serverTimestamp, runTransaction } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        // Firebase Analytics (Optional)
        // import { getAnalytics } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-analytics.js";
    
        // Global Firebase instances (will be initialized in the main script)
        window.firebaseApp = null;
        window.firebaseDb = null;
        window.firebaseAuth = null;
        window.firebaseSDKLoaded = { // Make SDK functions available globally for the main script
            initializeApp,
            getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut,
            getFirestore, doc, getDoc, setDoc, updateDoc, deleteDoc, onSnapshot, collection, query, where, addDoc, getDocs, serverTimestamp, runTransaction
            // getAnalytics (if using)
        };
        console.log("Firebase SDKs loaded and assigned to window.firebaseSDKLoaded via module script.");
    </script>
    <!-- ============================================================================== -->
    <!-- ===================== FIREBASE SDK IMPORTS END =============================== -->
    <!-- ============================================================================== -->


    <script> // Main Application Script
        // --- Gemini API Key Placeholder ---
        const GEMINI_API_KEY = ""; // For models other than gemini-2.0-flash or imagen-3.0-generate-002
        const GEMINI_API_URL_TEXT = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${GEMINI_API_KEY}`;

        // --- Firebase Initialization and Auth Logic ---
        let firebaseInitialized = false; // Flag to prevent multiple initializations
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id'; // Define appId globally for use in paths

        function initFirebaseApp() {
            if (firebaseInitialized) {
                console.log("Firebase already initialized.");
                return true;
            }

            try {
                // --- FIREBASE CONFIG ---
                let userProvidedFirebaseConfig = { 
                    apiKey: "AIzaSyCk0Wb16qVd16VKYsi5VviE_f0eE5jdNYY",
                    authDomain: "mock-test-eed98.firebaseapp.com",
                    databaseURL: "https://mock-test-eed98-default-rtdb.firebaseio.com",
                    projectId: "mock-test-eed98",
                    storageBucket: "mock-test-eed98.appspot.com",
                    messagingSenderId: "821341772378",
                    appId: "1:821341772378:web:b9f000a61ba9224d1b1663",
                    measurementId: "G-V3K014SFG6"
                };
                
                let firebaseConfigToUse;
                if (typeof __firebase_config !== 'undefined' && __firebase_config && __firebase_config.trim() !== "") {
                    try {
                        firebaseConfigToUse = JSON.parse(__firebase_config);
                        console.log("Using Firebase config from __firebase_config global variable.");
                    } catch (e) {
                        console.error("Error parsing __firebase_config. Using user-provided fallback config. Error:", e);
                        firebaseConfigToUse = userProvidedFirebaseConfig;
                    }
                } else {
                    console.warn("__firebase_config is not defined or empty. Using user-provided fallback config.");
                    firebaseConfigToUse = userProvidedFirebaseConfig;
                }
                // --- END FIREBASE CONFIG ---

                window.firebaseApp = window.firebaseSDKLoaded.initializeApp(firebaseConfigToUse);
                window.firebaseAuth = window.firebaseSDKLoaded.getAuth(window.firebaseApp);
                window.firebaseDb = window.firebaseSDKLoaded.getFirestore(window.firebaseApp);
                console.log("Firebase initialized successfully with App ID:", appId);
                firebaseInitialized = true;
                return true;
            } catch (error) {
                console.error("Firebase initialization error:", error);
                firebaseInitialized = false; 
                return false;
            }
        }


        // --- Global User Data Store ---
        let currentUserData = {
            userId: null, 
            displayName: "Guest User",
            email: null,
            coins: 0,
            premiumAccess: {}, 
            favoriteQuestions: [], 
            isLoggedIn: false,
            isFirebaseUser: false 
        };
        const PRE_APPROVED_USER_EMAIL = "test@example.com"; 
        const PRE_APPROVED_USER_PASS = "test123"; 
        const PREMIUM_TEST_ID = "premium_plumber_hindi"; 
        const PREMIUM_TEST_COST = 500;


        // DOM Elements
        const userNameMainEl = document.getElementById('userNameMain');
        const userAvatarMainEl = document.getElementById('userAvatarMain');
        const userIdDisplayEl = document.getElementById('userIdDisplay');
        const coinCountEl = document.getElementById('coinCount');
        const authModal = document.getElementById('authModal');
        const closeAuthModalButton = document.getElementById('closeAuthModalButton');
        const loginTabButton = document.getElementById('loginTabButton');
        const signupTabButton = document.getElementById('signupTabButton');
        const loginForm = document.getElementById('loginForm');
        const signupForm = document.getElementById('signupForm');
        const loginErrorEl = document.getElementById('loginError');
        const signupErrorEl = document.getElementById('signupError');
        const authStatusEl = document.getElementById('authStatus');
        const sidebarProfileLink = document.getElementById('sidebarProfileLink');
        const headerUserIcon = document.getElementById('headerUserIcon');
        const footerProfileButton = document.getElementById('footerProfileButton');
        const sidebarLogoutLink = document.getElementById('sidebarLogoutLink');
        const sidebarInstructionLink = document.getElementById('sidebarInstructionLink');
        const topScorerModal = document.getElementById('topScorerModal');
        const sidebarTopScorerLink = document.getElementById('sidebarTopScorerLink');
        const closeTopScorerModalButton = document.getElementById('closeTopScorerModalButton');
        const topScorerListEl = document.getElementById('topScorerList');
        const loadingOverlay = document.getElementById('loadingOverlay');
        const sidebarFavoriteQuestionLink = document.getElementById('sidebarFavoriteQuestionLink');
        const favoriteQuestionsModal = document.getElementById('favoriteQuestionsModal');
        const closeFavoriteQuestionsModalButton = document.getElementById('closeFavoriteQuestionsModalButton');
        const favoriteQuestionsListEl = document.getElementById('favoriteQuestionsList');
        const sidebarRaiseComplaintLink = document.getElementById('sidebarRaiseComplaintLink');
        const complaintModal = document.getElementById('complaintModal');
        const closeComplaintModalButton = document.getElementById('closeComplaintModalButton');
        const complaintForm = document.getElementById('complaintForm');
        const showRandomImpQuestionBtn = document.getElementById('showRandomImpQuestionBtn');
        const importantQuestionDisplayArea = document.getElementById('importantQuestionDisplayArea');
        const importantQuestionTextEl = document.getElementById('importantQuestionText');
        const importantAnswerTextEl = document.getElementById('importantAnswerText');
        const premiumTestButton = document.getElementById('unlockPremiumPlumberHindiButton');
        const premiumTestStatusEl = document.getElementById('premiumPlumberHindiStatus');
        const premiumPlumberHindiSubCardsContainer = document.getElementById('premiumPlumberHindiSubCardsContainer');
        const userGeminiQuestionInput = document.getElementById('userGeminiQuestion');
        const askGeminiButton = document.getElementById('askGeminiButton');
        const geminiQALoader = document.getElementById('geminiQALoader');
        const geminiAnswerArea = document.getElementById('geminiAnswerArea');
        const getAdvancedToolInfoButton = document.getElementById('getAdvancedToolInfoButton');
        const geminiToolInfoLoader = document.getElementById('geminiToolInfoLoader');
        const geminiToolInfoArea = document.getElementById('geminiToolInfoArea');
        let currentToolForGemini = null; 
        const geminiQuizExplanationLoader = document.getElementById('geminiQuizExplanationLoader');
        const geminiQuizExplanationArea = document.getElementById('geminiQuizExplanationArea');
        const heightChartToggle = document.getElementById('heightChartToggle');
        const heightChartContainer = document.getElementById('heightChartContainer');
        const footerTestButton = document.getElementById('footerTestButton');
        const importantQuestionsListModal = document.getElementById('importantQuestionsListModal');
        const importantQuestionsListContainer = document.getElementById('importantQuestionsListContainer');
        const closeImportantQuestionsListModalButton = document.getElementById('closeImportantQuestionsListModalButton');

        // --- Firestore Helper Functions ---
        async function loadUserDataFromFirestore(userId) {
            if (!window.firebaseDb || !window.firebaseSDKLoaded) {
                console.error("Firestore is not initialized for loadUserDataFromFirestore.");
                return null;
            }
            const { doc, getDoc } = window.firebaseSDKLoaded;
            // Corrected path according to Firestore security rules for private user data
            const userDocRef = doc(window.firebaseDb, "artifacts", appId, "users", userId, "profile", "data"); 
            try {
                const docSnap = await getDoc(userDocRef);
                if (docSnap.exists()) {
                    console.log("User data loaded from Firestore:", docSnap.data());
                    return docSnap.data();
                } else {
                    console.log("No such document in Firestore for user:", userId, "at path:", userDocRef.path);
                    return null;
                }
            } catch (error) {
                console.error("Error loading user data from Firestore:", error, "Path:", userDocRef.path);
                return null;
            }
        }

        async function saveUserDataToFirestore(userId, userData) {
            if (!window.firebaseDb || !window.firebaseSDKLoaded) {
                console.error("Firestore is not initialized for saveUserDataToFirestore.");
                return { success: false, error: "Firestore not initialized" };
            }
            const { doc, setDoc, serverTimestamp } = window.firebaseSDKLoaded;
            // Corrected path for private user data
            const userDocRef = doc(window.firebaseDb, "artifacts", appId, "users", userId, "profile", "data");
            try {
                const dataToSave = {
                    ...userData,
                    updatedAt: serverTimestamp()
                };
                if (!userData.createdAt && !(await getDoc(userDocRef)).exists()) { 
                    dataToSave.createdAt = serverTimestamp();
                }

                await setDoc(userDocRef, dataToSave, { merge: true }); 
                console.log("User data saved to Firestore for user:", userId, "at path:", userDocRef.path);
                return { success: true };
            } catch (error) {
                console.error("Error saving user data to Firestore:", error, "Path:", userDocRef.path);
                return { success: false, error: error.message };
            }
        }
        
        async function loadTopScorersFromFirestore() {
            if (!window.firebaseDb || !window.firebaseSDKLoaded) {
                console.error("Firestore is not initialized for loading top scorers.");
                return [];
            }
            const { collection, query, getDocs } = window.firebaseSDKLoaded;
            // Path for public leaderboard data
            const leaderboardCollectionRef = collection(window.firebaseDb, "artifacts", appId, "public", "data", "leaderboard");
            
            try {
                const querySnapshot = await getDocs(leaderboardCollectionRef);
                const scorers = [];
                querySnapshot.forEach((doc) => {
                    scorers.push({ id: doc.id, ...doc.data() });
                });
                // Sort by coins descending, then by displayName
                scorers.sort((a, b) => {
                    if ((b.coins || 0) === (a.coins || 0)) { // Ensure coins are numbers for comparison
                        return (a.displayName || '').localeCompare(b.displayName || '');
                    }
                    return (b.coins || 0) - (a.coins || 0);
                });
                console.log("Loaded top scorers from public leaderboard:", scorers.slice(0, 10));
                return scorers.slice(0, 10); 
            } catch (error) {
                console.error("Error loading top scorers from Firestore (public leaderboard):", error, "Path:", leaderboardCollectionRef.path);
                return [];
            }
        }

        async function updateUserPublicLeaderboard(userId, displayName, coins) {
            if (!window.firebaseDb || !window.firebaseSDKLoaded) {
                console.error("Firestore is not initialized for updating public leaderboard.");
                return { success: false, error: "Firestore not initialized" };
            }
            const { doc, setDoc, serverTimestamp } = window.firebaseSDKLoaded;
            const leaderboardDocRef = doc(window.firebaseDb, "artifacts", appId, "public", "data", "leaderboard", userId);
            try {
                await setDoc(leaderboardDocRef, {
                    displayName: displayName,
                    coins: coins,
                    updatedAt: serverTimestamp()
                }, { merge: true });
                console.log("Public leaderboard updated for user:", userId);
                return { success: true };
            } catch (error) {
                console.error("Error updating public leaderboard:", error, "Path:", leaderboardDocRef.path);
                return { success: false, error: error.message };
            }
        }


        // --- UI Update & Auth Logic ---
        function updateUIAfterAuthChange() {
            console.log("Updating UI based on auth state:", currentUserData);
            if (currentUserData.isLoggedIn && currentUserData.isFirebaseUser) { 
                userNameMainEl.textContent = currentUserData.displayName || "User";
                userIdDisplayEl.textContent = currentUserData.email || currentUserData.userId; 
                coinCountEl.textContent = currentUserData.coins || 0;
                sidebarLogoutLink.classList.remove('hidden');
                
                authStatusEl.textContent = `Logged in as: ${currentUserData.displayName || "User"} (${currentUserData.email || currentUserData.userId})`;
                authStatusEl.classList.remove('hidden');
                loginForm.classList.add('hidden'); 
                signupForm.classList.add('hidden');
                document.getElementById('loginTabButton').classList.add('hidden'); 
                document.getElementById('signupTabButton').classList.add('hidden'); 

            } else { 
                userNameMainEl.textContent = "Guest User (अतिथि)";
                userIdDisplayEl.textContent = "N/A";
                coinCountEl.textContent = 0;
                sidebarLogoutLink.classList.add('hidden');

                authStatusEl.classList.add('hidden');
                loginForm.classList.remove('hidden'); 
                signupForm.classList.add('hidden'); 
                document.getElementById('loginTabButton').classList.remove('hidden');
                document.getElementById('signupTabButton').classList.remove('hidden');
                loginTabButton.classList.add('active');
                signupTabButton.classList.remove('active');
            }
            updatePremiumTestUI(); 
            updateFavoriteQuestionIcons(); 
        }

        function openAuthModal() {
            console.log("Opening Auth Modal");
            authModal.classList.remove('hidden'); 
            setTimeout(() => authModal.classList.add('active'), 10); 
            document.body.style.overflow = 'hidden';
            loginErrorEl.classList.add('hidden');
            signupErrorEl.classList.add('hidden');
            loginForm.reset();
            signupForm.reset();
            updateUIAfterAuthChange(); 
        }
        
        closeAuthModalButton.addEventListener('click', () => {
            authModal.classList.remove('active');
            setTimeout(() => authModal.classList.add('hidden'), 300); 
            document.body.style.overflow = 'auto';
        });

        loginTabButton.addEventListener('click', () => {
            loginForm.classList.remove('hidden');
            signupForm.classList.add('hidden');
            loginTabButton.classList.add('active');
            signupTabButton.classList.remove('active');
        });

        signupTabButton.addEventListener('click', () => {
            loginForm.classList.add('hidden');
            signupForm.classList.remove('hidden');
            loginTabButton.classList.remove('active');
            signupTabButton.classList.add('active');
        });

        signupForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!window.firebaseAuth || !window.firebaseSDKLoaded) {
                signupErrorEl.textContent = "Authentication service not ready.";
                signupErrorEl.classList.remove('hidden');
                return;
            }
            const { createUserWithEmailAndPassword } = window.firebaseSDKLoaded;

            const name = signupForm.signupName.value.trim();
            const email = signupForm.signupEmail.value.trim().toLowerCase();
            const password = signupForm.signupPassword.value;
            signupErrorEl.classList.add('hidden');

            if (!name || !email || !password) { signupErrorEl.textContent = "All fields are required."; signupErrorEl.classList.remove('hidden'); return; }
            if (!email.includes('@')) { signupErrorEl.textContent = "Invalid email format."; signupErrorEl.classList.remove('hidden'); return; }
            if (password.length < 6) { signupErrorEl.textContent = "Password must be at least 6 characters."; signupErrorEl.classList.remove('hidden'); return; }

            loadingOverlay.style.display = 'flex';
            try {
                const userCredential = await createUserWithEmailAndPassword(window.firebaseAuth, email, password);
                const user = userCredential.user;
                console.log("Firebase user created:", user);
                // Firestore data for new user will be handled by onAuthStateChanged, which also calls saveUserDataToFirestore
                // and updateUserPublicLeaderboard
                closeAuthModalButton.click(); 
            } catch (error) {
                console.error("Firebase signup error:", error);
                signupErrorEl.textContent = error.message; 
                signupErrorEl.classList.remove('hidden');
            } finally {
                loadingOverlay.style.display = 'none';
            }
        });

        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!window.firebaseAuth || !window.firebaseSDKLoaded) {
                loginErrorEl.textContent = "Authentication service not ready.";
                loginErrorEl.classList.remove('hidden');
                return;
            }
            const { signInWithEmailAndPassword } = window.firebaseSDKLoaded;

            const email = loginForm.loginEmail.value.trim().toLowerCase();
            const password = loginForm.loginPassword.value;
            loginErrorEl.classList.add('hidden');

            if (!email || !password) { loginErrorEl.textContent = "Email and password are required."; loginErrorEl.classList.remove('hidden'); return; }
            
            loadingOverlay.style.display = 'flex';
            try {
                const userCredential = await signInWithEmailAndPassword(window.firebaseAuth, email, password);
                console.log("Firebase user signed in:", userCredential.user);
                // onAuthStateChanged will handle UI updates and data loading.
                closeAuthModalButton.click();
            } catch (error) {
                console.error("Firebase login error:", error);
                loginErrorEl.textContent = "Invalid email or password."; 
                if (error.code === 'auth/user-not-found' || error.code === 'auth/wrong-password' || error.code === 'auth/invalid-credential') {
                    loginErrorEl.textContent = "गलत ईमेल या पासवर्ड।";
                } else {
                    loginErrorEl.textContent = "Login failed: " + error.message;
                }
                loginErrorEl.classList.remove('hidden');
            } finally {
                loadingOverlay.style.display = 'none';
            }
        });
        
        sidebarLogoutLink.addEventListener('click', async (e) => {
            e.preventDefault();
            if (!window.firebaseAuth || !window.firebaseSDKLoaded) {
                console.error("Firebase Auth not initialized for logout.");
                return;
            }
            const { signOut } = window.firebaseSDKLoaded;
            try {
                await signOut(window.firebaseAuth);
                console.log("User signed out from Firebase.");
                // onAuthStateChanged will handle currentUserData reset and UI update
            } catch (error) {
                console.error("Firebase logout error:", error);
            }
            if (sidebar.classList.contains('open')) { toggleSidebar(); }
        });

        sidebarProfileLink.addEventListener('click', (e) => { e.preventDefault(); openAuthModal(); });
        headerUserIcon.addEventListener('click', openAuthModal);
        footerProfileButton.addEventListener('click', openAuthModal);

        sidebarTopScorerLink.addEventListener('click', async (e) => {
            e.preventDefault();
            topScorerModal.classList.remove('hidden');
            setTimeout(() => topScorerModal.classList.add('active'), 10);
            document.body.style.overflow = 'hidden';
            topScorerListEl.innerHTML = '<p class="text-center text-gray-500">Loading...</p>';
            
            const scorers = await loadTopScorersFromFirestore(); 

            topScorerListEl.innerHTML = ''; 
            if (scorers && scorers.length > 0) {
                scorers.forEach((scorer, index) => {
                    const scorerDiv = document.createElement('div');
                    scorerDiv.className = 'flex items-center justify-between p-3 bg-white rounded-lg shadow-sm border border-gray-200';
                    let medal = index === 0 ? '🥇 1.' : index === 1 ? '🥈 2.' : index === 2 ? '🥉 3.' : `${index + 1}.`;
                    scorerDiv.innerHTML = `
                        <div class="flex items-center">
                            <span class="text-lg font-semibold mr-3 ${index < 3 ? (index === 0 ? 'text-yellow-500' : index === 1 ? 'text-gray-400' : 'text-orange-400') : 'text-gray-700'}">${medal}</span>
                            <img src="https://placehold.co/40x40/${Math.random().toString(16).substr(-6)}/${Math.random().toString(16).substr(-6)}?text=${scorer.displayName ? scorer.displayName.charAt(0).toUpperCase() : 'U'}" alt="User" class="w-10 h-10 rounded-full mr-3">
                            <span class="font-medium text-gray-800">${scorer.displayName || 'Anonymous'}</span>
                        </div>
                        <span class="font-semibold text-blue-600">${scorer.coins || 0} 🪙</span>`;
                    topScorerListEl.appendChild(scorerDiv);
                });
            } else {
                topScorerListEl.innerHTML = '<p class="text-center text-gray-500">No scorers data found or unable to load.</p>';
            }
        });
        closeTopScorerModalButton.addEventListener('click', () => {
            topScorerModal.classList.remove('active');
            setTimeout(() => topScorerModal.classList.add('hidden'), 300);
            document.body.style.overflow = 'auto';
        });

        function updatePremiumTestUI() {
            const testAccessData = currentUserData.premiumAccess?.[PREMIUM_TEST_ID];
            const userCoins = currentUserData.coins || 0;
            
            premiumPlumberHindiSubCardsContainer.classList.add('hidden'); 
            premiumPlumberHindiSubCardsContainer.querySelectorAll('.premium-sub-card').forEach(card => {
                card.classList.add('disabled'); card.onclick = null;
            });

            if (testAccessData && testAccessData.expiresAt) {
                const expiryDate = new Date(testAccessData.expiresAt + "T23:59:59");
                if (expiryDate > new Date()) {
                    premiumTestStatusEl.textContent = `Unlocked! Expires: ${testAccessData.expiresAt}`;
                    premiumTestButton.textContent = "View Content";
                    premiumTestButton.className = "mb-3 w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-3 rounded-lg text-sm transition";
                    premiumTestButton.disabled = true; 
                    premiumPlumberHindiSubCardsContainer.classList.remove('hidden');
                    premiumPlumberHindiSubCardsContainer.querySelectorAll('.premium-sub-card').forEach(card => {
                        card.classList.remove('disabled');
                        card.onclick = () => openContentModalGeneric(card.dataset.subtest, true, false); 
                    });
                    return; 
                } else { premiumTestStatusEl.textContent = `Premium access expired.`; }
            } else { premiumTestStatusEl.textContent = `Cost: ${PREMIUM_TEST_COST} coins. You have ${userCoins}.`; }
            
            premiumTestButton.className = "mb-3 w-full bg-green-600 hover:bg-green-700 text-white font-semibold py-2 px-3 rounded-lg text-sm transition";
            
            if (currentUserData.isLoggedIn && currentUserData.isFirebaseUser) { 
                if (userCoins >= PREMIUM_TEST_COST) {
                    premiumTestButton.textContent = `Unlock Section for ${PREMIUM_TEST_COST} 🪙`;
                    premiumTestButton.disabled = false;
                    premiumTestButton.classList.remove('opacity-50', 'cursor-not-allowed');
                    premiumTestButton.onclick = () => handleUnlockPremiumTest(PREMIUM_TEST_ID, PREMIUM_TEST_COST);
                } else {
                    premiumTestButton.textContent = `Need ${PREMIUM_TEST_COST - userCoins} more 🪙`;
                    premiumTestButton.disabled = true;
                    premiumTestButton.classList.add('opacity-50', 'cursor-not-allowed');
                    premiumTestButton.onclick = null;
                }
            } else { 
                premiumTestButton.textContent = `Login to Unlock (Cost: ${PREMIUM_TEST_COST} 🪙)`;
                premiumTestButton.disabled = true; 
                premiumTestButton.classList.add('opacity-50', 'cursor-not-allowed');
                premiumTestButton.onclick = openAuthModal; 
            }
        }

        async function handleUnlockPremiumTest(testId, cost) {
            if (!currentUserData.isLoggedIn || !currentUserData.isFirebaseUser || !currentUserData.userId) { openAuthModal(); return; }
            if ((currentUserData.coins || 0) < cost) { premiumTestStatusEl.textContent = "Not enough coins."; return; }
            
            const confirmationModalEl = document.getElementById('confirmationModal');
            document.getElementById('confirmationTitle').textContent = "Confirm Purchase";
            document.getElementById('confirmationMessage').textContent = `Unlock this section for ${cost} coins? This will grant access for 1 month.`;
            
            confirmationModalEl.classList.remove('hidden');
            setTimeout(() => confirmationModalEl.classList.add('active'), 10);

            document.getElementById('confirmUnlockButton').onclick = async () => {
                confirmationModalEl.classList.remove('active');
                setTimeout(() => confirmationModalEl.classList.add('hidden'), 300);
                
                const newCoins = (currentUserData.coins || 0) - cost;
                const expiryDate = new Date(); expiryDate.setMonth(expiryDate.getMonth() + 1);
                const newPremiumAccess = {
                    ...currentUserData.premiumAccess,
                    [testId]: { expiresAt: expiryDate.toISOString().split('T')[0] }
                };

                const updateData = {
                    coins: newCoins,
                    premiumAccess: newPremiumAccess
                };
                
                const saveResult = await saveUserDataToFirestore(currentUserData.userId, updateData);
                if (saveResult.success) {
                    currentUserData.coins = newCoins;
                    currentUserData.premiumAccess = newPremiumAccess;
                    // Also update public leaderboard
                    await updateUserPublicLeaderboard(currentUserData.userId, currentUserData.displayName, newCoins);
                } else { 
                    premiumTestStatusEl.textContent = "Error unlocking. Please try again.";
                }
                updateUIAfterAuthChange(); 
            };
            document.getElementById('cancelUnlockButton').onclick = () => {
                confirmationModalEl.classList.remove('active');
                setTimeout(() => confirmationModalEl.classList.add('hidden'), 300);
            };
        }
        
        async function updateUserCoins(amount) {
            if (!currentUserData.isLoggedIn || !currentUserData.isFirebaseUser || !currentUserData.userId) {
                console.warn("Cannot update coins: User not logged in via Firebase or userId missing.");
                return;
            }

            const currentCoins = Number(currentUserData.coins || 0);
            const newCoins = currentCoins + amount;

            console.log(`Updating coins for user ${currentUserData.userId}. Current coins: ${currentCoins}, Amount to add: ${amount}, New total: ${newCoins}`);

            const saveResult = await saveUserDataToFirestore(currentUserData.userId, { coins: newCoins });

            if (saveResult.success) {
                console.log('Successfully saved new coin total to Firestore. Updating local state.');
                currentUserData.coins = newCoins;
                await updateUserPublicLeaderboard(currentUserData.userId, currentUserData.displayName, newCoins);
            } else {
                console.error('Failed to save new coin total to Firestore.', saveResult.error);
            }
            
            updateUIAfterAuthChange();
        }

        const sidebar = document.getElementById('sidebar');
        const sidebarOverlay = document.getElementById('sidebarOverlay');
        const hamburgerButton = document.getElementById('hamburgerButton');
        function toggleSidebar() {
            sidebar.classList.toggle('open');
            sidebarOverlay.classList.toggle('hidden');
            if (sidebar.classList.contains('open')) {
                document.body.style.overflow = 'hidden'; 
            } else {
                document.body.style.overflow = 'auto';
            }
        }
        hamburgerButton.addEventListener('click', toggleSidebar);
        sidebarOverlay.addEventListener('click', toggleSidebar);

        const importantQuestions = [
            { q: "भारत में प्लंबिंग के लिए आमतौर पर किस प्रकार के पाइप का उपयोग किया जाता है?", a: "आमतौर पर पीवीसी (PVC), सीपीवीसी (CPVC), यूपीवीसी (UPVC), जीआई (GI - Galvanized Iron), और तांबे (Copper) के पाइप का उपयोग किया जाता है।" },
            { q: "पानी के रिसाव को रोकने के लिए सबसे अच्छा तरीका क्या है?", a: "नियमित रूप से पाइप और फिटिंग की जांच करें, उच्च गुणवत्ता वाली सामग्री का उपयोग करें, और सही स्थापना सुनिश्चित करें।" },
            { q: "एक 'वाटर हैमर अरेस्टर' क्या करता है?", a: "यह पाइपों में पानी के प्रवाह के अचानक रुकने या बदलने से होने वाले 'वाटर हैमर' (तेज आवाज और कंपन) को अवशोषित करता है।" },
            { q: "सुरक्षा के लिए गैस पाइपलाइन पर काम करते समय क्या सावधानियां बरतनी चाहिए?", a: "मुख्य गैस आपूर्ति बंद करें, क्षेत्र को हवादार करें, ज्वलनशील पदार्थों को दूर रखें, और चिंगारी पैदा करने वाले उपकरणों का उपयोग न करें।" }
        ];
        let lastDisplayedImpQIndex = -1;

        function displayRandomImportantQuestion() {
            if (importantQuestions.length === 0) return;
            let randomIndex;
            if (importantQuestions.length === 1) { randomIndex = 0; } 
            else { do { randomIndex = Math.floor(Math.random() * importantQuestions.length); } while (randomIndex === lastDisplayedImpQIndex); }
            lastDisplayedImpQIndex = randomIndex;
            const item = importantQuestions[randomIndex];
            importantQuestionTextEl.textContent = `प्रश्न: ${item.q}`;
            importantAnswerTextEl.textContent = `उत्तर: ${item.a}`;
            importantQuestionDisplayArea.style.display = 'block';
        }
        showRandomImpQuestionBtn.addEventListener('click', displayRandomImportantQuestion);

        const triggerQuizButton = document.getElementById('triggerQuizButton');
        const quizModalEl = document.getElementById('quizModal'); 
        const quizSetupScreen = document.getElementById('quizSetupScreen');
        const quizInterfaceScreen = document.getElementById('quizInterfaceScreen');
        const quizResultsScreen = document.getElementById('quizResultsScreen');
        const numQuestionsButtons = document.querySelectorAll('.num-questions-btn');
        const startSelectedQuizButton = document.getElementById('startSelectedQuizButton');
        const closeQuizSetupButton = document.getElementById('closeQuizSetupButton');
        const currentQuestionNumberEl = document.getElementById('currentQuestionNumber');
        const totalQuizQuestionsEl = document.getElementById('totalQuizQuestions');
        const quizTimerEl = document.getElementById('quizTimer');
        const questionTimerBar = document.getElementById('questionTimerBar');
        const questionImageContainer = document.getElementById('questionImageContainer');
        const questionImageEl = document.getElementById('questionImage');
        const questionTextQuizEl = document.getElementById('questionTextQuiz'); 
        const optionsContainer = document.getElementById('optionsContainer');
        const lifeline5050Button = document.getElementById('lifeline5050');
        const lifelineAudiencePollButton = document.getElementById('lifelineAudiencePoll');
        const audiencePollResultsEl = document.getElementById('audiencePollResults');
        const nextQuestionButton = document.getElementById('nextQuestionButton');
        const closeQuizInterfaceButton = document.getElementById('closeQuizInterfaceButton');
        const finalScoreEl = document.getElementById('finalScore');
        const correctAnswersCountEl = document.getElementById('correctAnswersCount');
        const playAgainButton = document.getElementById('playAgainButton');
        const closeQuizResultsButton = document.getElementById('closeQuizResultsButton');
        const coinsEarnedInQuizEl = document.getElementById('coinsEarnedInQuiz');
        const favoriteQuestionButton = document.getElementById('favoriteQuestionButton');

        let allPlumbingQuestions = [
            { id: "pq1", text: "चित्र में दिखाए गए उपकरण का नाम क्या है? (What is the name of the tool shown in the picture?)", image: "https://placehold.co/300x200/E0F2FE/3B82F6?text=Pipe+Wrench", options: [{ text: "पाइप रिंच (Pipe Wrench)", correct: true },{ text: "समायोज्य रिंच (Adjustable Wrench)", correct: false },{ text: "सॉकेट रिंच (Socket Wrench)", correct: false },{ text: "टॉर्क रिंच (Torque Wrench)", correct: false }]},
            { id: "pq2", text: "पानी के रिसाव को रोकने के लिए पाइप थ्रेड्स पर आमतौर पर किस सामग्री का उपयोग किया जाता है? (What material is commonly used on pipe threads to prevent water leaks?)", image: null, options: [{ text: "टेफ्लॉन टेप (Teflon Tape)", correct: true },{ text: "डक्ट टेप (Duct Tape)", correct: false },{ text: "रबर सीमेंट (Rubber Cement)", correct: false },{ text: "सिलिकॉन सीलेंट (Silicone Sealant)", correct: false }]},
            { id: "pq3", text: "पीवीसी का पूर्ण रूप क्या है? (What is the full form of PVC?)", image: null, options: [{ text: "पॉलीविनाइल क्लोराइड (Polyvinyl Chloride)", correct: true }, { text: "पॉलीविनाइल कार्बन (Polyvinyl Carbon)", correct: false }, { text: "प्रेसर वाल्व कंट्रोल (Pressure Valve Control)", correct: false }, { text: "पाइप वेरिफ़िकेशन कोड (Pipe Verification Code)", correct: false }]},
            { id: "pq4", text: "नाली की रुकावट को साफ करने के लिए किस उपकरण का उपयोग किया जाता है? (Which tool is used to clear a drain blockage?)", image: "https://placehold.co/300x200/E0F2FE/3B82F6?text=Drain+Auger", options: [{ text: "ड्रेन औगर (Drain Auger/Plunger)", correct: true }, { text: "हथौड़ा (Hammer)", correct: false }, { text: "पेंचकस (Screwdriver)", correct: false }, { text: "आरी (Saw)", correct: false }]}
        ];
        let currentQuizQuestions = [];
        let currentQuestionIndex = 0;
        let score = 0;
        let correctAnswers = 0;
        let coinsThisQuiz = 0; 
        let timeLeft = 60; 
        let timerInterval;
        let selectedNumOfQuestions = 0;
        let lifelines = { fiftyFiftyUsed: false, audiencePollUsed: false };

        triggerQuizButton.addEventListener('click', () => {
            if (!currentUserData.isLoggedIn || !currentUserData.isFirebaseUser) { 
                openAuthModal();
                return;
            }
            console.log("Triggering quiz button");
            quizModalEl.classList.remove('hidden');
            setTimeout(() => quizModalEl.classList.add('active'), 10);
            document.body.style.overflow = 'hidden';
            showQuizScreen('setup');
        });

        function closeQuizModal() {
            quizModalEl.classList.remove('active');
            setTimeout(() => quizModalEl.classList.add('hidden'), 300);
            document.body.style.overflow = 'auto';
            if (timerInterval) clearInterval(timerInterval);
        }
        closeQuizSetupButton.addEventListener('click', closeQuizModal);
        closeQuizInterfaceButton.addEventListener('click', closeQuizModal);
        closeQuizResultsButton.addEventListener('click', closeQuizModal);

        numQuestionsButtons.forEach(button => {
            button.addEventListener('click', () => {
                selectedNumOfQuestions = parseInt(button.dataset.count);
                numQuestionsButtons.forEach(btn => btn.classList.remove('bg-green-500', 'text-white'));
                button.classList.add('bg-green-500', 'text-white');
                startSelectedQuizButton.disabled = false;
                startSelectedQuizButton.classList.remove('disabled:opacity-50');
            });
        });

        startSelectedQuizButton.addEventListener('click', () => {
            if (selectedNumOfQuestions > 0) {
                initializeQuiz();
                showQuizScreen('interface');
            }
        });
        
        function shuffleArray(array) { for (let i = array.length - 1; i > 0; i--) { const j = Math.floor(Math.random() * (i + 1)); [array[i], array[j]] = [array[j], array[i]]; } }

        function initializeQuiz() {
            currentQuizQuestions = [...allPlumbingQuestions];
            shuffleArray(currentQuizQuestions);
            currentQuizQuestions = currentQuizQuestions.slice(0, selectedNumOfQuestions);
            currentQuestionIndex = 0;
            score = 0;
            correctAnswers = 0;
            coinsThisQuiz = 0;
            lifelines = { fiftyFiftyUsed: false, audiencePollUsed: false };
            updateLifelineButtons();
        }

        function showQuizScreen(screenName) {
            quizSetupScreen.classList.add('hidden');
            quizInterfaceScreen.classList.add('hidden');
            quizResultsScreen.classList.add('hidden');

            if (screenName === 'setup') {
                quizSetupScreen.classList.remove('hidden');
                startSelectedQuizButton.disabled = true;
                startSelectedQuizButton.classList.add('disabled:opacity-50');
                numQuestionsButtons.forEach(btn => btn.classList.remove('bg-green-500', 'text-white'));
            } else if (screenName === 'interface') {
                quizInterfaceScreen.classList.remove('hidden');
                loadQuestion();
            } else if (screenName === 'results') {
                quizResultsScreen.classList.remove('hidden');
                finalScoreEl.textContent = `${score} / ${currentQuizQuestions.length * 10}`;
                correctAnswersCountEl.textContent = `${correctAnswers} / ${currentQuizQuestions.length}`;
                coinsThisQuiz = correctAnswers * 5; 
                coinsEarnedInQuizEl.textContent = coinsThisQuiz;
                updateUserCoins(coinsThisQuiz); // This will also update public leaderboard
            }
        }
        
        function loadQuestion() {
            if (currentQuestionIndex >= currentQuizQuestions.length) {
                showQuizScreen('results');
                return;
            }
            const question = currentQuizQuestions[currentQuestionIndex];
            currentQuestionNumberEl.textContent = currentQuestionIndex + 1;
            totalQuizQuestionsEl.textContent = currentQuizQuestions.length;
            questionTextQuizEl.textContent = question.text;

            if (question.image) {
                questionImageEl.src = question.image;
                questionImageContainer.classList.remove('hidden');
            } else {
                questionImageContainer.classList.add('hidden');
            }

            optionsContainer.innerHTML = '';
            const shuffledOptions = [...question.options];
            shuffleArray(shuffledOptions); 

            shuffledOptions.forEach(option => {
                const button = document.createElement('button');
                button.className = 'quiz-option block w-full text-left p-3 border-2 border-gray-300 rounded-lg hover:bg-blue-100 transition';
                button.textContent = option.text;
                button.onclick = () => handleAnswer(option.correct, button, Array.from(optionsContainer.children), option.text);
                optionsContainer.appendChild(button);
            });
            
            updateFavoriteQuestionButton(question.id);
            nextQuestionButton.classList.add('hidden');
            geminiQuizExplanationArea.style.display = 'none'; 
            geminiQuizExplanationArea.innerHTML = '';
            resetTimer();
            startTimer();
            audiencePollResultsEl.classList.add('hidden');
            optionsContainer.querySelectorAll('.quiz-option').forEach(opt => opt.classList.remove('disabled'));
        }

        function handleAnswer(isCorrect, selectedButton, allDisplayedOptions, selectedOptionText) {
            if (timerInterval) clearInterval(timerInterval);
            allDisplayedOptions.forEach(opt => {
                opt.classList.add('disabled'); 
                const originalOption = currentQuizQuestions[currentQuestionIndex].options.find(o => o.text === opt.textContent);
                if (originalOption) {
                    if (originalOption.correct) opt.classList.add('correct');
                    else if (opt === selectedButton) opt.classList.add('incorrect'); 
                }
            });

            if (isCorrect) {
                score += 10;
                correctAnswers++;
                if(selectedButton) { 
                    selectedButton.classList.remove('incorrect'); 
                    selectedButton.classList.add('correct');
                }
            } else {
                if(selectedButton) selectedButton.classList.add('incorrect');
            }
            
            const currentQuestion = currentQuizQuestions[currentQuestionIndex];
            getQuizExplanationFromGemini(currentQuestion, selectedOptionText, isCorrect);

            nextQuestionButton.classList.remove('hidden');
        }

        async function getQuizExplanationFromGemini(question, selectedOptionText, isCorrect) {
            geminiQuizExplanationLoader.classList.add('active');
            geminiQuizExplanationArea.style.display = 'none';
            geminiQuizExplanationArea.innerHTML = '';

            const correctAnswerText = question.options.find(opt => opt.correct).text;
            let prompt;
            if (isCorrect) {
                prompt = `The question is: "${question.text}". The user correctly chose: "${selectedOptionText}". Please explain why this answer is correct in the context of plumbing. Provide the explanation in simple Hindi.`;
            } else {
                prompt = `The question is: "${question.text}". The user incorrectly chose: "${selectedOptionText}". The correct answer is: "${correctAnswerText}". Please explain why the user's answer was wrong and why the correct answer ("${correctAnswerText}") is correct, in the context of plumbing. Provide the explanation in simple Hindi.`;
            }
            
            await callGeminiAPI(prompt, geminiQuizExplanationLoader, geminiQuizExplanationArea, true);
        }


        nextQuestionButton.addEventListener('click', () => {
            currentQuestionIndex++;
            loadQuestion();
        });

        function startTimer() {
            timeLeft = 60;
            quizTimerEl.textContent = `01:00`;
            questionTimerBar.style.width = '100%';
            questionTimerBar.style.backgroundColor = '#3B82F6'; 

            timerInterval = setInterval(() => {
                timeLeft--;
                const minutes = Math.floor(timeLeft / 60);
                const seconds = timeLeft % 60;
                quizTimerEl.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                questionTimerBar.style.width = `${(timeLeft / 60) * 100}%`;

                if (timeLeft <= 10 && timeLeft > 5) questionTimerBar.style.backgroundColor = '#F59E0B'; 
                else if (timeLeft <= 5) questionTimerBar.style.backgroundColor = '#EF4444'; 

                if (timeLeft <= 0) {
                    clearInterval(timerInterval);
                    quizTimerEl.textContent = "00:00";
                    const firstOptionText = currentQuizQuestions[currentQuestionIndex].options[0].text; 
                    handleAnswer(false, null, Array.from(optionsContainer.children), firstOptionText); 
                }
            }, 1000);
        }
        function resetTimer() { if (timerInterval) clearInterval(timerInterval); }

        lifeline5050Button.addEventListener('click', () => {
            if (lifelines.fiftyFiftyUsed || !optionsContainer.children.length) return;
            const question = currentQuizQuestions[currentQuestionIndex];
            let incorrectOptions = Array.from(optionsContainer.children).filter(btn => {
                const optText = btn.textContent;
                return !question.options.find(o => o.text === optText && o.correct);
            });
            shuffleArray(incorrectOptions);
            for (let i = 0; i < 2 && incorrectOptions.length > 0; i++) {
                if(incorrectOptions[i]) incorrectOptions[i].classList.add('hidden');
            }
            lifelines.fiftyFiftyUsed = true;
            updateLifelineButtons();
        });

        lifelineAudiencePollButton.addEventListener('click', () => {
            if (lifelines.audiencePollUsed || !optionsContainer.children.length) return;
            audiencePollResultsEl.innerHTML = '';
            const question = currentQuizQuestions[currentQuestionIndex];
            const options = Array.from(optionsContainer.children).filter(opt => !opt.classList.contains('hidden')); 
            
            let totalVotes = 0;
            const votes = options.map(opt => {
                const originalOption = question.options.find(o => o.text === opt.textContent);
                let votePercent = Math.floor(Math.random() * 30) + 5; 
                if (originalOption && originalOption.correct) {
                    votePercent += Math.floor(Math.random() * 40) + 20; 
                }
                totalVotes += votePercent;
                return { text: opt.textContent, percent: votePercent };
            });

            votes.forEach(vote => {
                const barDiv = document.createElement('div');
                barDiv.className = 'flex items-center justify-between text-sm';
                const normalizedPercent = totalVotes > 0 ? Math.round((vote.percent / totalVotes) * 100) : 0;
                barDiv.innerHTML = `
                    <span>${vote.text}</span>
                    <div class="w-3/5 bg-gray-200 rounded-full h-4 dark:bg-gray-700">
                        <div class="audience-poll-bar h-4 rounded-full text-xs text-white text-center leading-4" style="width: ${normalizedPercent}%">${normalizedPercent}%</div>
                    </div>`;
                audiencePollResultsEl.appendChild(barDiv);
            });

            audiencePollResultsEl.classList.remove('hidden');
            lifelines.audiencePollUsed = true;
            updateLifelineButtons();
        });

        function updateLifelineButtons() {
            lifeline5050Button.disabled = lifelines.fiftyFiftyUsed;
            lifelineAudiencePollButton.disabled = lifelines.audiencePollUsed;
            if(lifelines.fiftyFiftyUsed) lifeline5050Button.classList.add('disabled'); else lifeline5050Button.classList.remove('disabled');
            if(lifelines.audiencePollUsed) lifelineAudiencePollButton.classList.add('disabled'); else lifelineAudiencePollButton.classList.remove('disabled');
        }
        playAgainButton.addEventListener('click', () => { showQuizScreen('setup'); });

        favoriteQuestionButton.addEventListener('click', () => {
            if (!currentUserData.isLoggedIn || !currentUserData.isFirebaseUser || !currentQuizQuestions[currentQuestionIndex]) return;
            const question = currentQuizQuestions[currentQuestionIndex];
            toggleFavoriteQuestion(question);
        });

        async function toggleFavoriteQuestion(question) {
            const questionId = question.id;
            let currentFavorites = Array.isArray(currentUserData.favoriteQuestions) ? currentUserData.favoriteQuestions : [];
            const isFavorited = currentFavorites.some(fav => fav.id === questionId);
            
            if (isFavorited) {
                currentUserData.favoriteQuestions = currentFavorites.filter(fav => fav.id !== questionId);
            } else {
                currentUserData.favoriteQuestions = [...currentFavorites, { id: question.id, text: question.text, image: question.image }];
            }
            updateFavoriteQuestionButton(questionId); 
            if (currentUserData.userId) { 
                await saveUserDataToFirestore(currentUserData.userId, { favoriteQuestions: currentUserData.favoriteQuestions });
            }
        }


        function updateFavoriteQuestionButton(questionId) {
            if (!currentUserData.isLoggedIn || !currentUserData.isFirebaseUser) {
                 favoriteQuestionButton.innerHTML = '<i class="far fa-star"></i>'; 
                 favoriteQuestionButton.classList.remove('favorited'); return;
            }
            const currentFavorites = Array.isArray(currentUserData.favoriteQuestions) ? currentUserData.favoriteQuestions : [];
            const isFavorited = currentFavorites.some(fav => fav.id === questionId);
            favoriteQuestionButton.innerHTML = isFavorited ? '<i class="fas fa-star"></i>' : '<i class="far fa-star"></i>';
            if(isFavorited) favoriteQuestionButton.classList.add('favorited'); else favoriteQuestionButton.classList.remove('favorited');
        }
        
        function updateFavoriteQuestionIcons() { 
            if (quizInterfaceScreen.style.display !== 'hidden' && currentQuizQuestions.length > 0 && currentQuizQuestions[currentQuestionIndex]) {
                updateFavoriteQuestionButton(currentQuizQuestions[currentQuestionIndex].id);
            }
        }

        sidebarFavoriteQuestionLink.addEventListener('click', (e) => {
            e.preventDefault();
            if (!currentUserData.isLoggedIn || !currentUserData.isFirebaseUser) { openAuthModal(); return; }
            
            favoriteQuestionsListEl.innerHTML = ''; 
            const currentFavorites = Array.isArray(currentUserData.favoriteQuestions) ? currentUserData.favoriteQuestions : [];

            if (currentFavorites.length === 0) {
                favoriteQuestionsListEl.innerHTML = '<p class="text-center text-gray-500">No favorite questions saved.</p>';
            } else {
                currentFavorites.forEach(favQuestion => {
                    const div = document.createElement('div');
                    div.className = 'p-3 border rounded-md bg-blue-50 shadow-sm';
                    div.innerHTML = `<h4 class="font-semibold text-blue-700">${favQuestion.text}</h4> 
                                     ${favQuestion.image ? `<img src="${favQuestion.image}" alt="Fav Q Img" class="max-w-xs h-auto my-2 rounded">` : ''}
                                     <button data-id="${favQuestion.id}" class="remove-favorite-btn mt-2 text-xs text-red-500 hover:text-red-700">Remove</button>`;
                    favoriteQuestionsListEl.appendChild(div);
                });
                document.querySelectorAll('.remove-favorite-btn').forEach(btn => {
                    btn.addEventListener('click', async function() {
                        const idToRemove = this.dataset.id;
                        currentUserData.favoriteQuestions = (Array.isArray(currentUserData.favoriteQuestions) ? currentUserData.favoriteQuestions : []).filter(q => q.id !== idToRemove);
                        if (currentUserData.userId) { 
                            await saveUserDataToFirestore(currentUserData.userId, { favoriteQuestions: currentUserData.favoriteQuestions });
                        }
                        sidebarFavoriteQuestionLink.click(); 
                        updateFavoriteQuestionIcons(); 
                    });
                });
            }
            favoriteQuestionsModal.classList.remove('hidden');
            setTimeout(() => favoriteQuestionsModal.classList.add('active'), 10);
            document.body.style.overflow = 'hidden';
        });
        closeFavoriteQuestionsModalButton.addEventListener('click', () => {
            favoriteQuestionsModal.classList.remove('active');
            setTimeout(() => favoriteQuestionsModal.classList.add('hidden'), 300);
            document.body.style.overflow = 'auto';
        });

        sidebarRaiseComplaintLink.addEventListener('click', (e) => {
            e.preventDefault();
            complaintModal.classList.remove('hidden');
            setTimeout(() => complaintModal.classList.add('active'), 10);
            document.body.style.overflow = 'hidden';
        });
        closeComplaintModalButton.addEventListener('click', () => {
            complaintModal.classList.remove('active');
            setTimeout(() => complaintModal.classList.add('hidden'), 300);
            document.body.style.overflow = 'auto';
        });
        complaintForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const complaintText = document.getElementById('complaintText').value.trim();
            if (!complaintText) { alert("Please write your complaint."); return; } // Consider replacing alert with custom modal
            const subject = "Mock Test App Complaint/Feedback";
            const body = `User Email: ${currentUserData.email || (currentUserData.isFirebaseUser ? currentUserData.userId : 'Not Logged In')}\nUser ID: ${currentUserData.userId || 'N/A'}\n\nComplaint:\n${complaintText}`;
            const mailtoLink = `mailto:kidsfation@gmail.com?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
            window.location.href = mailtoLink;
            complaintForm.reset();
            closeComplaintModalButton.click();
        });

        const contentModalEl = document.getElementById('contentModal'); 
        const contentModalTitle = document.getElementById('contentModalTitle');
        const contentModalImageContainer = document.getElementById('contentModalImageContainer');
        const contentModalImage = document.getElementById('contentModalImage');
        const contentModalBody = document.getElementById('contentModalBody');
        const closeContentModalButton = document.getElementById('closeContentModalButton');
        
        const freeContentData = {
            "basic_concepts_en": { title: "Basic Plumbing Concepts", image: "https://placehold.co/300x150/E0F2FE/0284C7?text=Basic+Concepts", content: "<p>Water supply systems, drainage systems, types of pipes (PVC, CPVC, GI, Copper), common fittings and their uses.</p><p>Understanding pressure and flow.</p>" },
            "safety_symbols_en": { title: "Safety Symbols in Plumbing", image: "https://placehold.co/300x150/E0F2FE/0284C7?text=Safety+Symbols", content: "<p>Common safety signs: Danger, Warning, Caution. PPE symbols. Emergency shutdown symbols.</p>" },
            "measurement_tools_en": { title: "Measurement Tools", image: "https://placehold.co/300x150/E0F2FE/0284C7?text=Measuring+Tools", content: "<p>Measuring tapes, rulers, calipers, levels. How to use them accurately for pipe cutting and alignment.</p>" },
            "practice_drills_en": { title: "Practice Drills", image: "https://placehold.co/300x150/E0F2FE/0284C7?text=Drills", content: "<p>Simple exercises: Identify fittings, match tools to tasks, basic pipe joining techniques (conceptual).</p>" },
            "instructions_sidebar": { title: "Instructions (निर्देश)", image: "https://placehold.co/300x150/E0F2FE/1D4ED8?text=निर्देश", content: "<h3>Welcome to the ITI Plumber Mock Test App!</h3><p>This application is designed to help ITI Plumber trade students prepare for their exams.</p><ul><li>Practice with mock tests.</li><li>Learn about various plumbing tools and concepts.</li><li>Track your progress and compete with others using Firebase.</li><li>Use lifelines in quizzes to help you out.</li><li>Ask Gemini AI for explanations and advanced details.</li></ul><p><strong>This application is developed by Suleiman ITI Topper.</strong></p><p>We hope this app helps you succeed in your studies!</p>" }
        };
        const premiumContentData = {
            "handwritten_notes_hi": { title: "प्लंबिंग हस्तलिखित नोट्स (PDF)", image: "https://placehold.co/300x150/FEF3C7/D97706?text=हस्तलिखित+नोट्स", content: "<p>विस्तृत हस्तलिखित नोट्स विभिन्न प्लंबिंग विषयों पर।</p><p>पानी की आपूर्ति, जल निकासी व्यवस्था, पाइप फिटिंग, सुरक्षा सावधानियां।</p><p><strong>(यह सुविधा जल्द ही उपलब्ध होगी - PDF अपलोड किए जाएंगे।)</strong></p>" },
            "theory_hi": { title: "प्लंबिंग थ्योरी (सिद्धांत)", image: "https://placehold.co/300x150/FEF3C7/D97706?text=थ्योरी", content: "<p>प्लंबिंग के महत्वपूर्ण सिद्धांत और अवधारणाएं।</p><p>द्रव यांत्रिकी के मूल सिद्धांत, विभिन्न प्रकार के वाल्व और उनके कार्य।</p>" },
            "mock_test_hi": { title: "प्लंबिंग मॉक टेस्ट (PDF)", image: "https://placehold.co/300x150/FEF3C7/D97706?text=मॉक+टेस्ट", content: "<p>परीक्षा पैटर्न पर आधारित मॉक टेस्ट।</p><p>समय प्रबंधन और प्रश्न हल करने का अभ्यास करें।</p><p><strong>(यह सुविधा जल्द ही उपलब्ध होगी - PDF आधारित मॉक टेस्ट जोड़े जाएंगे।)</strong></p>" },
            "test_preparation_hi": { title: "परीक्षा की तैयारी (1000 MCQ)", image: "https://placehold.co/300x150/FEF3C7/D97706?text=1000+MCQ", content: "<p>परीक्षा में सफलता के लिए महत्वपूर्ण टिप्स और रणनीतियाँ।</p><p>इस सेक्शन में जल्द ही 1000+ महत्वपूर्ण बहुविकल्पीय प्रश्न (MCQ) जोड़े जाएंगे।</p>" },
            "file_making_hi": { title: "प्रैक्टिकल फाइल मेकिंग (Images)", image: "https://placehold.co/300x150/FEF3C7/D97706?text=फाइल+मेकिंग", content: "<p>आईटीआई प्रैक्टिकल फाइल बनाने के लिए मार्गदर्शन।</p><p>आवश्यक चित्र और प्रक्रियाएं।</p><p><strong>(यह सुविधा जल्द ही उपलब्ध होगी - प्रैक्टिकल फाइल से संबंधित चित्र अपलोड किए जाएंगे।)</strong></p>" },
            "tools_detail_hi": { title: "प्लंबिंग उपकरण विवरण (AI)", image: "https://placehold.co/300x150/FEF3C7/D97706?text=उपकरण+AI", content: "<p>विभिन्न प्लंबिंग उपकरणों का विस्तृत विवरण और उनके उपयोग।</p><p>पाइप रिंच, कटर, थ्रेडिंग मशीन, आदि। AI द्वारा उत्पन्न उन्नत विवरण के लिए बटन का उपयोग करें।</p>" }
        };

        const pdfNotesData = {
            title: "Free PDF Notes & Books (फ्री पीडीएफ नोट्स और किताबें)",
            notes: [
                { id: "pdf1", title: "What is File (रेती) (Hindi)", description: "A hand file is a hardened steel tool used for cutting and shaping materials like metal, wood, plastic, and more.", link: "https://drive.google.com/file/d/1t2foqazXsCL83R46mwbB6haWcrQjvMMQ/view?usp=drivesdk" },
                { id: "pdf2", title:  "HACKSAW FRAME WIDTH BLADE (HINDI)", description: "हैकसॉ फ्रेम, जिन्हें ब्लेड होल्डर भी कहा जाता है, में आमतौर पर एक एर्गोनॉमिक हैंडल (उदाहरण के लिए, पिस्टल ग्रिप) होता है और नए ब्लेड लगाने के लिए पिन भी लगे होते हैं", link: "https://drive.google.com/file/d/1t9k3-iTw2jw7L84Z8X3JDRKpgqfUS995/view?usp=drivesdk" },
                { id: "pdf3", title: "Engineering Drawing for Plumbers (English)", description: "Essential engineering drawing concepts for the trade.", link: "https://drive.google.com/file/d/1t2foqazXsCL83R46mwbB6haWcrQjvMMQ/view?usp=drivesdk" },
                { id: "pdf4", title: "Employability Skills Notes (Hindi)", description: "Improve your employability skills with these notes.", link: "https://drive.google.com/file/d/1t2foqazXsCL83R46mwbB6haWcrQjvMMQ/view?usp=drivesdk" },
                { id: "pdf5", title: "Employability Skills Notes (Hindi)", description: "Improve your employability skills with these notes.", link: "https://drive.google.com/file/d/1t2foqazXsCL83R46mwbB6haWcrQjvMMQ/view?usp=drivesdk" },
                { id: "pdf6", title: "What is File (रेती) (Hindi)", description: "A hand file is a hardened steel tool used for cutting and shaping materials like metal, wood, plastic, and more.", link: "https://drive.google.com/file/d/1t2foqazXsCL83R46mwbB6haWcrQjvMMQ/view?usp=drivesdk" }
               
            ]
        };

        const allToolsData = {
            "hand_tools": {
                name: "Hand Tools (हस्त उपकरण)",
                icon: "fas fa-tools",
                subcategories: {
                    "wrenches": { name: "Wrenches (रिंच)", items: [ { name: "Pipe Wrench (पाइप रिंच)", desc: "Used for gripping and turning pipes." }, { name: "Adjustable Wrench (समायोज्य रिंच)", desc: "Versatile for different nut/bolt sizes." } ] },
                    "cutters": { name: "Cutters (कटर)", items: [ { name: "PVC Pipe Cutter (पीवीसी पाइप कटर)", desc: "For clean cuts on PVC pipes." }, { name: "Hacksaw (हैकसॉ)", desc: "For cutting metal pipes." } ] }
                    
                }
            },
            "power_tools": {
                name: "Power Tools (शक्ति उपकरण)",
                icon: "fas fa-bolt",
                subcategories: {
                    "drills": { name: "Drills (ड्रिल)", items: [ { name: "Cordless Drill (ताररहित ड्रिल)", desc: "For drilling holes and driving screws." } ] },
                    "threading_machines": { name: "Threading Machines (थ्रेडिंग मशीन)", items: [ { name: "Pipe Threading Machine (पाइप थ्रेडिंग मशीन)", desc: "For creating threads on pipes." } ] }
                }
            },
             "safety_equipment": {
                name: "Safety Equipment (सुरक्षा उपकरण)",
                icon: "fas fa-hard-hat",
                subcategories: {
                    "personal_ppe": { name: "Personal Protective Equipment (व्यक्तिगत सुरक्षा उपकरण)", items: [ { name: "Safety Glasses (सुरक्षा चश्मा)", desc: "Protect eyes from debris." }, { name: "Gloves (दस्ताने)", desc: "Protect hands from cuts and chemicals." }, { name: "Hard Hat (हार्ड हैट)", desc: "Protect head from falling objects." } ] }
                }
            }
        };
        
        const allToolsContainer = document.getElementById('allToolsContainer');

        function renderAllTools() {
            allToolsContainer.innerHTML = ''; 
            for (const categoryKey in allToolsData) {
                const category = allToolsData[categoryKey];
                const categoryDiv = document.createElement('div');
                categoryDiv.className = 'mb-3 border border-gray-200 rounded-lg shadow-sm';

                const header = document.createElement('div');
                header.className = 'tool-category-header bg-gray-100 p-3 flex justify-between items-center rounded-t-lg';
                header.innerHTML = `
                    <h4 class="font-semibold text-gray-700 flex items-center">
                        <i class="${category.icon} mr-2 text-blue-500"></i> ${category.name}
                    </h4>
                    <i class="fas fa-chevron-down text-gray-500 transform transition-transform"></i>`;
                
                const listContainer = document.createElement('div');
                listContainer.className = 'tool-list-container bg-white p-3 rounded-b-lg';

                for (const subCategoryKey in category.subcategories) {
                    const subCategory = category.subcategories[subCategoryKey];
                    const subCatHeader = document.createElement('div');
                    subCatHeader.className = 'tool-subcategory-header p-2 my-1 bg-blue-50 rounded flex justify-between items-center';
                    subCatHeader.innerHTML = `
                        <h5 class="font-medium text-blue-700">${subCategory.name}</h5>
                        <i class="fas fa-plus text-blue-400 transform transition-transform text-sm"></i>`;
                    
                    const subCatItemsContainer = document.createElement('div');
                    subCatItemsContainer.className = 'tool-subcategory-container pl-2 border-l-2 border-blue-200 ml-1';

                    subCategory.items.forEach(item => {
                        const itemDiv = document.createElement('div');
                        itemDiv.className = 'tool-item p-2 hover:bg-blue-50 rounded cursor-pointer';
                        itemDiv.textContent = item.name;
                        itemDiv.onclick = () => openContentModalGeneric(item.name, false, true, item);
                        subCatItemsContainer.appendChild(itemDiv);
                    });
                    
                    subCatHeader.onclick = (e) => {
                        e.stopPropagation(); 
                        subCatItemsContainer.classList.toggle('open');
                        subCatHeader.querySelector('i').classList.toggle('fa-plus');
                        subCatHeader.querySelector('i').classList.toggle('fa-minus');
                    };
                    listContainer.appendChild(subCatHeader);
                    listContainer.appendChild(subCatItemsContainer);
                }
                
                header.onclick = () => {
                    listContainer.classList.toggle('open');
                    const icon = header.querySelector('i.fas');
                    icon.classList.toggle('fa-chevron-down');
                    icon.classList.toggle('fa-chevron-up');
                };

                categoryDiv.appendChild(header);
                categoryDiv.appendChild(listContainer);
                allToolsContainer.appendChild(categoryDiv);
            }
        }
        
        function openContentModalGeneric(contentKey, isPremium = false, isTool = false, toolData = null, isInstruction = false) {
            let data;
            currentToolForGemini = null; 
            geminiToolInfoArea.style.display = 'none'; 
            geminiToolInfoArea.innerHTML = '';
            getAdvancedToolInfoButton.classList.add('hidden');


            if (isTool && toolData) {
                data = { title: toolData.name, content: `<p>${toolData.desc}</p>`, image: `https://placehold.co/300x150/E0F2FE/0284C7?text=${encodeURIComponent(toolData.name.substring(0,15))}` };
                currentToolForGemini = toolData; 
                getAdvancedToolInfoButton.classList.remove('hidden'); 
            } else if (isInstruction) {
                 data = freeContentData[contentKey];
            }
            else {
                data = isPremium ? premiumContentData[contentKey] : freeContentData[contentKey];
            }

            if (!data) { console.error("Content not found for key:", contentKey); return; }

            contentModalTitle.textContent = data.title;
            contentModalBody.innerHTML = data.content; 
            if (data.image) {
                contentModalImage.src = data.image;
                contentModalImageContainer.classList.remove('hidden');
            } else {
                contentModalImageContainer.classList.add('hidden');
            }
            contentModalEl.classList.remove('hidden');
            setTimeout(() => contentModalEl.classList.add('active'), 10);
            document.body.style.overflow = 'hidden';
        }
        
        function openPdfNotesModal() {
            contentModalTitle.textContent = pdfNotesData.title;
            
            const notesListHtml = pdfNotesData.notes.map(note => `
                <div class="p-3 mb-2 border rounded-md bg-gray-50 hover:bg-gray-100 transition cursor-pointer">
                    <h4 class="font-semibold text-blue-800">${note.title}</h4>
                    <p class="text-sm text-gray-600">${note.description}</p>
                    <a href="${note.link}" target="_blank" class="text-sm text-green-600 font-semibold mt-2 inline-block">View/Download (देखें/डाउनलोड करें) <i class="fas fa-external-link-alt ml-1"></i></a>
                </div>
            `).join('');

            contentModalBody.innerHTML = `<div class="space-y-3">${notesListHtml}</div><p class="mt-4 text-xs text-center text-gray-500">Note: Download links are placeholders. (नोट: डाउनलोड लिंक प्लेसहोल्डर हैं।)</p>`;
            
            contentModalImageContainer.classList.add('hidden');
            getAdvancedToolInfoButton.classList.add('hidden');
            geminiToolInfoArea.style.display = 'none';

            contentModalEl.classList.remove('hidden');
            setTimeout(() => contentModalEl.classList.add('active'), 10);
            document.body.style.overflow = 'hidden';
        }

        document.querySelectorAll('#freePlumberEnglishSubCardsContainer .free-sub-card').forEach(card => {
            card.addEventListener('click', () => openContentModalGeneric(card.dataset.subtest, false, false));
        });

        sidebarInstructionLink.addEventListener('click', (e) => {
            e.preventDefault();
            openContentModalGeneric('instructions_sidebar', false, false, null, true);
            if (sidebar.classList.contains('open')) { toggleSidebar(); }
        });
        
        closeContentModalButton.addEventListener('click', () => {
            contentModalEl.classList.remove('active');
            setTimeout(() => contentModalEl.classList.add('hidden'), 300);
            document.body.style.overflow = 'auto';
        });
        contentModalEl.addEventListener('click', (event) => { 
            if (event.target === contentModalEl) { closeContentModalButton.click(); }
        });

        // --- Gemini API Integration ---
        async function callGeminiAPI(promptText, loaderElement, answerElement, isQuizExplanation = false) {
            if (!promptText) {
                answerElement.textContent = "Please enter a question or provide content for Gemini.";
                answerElement.style.display = 'block';
                return;
            }

            loaderElement.classList.add('active');
            answerElement.style.display = 'none';
            answerElement.textContent = '';

            const payload = {
                contents: [{ role: "user", parts: [{ text: promptText }] }]
            };
            
            const controller = new AbortController();
            const timeoutId = setTimeout(() => {
                controller.abort();
                console.warn("Gemini API call timed out after 8 seconds.");
            }, 8000); // 8-second timeout

            try {
                const response = await fetch(GEMINI_API_URL_TEXT, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload),
                    signal: controller.signal
                });
                
                clearTimeout(timeoutId);

                if (!response.ok) {
                    const errorResult = await response.json();
                    console.error('Gemini API Error:', errorResult);
                    throw new Error(`Gemini API request failed: ${errorResult.error?.message || response.statusText}`);
                }

                const result = await response.json();

                if (result.candidates && result.candidates.length > 0 &&
                    result.candidates[0].content && result.candidates[0].content.parts &&
                    result.candidates[0].content.parts.length > 0) {
                    const text = result.candidates[0].content.parts[0].text;
                    let htmlText = text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>'); 
                    htmlText = htmlText.replace(/\n/g, '<br>'); 
                    answerElement.innerHTML = htmlText;
                } else {
                    answerElement.textContent = "Sorry, I couldn't get a response from Gemini. (माफ़ कीजिए, मुझे Gemini से कोई जवाब नहीं मिला।)";
                    console.warn("Unexpected Gemini API response structure:", result);
                }
            } catch (error) {
                clearTimeout(timeoutId);
                console.error('Error calling Gemini API:', error);
                if (error.name === 'AbortError') {
                    answerElement.textContent = "The AI is taking too long to respond. Please try again. (AI जवाब देने में अधिक समय ले रहा है। कृपया पुनः प्रयास करें।)";
                } else {
                    answerElement.textContent = `Error: ${error.message}. Check console for details. (त्रुटि: ${error.message}) Konsol dekhen.`;
                }
            } finally {
                loaderElement.classList.remove('active');
                answerElement.style.display = 'block';
            }
        }

        askGeminiButton.addEventListener('click', () => {
            const userQuestion = userGeminiQuestionInput.value.trim();
            const prompt = `You are a helpful assistant for ITI Plumber trade students in India. Answer the following plumbing-related question clearly and concisely, in simple Hindi if possible, otherwise in English: "${userQuestion}"`;
            callGeminiAPI(prompt, geminiQALoader, geminiAnswerArea);
        });
        
        getAdvancedToolInfoButton.addEventListener('click', () => {
            if (currentToolForGemini) {
                const toolName = currentToolForGemini.name;
                const toolDesc = currentToolForGemini.desc;
                const prompt = `You are a helpful assistant for ITI Plumber trade students in India. Provide advanced details for the plumbing tool: "${toolName}". Its basic description is: "${toolDesc}". Include common problems encountered with this tool, safety precautions, and any advanced usage tips. Provide the answer in simple Hindi if possible, otherwise in English. Format the response with headings for 'Common Problems', 'Safety Precautions', and 'Advanced Usage Tips'.`;
                callGeminiAPI(prompt, geminiToolInfoLoader, geminiToolInfoArea);
            }
        });

        // --- Authentication State Listener & Initial Sign-in ---
        async function initializeAuthAndListeners() {
            if (!window.firebaseAuth || !window.firebaseSDKLoaded) { 
                console.error("Firebase Auth or SDK not available for initializeAuthAndListeners.");
                currentUserData = { userId: crypto.randomUUID(), displayName: "Guest (Auth Init Error)", email: null, coins: 0, premiumAccess: {}, favoriteQuestions: [], isLoggedIn: false, isFirebaseUser: false };
                updateUIAfterAuthChange();
                return;
            }
            const { onAuthStateChanged, signInAnonymously, signInWithCustomToken } = window.firebaseSDKLoaded;

            onAuthStateChanged(window.firebaseAuth, async (user) => {
                if (user) {
                    console.log("Auth state changed: User is signed in.", user);
                    const uid = user.uid;
                    let userDataFromDb = await loadUserDataFromFirestore(uid);

                    if (userDataFromDb) {
                        currentUserData = {
                            ...userDataFromDb, 
                            userId: uid,    
                            email: user.email || userDataFromDb.email, 
                            displayName: user.displayName || userDataFromDb.displayName || "User " + uid.substring(0,5), 
                            isLoggedIn: true,
                            isFirebaseUser: true,
                        };
                        if (typeof currentUserData.coins === 'undefined') currentUserData.coins = 0;
                        if (typeof currentUserData.premiumAccess === 'undefined') currentUserData.premiumAccess = {};
                        if (!Array.isArray(currentUserData.favoriteQuestions)) currentUserData.favoriteQuestions = [];

                    } else {
                        const newUserDisplayName = user.isAnonymous ? "Guest " + uid.substring(0, 5) : (user.email ? user.email.split('@')[0] : "User " + uid.substring(0, 5));
                        currentUserData = {
                            userId: uid,
                            displayName: user.displayName || newUserDisplayName,
                            email: user.email, 
                            coins: user.isAnonymous ? 0 : 100, 
                            premiumAccess: {},
                            favoriteQuestions: [],
                            isLoggedIn: true,
                            isFirebaseUser: true,
                        };
                        // Save new user's private profile
                        await saveUserDataToFirestore(uid, {
                            displayName: currentUserData.displayName,
                            email: currentUserData.email,
                            coins: currentUserData.coins,
                            premiumAccess: currentUserData.premiumAccess,
                            favoriteQuestions: currentUserData.favoriteQuestions,
                        });
                        // Also create/update their public leaderboard entry
                        await updateUserPublicLeaderboard(uid, currentUserData.displayName, currentUserData.coins);
                    }
                } else {
                    console.log("Auth state changed: User is signed out.");
                    currentUserData = { userId: crypto.randomUUID(), displayName: "Guest", email: null, coins: 0, premiumAccess: {}, favoriteQuestions: [], isLoggedIn: false, isFirebaseUser: false };
                }
                updateUIAfterAuthChange(); 
            });

            try {
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    console.log("Attempting to sign in with custom token...");
                    await signInWithCustomToken(window.firebaseAuth, __initial_auth_token);
                    console.log("Signed in with custom token.");
                } else if (!window.firebaseAuth.currentUser) { 
                    console.log("No custom token and no current user, attempting to sign in anonymously...");
                    await signInAnonymously(window.firebaseAuth);
                    console.log("Signed in anonymously.");
                } else {
                    console.log("User already signed in or custom token flow handled by onAuthStateChanged.");
                }
            } catch (error) {
                console.error("Error during initial sign-in:", error);
                if (!window.firebaseAuth.currentUser) { 
                    try {
                        console.warn("Initial sign-in failed, retrying anonymous sign-in...");
                        await signInAnonymously(window.firebaseAuth);
                        console.log("Signed in anonymously after initial failure.");
                    } catch (anonError) {
                        console.error("Error signing in anonymously after initial failure:", anonError);
                    }
                }
            }
        }


        // --- Initial Setup on DOMContentLoaded ---
        document.addEventListener('DOMContentLoaded', () => {
            console.log("DOM fully loaded and parsed");

            function attemptFirebaseSetup() {
                if (window.firebaseSDKLoaded) {
                    console.log("Firebase SDK is loaded. Proceeding with Firebase app initialization.");
                    if (initFirebaseApp()) { 
                        initializeAuthAndListeners();
                    } else {
                        console.error("Firebase App initialization failed. Auth listeners not set up.");
                        currentUserData = { userId: crypto.randomUUID(), displayName: "Guest (FB Init Error)", email: null, coins: 0, premiumAccess: {}, favoriteQuestions: [], isLoggedIn: false, isFirebaseUser: false };
                        updateUIAfterAuthChange();
                    }
                } else {
                    console.warn("Firebase SDK not yet loaded from module. Retrying in 100ms...");
                    setTimeout(attemptFirebaseSetup, 100); 
                }
            }

            attemptFirebaseSetup(); 

            renderAllTools();
            displayRandomImportantQuestion();
            document.getElementById('viewPdfNotesButton').addEventListener('click', openPdfNotesModal);
            
            // Event listener for the new height chart toggle
            heightChartToggle.addEventListener('click', () => {
                heightChartContainer.classList.toggle('open');
                const icon = heightChartToggle.querySelector('i.fas');
                icon.classList.toggle('fa-chevron-down');
                icon.classList.toggle('fa-chevron-up');
            });

            // Event listener for the new "Test" button in footer
            footerTestButton.addEventListener('click', () => {
                importantQuestionsListContainer.innerHTML = ''; // Clear previous list
                if (importantQuestions.length > 0) {
                    importantQuestions.forEach(qna => {
                        const itemDiv = document.createElement('div');
                        itemDiv.className = 'p-3 border-b border-gray-200';
                        itemDiv.innerHTML = `
                            <h4 class="font-semibold text-gray-800">${qna.q}</h4>
                            <p class="text-sm text-gray-600 mt-1">${qna.a}</p>
                        `;
                        importantQuestionsListContainer.appendChild(itemDiv);
                    });
                } else {
                    importantQuestionsListContainer.innerHTML = '<p class="text-center text-gray-500">No important questions found.</p>';
                }
                importantQuestionsListModal.classList.remove('hidden');
                setTimeout(() => importantQuestionsListModal.classList.add('active'), 10);
                document.body.style.overflow = 'hidden';
            });
            
            closeImportantQuestionsListModalButton.addEventListener('click', () => {
                importantQuestionsListModal.classList.remove('active');
                setTimeout(() => importantQuestionsListModal.classList.add('hidden'), 300);
                document.body.style.overflow = 'auto';
            });

        });

    
// Aapko yeh JavaScript code apne main <script> tag ke andar copy karna hai

        document.addEventListener('DOMContentLoaded', function() {
            const slider = document.getElementById('bannerSlider');
            if (!slider) return; // Agar slider मौजूद नहीं है तो code na chalaye

            const items = slider.querySelectorAll('.banner-item');
            const dotsContainer = document.getElementById('bannerDots');
            let currentItem = 0;
            let slideInterval;

            // Har item ke liye ek dot banayein
            items.forEach((item, index) => {
                const dot = document.createElement('span');
                dot.classList.add('dot');
                if (index === 0) dot.classList.add('active');
                dot.addEventListener('click', () => {
                    showItem(index);
                    resetInterval();
                });
                dotsContainer.appendChild(dot);
            });

            const dots = dotsContainer.querySelectorAll('.dot');

            function showItem(index) {
                // Sabhi items aur dots se 'active' class hatayein
                items.forEach(item => item.classList.remove('active'));
                dots.forEach(dot => dot.classList.remove('active'));

                // Naye item aur dot par 'active' class lagayein
                items[index].classList.add('active');
                dots[index].classList.add('active');
                currentItem = index;
            }

            function nextItem() {
                let next = (currentItem + 1) % items.length;
                showItem(next);
            }

            function startInterval() {
                slideInterval = setInterval(nextItem, 4000); // Har 4 second mein change karein
            }

            function resetInterval() {
                clearInterval(slideInterval);
                startInterval();
            }

            // Slider shuru karein
            startInterval();
        });

             document.addEventListener('DOMContentLoaded', () => {
    const onboardingOverlay = document.getElementById('threeStepOnboardingOverlay');
    const nextBtn = document.getElementById('threeStepNextBtn');
    const images = [
        document.getElementById('onboardingImage1'),
        document.getElementById('onboardingImage2'),
        document.getElementById('onboardingImage3')
    ];

    if (!onboardingOverlay || !nextBtn || images.some(img => !img)) {
        console.error("Onboarding elements not found in the DOM.");
        return;
    }

    // Check localStorage to see if the user has completed onboarding
    if (localStorage.getItem('threeStepOnboardingCompleted') === 'true') {
        onboardingOverlay.style.display = 'none';
        return;
    }

    // If not completed, show the overlay
    onboardingOverlay.style.display = 'block';
    document.body.style.overflow = 'hidden'; // Prevent scrolling main content

    let currentStep = 0;

    const finishOnboarding = () => {
        onboardingOverlay.style.opacity = '0';
        setTimeout(() => {
            onboardingOverlay.style.display = 'none';
            document.body.style.overflow = 'auto';
        }, 500); // Match CSS transition duration
        localStorage.setItem('threeStepOnboardingCompleted', 'true');
    };

    nextBtn.addEventListener('click', () => {
        // Hide current image
        images[currentStep].classList.remove('active');

        // Move to the next step
        currentStep++;

        if (currentStep < images.length) {
            // Show next image
            images[currentStep].classList.add('active');
            
            // Change button text on the last step
            if (currentStep === images.length - 1) {
                nextBtn.innerHTML = 'Get Started &rarr;';
            }
        } else {
            // Onboarding is finished
            finishOnboarding();
        }
    });
});




        document.addEventListener('DOMContentLoaded', () => {
            // --- DATA for images ---
            // Har image ke liye ek unique 'id' add kiya gaya hai
            const imageData = [
                {
                    id: 'pipe-wrench',
                    thumbnailSrc: 'https://placehold.co/400x400/1e3a8a/ffffff?text=Thumbnail+1',
                    fullscreenSrc: 'https://placehold.co/900x1600/1e3a8a/ffffff?text=Pipe+Wrench+Diagram',
                    title: 'पाइप रिंच आरेख'
                },
                {
                    id: 'pvc-pipes',
                    thumbnailSrc: 'https://placehold.co/400x400/374151/ffffff?text=Thumbnail+2',
                    fullscreenSrc: 'https://placehold.co/900x1600/374151/ffffff?text=PVC+Pipe+Types',
                    title: 'पीवीसी पाइप के प्रकार'
                },
                {
                    id: 'safety-symbols',
                    thumbnailSrc: 'https://placehold.co/400x400/be123c/ffffff?text=Thumbnail+3',
                    fullscreenSrc: 'https://placehold.co/900x1600/be123c/ffffff?text=Safety+Symbols',
                    title: 'सुरक्षा संकेत'
                },
                {
                    id: 'water-meter',
                    thumbnailSrc: 'https://placehold.co/400x400/047857/ffffff?text=Thumbnail+4',
                    fullscreenSrc: 'https://placehold.co/900x1600/047857/ffffff?text=Water+Meter+Setup',
                    title: 'पानी मीटर सेटअप'
                },
                {
                    id: 'drainage-system',
                    thumbnailSrc: 'https://placehold.co/400x400/7c2d12/ffffff?text=Thumbnail+5',
                    fullscreenSrc: 'https://placehold.co/900x1600/7c2d12/ffffff?text=Drainage+System',
                    title: 'जल निकासी प्रणाली'
                },
                {
                    id: 'geyser-install',
                    thumbnailSrc: 'https://placehold.co/400x400/4a044e/ffffff?text=Thumbnail+6',
                    fullscreenSrc: 'https://placehold.co/900x1600/4a044e/ffffff?text=Geyser+Installation',
                    title: 'गीजर इंस्टॉलेशन'
                }
            ];
            // --- DOM Elements ---
            const galleryHeader = document.getElementById('gallery-header');
            const galleryContainer = document.getElementById('image-gallery-container');
            const gallery = document.getElementById('image-gallery');
            const toggleIcon = document.getElementById('toggle-icon');
            const toggleText = document.getElementById('toggle-text');
            
            const modal = document.getElementById('image-modal');
            const fullscreenImage = document.getElementById('fullscreen-image');
            const closeModalBtn = document.getElementById('close-modal-btn');
            // --- LocalStorage Logic for View Count ---
            const STORAGE_KEY = 'imageGalleryViews';
            function getImageViews() {
                const views = localStorage.getItem(STORAGE_KEY);
                try {
                    return views ? JSON.parse(views) : {};
                } catch (e) {
                    console.error("Could not parse image views from localStorage", e);
                    return {};
                }
            }
            function incrementImageView(imageId) {
                const views = getImageViews();
                views[imageId] = (views[imageId] || 0) + 1;
                localStorage.setItem(STORAGE_KEY, JSON.stringify(views));
            }
            // --- Function to create and populate the gallery ---
            function populateGallery() {
                if (!gallery) return;
                const views = getImageViews();
                // View count ko data me add karein aur sort karein
                const sortedImageData = imageData
                    .map(image => ({
                        ...image,
                        views: views[image.id] || 0
                    }))
                    .sort((a, b) => b.views - a.views);
                gallery.innerHTML = ''; 
                sortedImageData.forEach(image => {
                    const itemDiv = document.createElement('div');
                    itemDiv.className = 'gallery-item cursor-pointer group';
                    itemDiv.setAttribute('data-full-src', image.fullscreenSrc);
                    itemDiv.setAttribute('data-image-id', image.id); // ID ko store karein
                    const imageWrapper = document.createElement('div');
                    // position-relative add karein taki badge sahi se position ho
                    imageWrapper.className = 'relative aspect-square bg-gray-200 rounded-lg overflow-hidden shadow-md border-2 border-transparent group-hover:border-sky-500 transition-all';
                    const img = document.createElement('img');
                    img.src = image.thumbnailSrc;
                    img.alt = image.title;
                    img.className = 'w-full h-full object-cover group-hover:scale-110 transition-transform duration-300';
                    img.loading = 'lazy';
                    // View count ke liye badge banayein
                    const viewBadge = document.createElement('div');
                    viewBadge.className = 'absolute top-2 right-2 bg-black bg-opacity-60 text-white text-xs font-bold px-2 py-1 rounded-full flex items-center pointer-events-none';
                    viewBadge.innerHTML = `<i class="fas fa-eye mr-1.5"></i> ${image.views}`;
                    
                    const titleP = document.createElement('p');
                    titleP.className = 'text-center text-sm font-medium text-gray-700 mt-2 truncate';
                    titleP.textContent = image.title;
                    imageWrapper.appendChild(img);
                    imageWrapper.appendChild(viewBadge); // Badge ko image wrapper me add karein
                    itemDiv.appendChild(imageWrapper);
                    itemDiv.appendChild(titleP);
                    gallery.appendChild(itemDiv);
                });
            }
            // --- Function to toggle the gallery visibility ---
            function toggleGallery() {
                galleryContainer.classList.toggle('open');
                const isOpen = galleryContainer.classList.contains('open');
                
                toggleIcon.style.transform = isOpen ? 'rotate(180deg)' : 'rotate(0deg)';
                toggleText.textContent = isOpen ? 'Hide' : 'Show';
            }
            // --- Event Listeners ---
            galleryHeader.addEventListener('click', toggleGallery);
            // --- Modal Logic ---
            function openModal(src, imageId) {
                if (!modal || !fullscreenImage) return;
                
                // View count badhayein aur gallery ko re-render karein
                incrementImageView(imageId);
                populateGallery(); 
                fullscreenImage.src = src;
                modal.classList.remove('hidden');
                document.body.style.overflow = 'hidden';
            }
            function closeModal() {
                if (!modal) return;
                modal.classList.add('hidden');
                document.body.style.overflow = 'auto';
            }
            gallery.addEventListener('click', (e) => {
                const item = e.target.closest('.gallery-item');
                if (item) {
                    const fullSrc = item.getAttribute('data-full-src');
                    const imageId = item.getAttribute('data-image-id');
                    if (fullSrc && imageId) {
                        openModal(fullSrc, imageId);
                    }
                }
            });
            closeModalBtn.addEventListener('click', closeModal);
            modal.addEventListener('click', (e) => {
                if (e.target === modal) closeModal();
            });
            // --- Initial Call ---
            populateGallery();
        });
            
    </script>

</body>
</html>
