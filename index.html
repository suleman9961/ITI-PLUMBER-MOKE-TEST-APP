<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mock Test Ncn - Google Sheets & Gemini Features</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #E0F2FE; /* Light blue background */
            padding-bottom: 80px; /* Footer padding */
            overflow-x: hidden;
        }
        .premium-tag { background-color: #FFA726; color: black; }
        .free-tag { background-color: #66BB6A; color: white; }
        .start-now-button-original-style { background-color: #EC4899; } /* गुलाबी रंग */
        .plumber-tag { background-color: #FFCA28; color: #374151; } /* पीला रंग */
        .card-icon-placeholder { width: 50px; height: 50px; background-color: #E5E7EB; border-radius: 0.375rem; display: flex; align-items: center; justify-content: center; font-size: 0.75rem; color: #6B7280; flex-shrink: 0; }
        .practice-button { background-color: #3B82F6; } /* नीला रंग */
        .social-icon { width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; border-radius: 0.5rem; }
        .sidebar { transition: transform 0.3s ease-in-out; transform: translateX(-100%); }
        .sidebar.open { transform: translateX(0); }
        .sidebar-overlay { transition: opacity 0.3s ease-in-out; }
        .auth-modal, .quiz-modal, .content-modal-container, .confirmation-modal, .top-scorer-modal, .favorite-questions-modal, .complaint-modal, .share-modal { background-color: rgba(0, 0, 0, 0.75); transition: opacity 0.3s ease-in-out, visibility 0.3s ease-in-out; }
        .auth-modal-content, .quiz-modal-content, .content-modal-content, .confirmation-modal-content, .top-scorer-modal-content, .favorite-questions-modal-content, .complaint-modal-content, .share-modal-content { max-height: 90vh; transition: transform 0.3s ease-out, opacity 0.3s ease-out; transform: translateY(-20px) scale(0.95); opacity: 0; }
        .auth-modal.active,
        .quiz-modal.active,
        .content-modal-container.active,
        .confirmation-modal.active,
        .top-scorer-modal.active,
        .favorite-questions-modal.active,
        .complaint-modal.active,
        .share-modal.active {
            opacity: 1;
            visibility: visible;
        }
        .auth-modal.active .auth-modal-content,
        .quiz-modal.active .quiz-modal-content,
        .content-modal-container.active .content-modal-content,
        .confirmation-modal.active .confirmation-modal-content,
        .top-scorer-modal.active .top-scorer-modal-content,
        .favorite-questions-modal.active .favorite-questions-modal-content,
        .complaint-modal.active .complaint-modal-content,
        .share-modal.active .share-modal-content { transform: translateY(0) scale(1); opacity: 1; }

        .quiz-option { transition: background-color 0.2s ease, border-color 0.2s ease; }
        .quiz-option:hover { background-color: #d1e5fb; border-color: #3B82F6; }
        .quiz-option.selected { background-color: #3B82F6; color: white; border-color: #2563EB; }
        .quiz-option.correct { background-color: #10B981; color: white; border-color: #059669; }
        .quiz-option.incorrect { background-color: #EF4444; color: white; border-color: #DC2626; }
        .quiz-option.disabled { opacity: 0.5; pointer-events: none; }
        .lifeline-btn.disabled { opacity: 0.4; cursor: not-allowed; background-color: #9CA3AF !important; }
        .timer-bar { height: 8px; background-color: #3B82F6; transition: width 1s linear; width: 100%; }
        .audience-poll-bar { background-color: #3B82F6; transition: width 0.5s ease-out; }
        .coin-icon { width: 20px; height: 20px; margin-left: 5px; vertical-align: middle; }
        .sub-card-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 0.75rem; /* gap-3 */
            margin-top: 0.75rem; /* mt-3 */
        }
        .sub-card {
            padding: 0.75rem; /* p-3 */
            border-radius: 0.375rem; /* rounded-md */
            text-align: left;
            transition: background-color 0.2s ease;
            cursor: pointer;
        }
        .premium-sub-card {
            background-color: #4A5568; /* bg-slate-700 */
            color: white;
        }
        .premium-sub-card:hover {
            background-color: #2D3748; /* bg-slate-800 or darker */
        }
        .premium-sub-card.disabled {
            background-color: #718096; /* Lighter slate for disabled */
            color: #A0AEC0;
            cursor: not-allowed;
            opacity: 0.7;
        }
        .free-sub-card {
            background-color: #EBF8FF; /* bg-blue-50 */
            color: #2B6CB0; /* text-blue-700 */
            border: 1px solid #BEE3F8; /* border-blue-200 */
        }
        .free-sub-card:hover {
            background-color: #C3DAFE; /* bg-blue-200 */
        }
        .tab-button.active {
            border-bottom-color: #3B82F6; /* blue-600 */
            color: #3B82F6; /* blue-600 */
            font-weight: 600;
        }
        .error-message {
            color: #EF4444; /* text-red-500 */
            font-size: 0.875rem; /* text-sm */
            margin-top: 0.25rem; /* mt-1 */
        }
        .tool-category-header, .tool-subcategory-header {
            cursor: pointer;
            transition: background-color 0.2s ease;
        }
        .tool-category-header:hover, .tool-subcategory-header:hover {
            background-color: #e2e8f0; /* Tailwind gray-200 */
        }
        .tool-item {
            transition: background-color 0.2s ease;
        }
        .tool-item:hover {
            background-color: #f0f9ff; /* Tailwind sky-50 */
        }
        .tool-list-container, .tool-subcategory-container {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out;
        }
        .tool-list-container.open, .tool-subcategory-container.open {
            max-height: 1000px; /* जरूरत के अनुसार समायोजित करें */
        }
        .content-modal-tool-detail {
            margin-bottom: 0.75rem; /* mb-3 */
            padding: 0.75rem; /* p-3 */
            background-color: #f9fafb; /* bg-gray-50 */
            border-left: 4px solid #3b82f6; /* border-blue-500 */
            border-radius: 0.25rem; /* rounded-sm */
        }
        .content-modal-tool-detail strong {
            color: #1d4ed8; /* text-blue-700 */
        }
        .favorite-btn {
            background: none; border: none; cursor: pointer;
            color: #cbd5e1; /* Tailwind gray-300 */
            transition: color 0.2s;
        }
        .favorite-btn:hover { color: #f59e0b; /* Tailwind amber-500 */ }
        .favorite-btn.favorited { color: #fbbf24; /* Tailwind amber-400 */ }

        .whatsapp-share-button {
            background-color: #25D366;
            color: white;
            padding: 10px 15px;
            border-radius: 8px;
            text-decoration: none;
            font-weight: 500;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            transition: background-color 0.2s;
        }
        .whatsapp-share-button:hover { background-color: #1DAE50; }

        .auth-modal, .quiz-modal, .content-modal-container, .confirmation-modal, .top-scorer-modal, .favorite-questions-modal, .complaint-modal, .share-modal {
            display: none; 
            opacity: 0;
            visibility: hidden;
        }
        .auth-modal.active, .quiz-modal.active, .content-modal-container.active, .confirmation-modal.active, .top-scorer-modal.active, .favorite-questions-modal.active, .complaint-modal.active, .share-modal.active {
            display: flex; 
            opacity: 1;
            visibility: visible;
        }
        .gemini-loader {
            display: none; /* Hidden by default */
            align-items: center;
            justify-content: center;
            padding: 0.5rem;
            font-size: 0.875rem; /* text-sm */
            color: #1d4ed8; /* text-blue-700 */
        }
        .gemini-loader.active {
            display: flex;
        }
        .gemini-spinner {
            width: 1rem; /* w-4 */
            height: 1rem; /* h-4 */
            border-width: 2px;
            border-style: solid;
            border-color: currentColor;
            border-right-color: transparent;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 0.5rem; /* mr-2 */
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .quiz-ai-explanation {
            margin-top: 1rem; /* mt-4 */
            padding: 0.75rem; /* p-3 */
            background-color: #f3f4f6; /* bg-gray-100 */
            border-left: 4px solid #60a5fa; /* border-blue-400 */
            border-radius: 0.25rem; /* rounded-sm */
            font-size: 0.875rem; /* text-sm */
            color: #374151; /* text-gray-700 */
        }
    </style>
</head>
<body>

    <!-- Sidebar -->
    <div id="sidebar" class="sidebar fixed top-0 left-0 h-full w-64 sm:w-72 bg-slate-800 text-white z-[60] shadow-lg p-0 flex flex-col">
        <div class="bg-blue-600 p-4 flex items-center space-x-3">
            <img src="https://placehold.co/40x40/FFFFFF/3B82F6?text=Logo" alt="Logo" class="w-10 h-10 rounded-md bg-white p-1">
            <div>
                <h2 class="text-lg font-semibold">Mock Test</h2>
                <p class="text-sm text-blue-200">NcvtOnline</p>
            </div>
        </div>
        <nav class="flex-grow pt-4 space-y-1 overflow-y-auto">
            <a href="#" id="sidebarProfileLink" class="flex items-center px-4 py-3 text-sm text-slate-200 hover:bg-slate-700 rounded-md mx-2">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5 mr-3">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 6a3.75 3.75 0 1 1-7.5 0 3.75 3.75 0 0 1 7.5 0ZM4.501 20.118a7.5 7.5 0 0 1 14.998 0A17.933 17.933 0 0 1 12 21.75c-2.676 0-5.216-.584-7.499-1.632Z" />
                </svg> Profile (प्रोफ़ाइल)
            </a>
            <a href="#" id="sidebarTopScorerLink" class="flex items-center px-4 py-3 text-sm text-slate-200 hover:bg-slate-700 rounded-md mx-2">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5 mr-3">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M3 13.125C3 12.504 3.504 12 4.125 12h2.25c.621 0 1.125.504 1.125 1.125v6.75C7.5 20.496 6.996 21 6.375 21h-2.25A1.125 1.125 0 0 1 3 19.875v-6.75ZM9.75 8.625c0-.621.504-1.125 1.125-1.125h2.25c.621 0 1.125.504 1.125 1.125v11.25c0 .621-.504 1.125-1.125 1.125h-2.25a1.125 1.125 0 0 1-1.125-1.125V8.625ZM16.5 4.125c0-.621.504-1.125 1.125-1.125h2.25C20.496 3 21 3.504 21 4.125v15.75c0 .621-.504 1.125-1.125 1.125h-2.25a1.125 1.125 0 0 1-1.125-1.125V4.125Z" />
                </svg> Top Scorer (शीर्ष स्कोरर)
            </a>
             <a href="#" class="flex items-center px-4 py-3 text-sm text-slate-200 hover:bg-slate-700 rounded-md mx-2">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5 mr-3">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M2.25 18 9 11.25l4.306 4.306a11.95 11.95 0 0 1 5.814-5.518l2.74-1.22m0 0-5.94-2.281m5.94 2.28-2.28 5.941" />
                </svg> Statistics (सांख्यिकी)
            </a>
            <a href="#" class="flex items-center px-4 py-3 text-sm text-slate-200 hover:bg-slate-700 rounded-md mx-2">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5 mr-3">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M14.857 17.082a23.848 23.848 0 0 0 5.454-1.31A8.967 8.967 0 0 1 18 9.75V9A6 6 0 0 0 6 9v.75a8.967 8.967 0 0 1-2.312 6.022c1.733.64 3.56 1.085 5.455 1.31m5.714 0a24.255 24.255 0 0 1-5.714 0m5.714 0a3 3 0 1 1-5.714 0" />
                </svg> Notification (अधिसूचना)
            </a>
            <a href="#" id="sidebarFavoriteQuestionLink" class="flex items-center px-4 py-3 text-sm text-slate-200 hover:bg-slate-700 rounded-md mx-2">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5 mr-3">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M17.593 3.322c1.1.128 1.907 1.077 1.907 2.185V21L12 17.5 4.5 21V5.507c0-1.108.806-2.057 1.907-2.185a48.507 48.507 0 0 1 11.186 0Z" />
                </svg> Favorite Question (पसंदीदा प्रश्न)
            </a>
            <a href="#" id="sidebarInviteFriendsLink" class="flex items-center px-4 py-3 text-sm text-slate-200 hover:bg-slate-700 rounded-md mx-2">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5 mr-3">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M18 7.5v3m0 0v3m0-3h3m-3 0h-3m-2.25-4.125a3.375 3.375 0 1 1-6.75 0 3.375 3.375 0 0 1 6.75 0ZM3 19.235v-.11a6.375 6.375 0 0 1 12.75 0v.109A12.318 12.318 0 0 1 9.374 21c-2.331 0-4.512-.645-6.374-1.766Z" />
                </svg> Invite friends (दोस्तों को आमंत्रित करें)
            </a>
            <a href="#" id="sidebarRaiseComplaintLink" class="flex items-center px-4 py-3 text-sm text-slate-200 hover:bg-slate-700 rounded-md mx-2">
                 <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5 mr-3">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M21.75 6.75v10.5a2.25 2.25 0 0 1-2.25 2.25h-15a2.25 2.25 0 0 1-2.25-2.25V6.75m19.5 0A2.25 2.25 0 0 0 19.5 4.5h-15a2.25 2.25 0 0 0-2.25 2.25m19.5 0v.243a2.25 2.25 0 0 1-1.07 1.916l-7.5 4.615a2.25 2.25 0 0 1-2.36 0L3.32 8.91a2.25 2.25 0 0 1-1.07-1.916V6.75" />
                </svg> Raise Complaint (शिकायत दर्ज करें)
            </a>
            <a href="#" id="sidebarInstructionLink" class="flex items-center px-4 py-3 text-sm text-slate-200 hover:bg-slate-700 rounded-md mx-2">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5 mr-3">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M3.75 6.75h16.5M3.75 12h16.5m-16.5 5.25H12" />
                </svg> Instruction (निर्देश)
            </a>
             <a href="#" id="sidebarLogoutLink" class="flex items-center px-4 py-3 text-sm text-slate-200 hover:bg-slate-700 rounded-md mx-2 mt-auto mb-2 hidden">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5 mr-3">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 9V5.25A2.25 2.25 0 0 0 13.5 3h-6a2.25 2.25 0 0 0-2.25 2.25v13.5A2.25 2.25 0 0 0 7.5 21h6a2.25 2.25 0 0 0 2.25-2.25V15m3 0h3m0 0-3-3m3 3-3 3" />
                </svg> Logout (लॉग आउट)
            </a>
        </nav>
    </div>
    <div id="sidebarOverlay" class="sidebar-overlay fixed inset-0 bg-black bg-opacity-50 z-50 hidden"></div>

    <!-- Header -->
    <header class="bg-blue-600 text-white p-4 shadow-md sticky top-0 z-40">
        <div class="container mx-auto flex items-center justify-between">
            <button id="hamburgerButton" aria-label="Open menu" class="p-1 -ml-1">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-7 h-7">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M3.75 6.75h16.5M3.75 12h16.5m-16.5 5.25h16.5" />
                </svg>
            </button>
            <h1 class="text-xl font-semibold">Mock Test Ncn</h1>
            <div class="flex items-center space-x-3">
                <a id="whatsappShareHeader" href="#" target="_blank" class="whatsapp-share-button text-sm p-2">
                    <i class="fab fa-whatsapp"></i> Share
                </a>
                <button id="headerUserIcon" aria-label="User profile or Login/Signup" class="focus:outline-none">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-7 h-7">
                      <path stroke-linecap="round" stroke-linejoin="round" d="M17.982 18.725A7.488 7.488 0 0 0 12 15.75a7.488 7.488 0 0 0-5.982 2.975m11.963 0a9 9 0 1 0-11.963 0m11.963 0A8.966 8.966 0 0 1 12 21a8.966 8.966 0 0 1-5.982-2.275M15 9.75a3 3 0 1 1-6 0 3 3 0 0 1 6 0Z" />
                    </svg>
                </button>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <div class="container mx-auto p-4">
        <!-- Loading Overlay -->
        <div id="loadingOverlay" class="fixed inset-0 bg-white bg-opacity-75 flex items-center justify-center z-[200]" style="display: none;">
            <div class="animate-spin rounded-full h-16 w-16 border-t-4 border-b-4 border-blue-500"></div>
            <p class="ml-3 text-blue-700 font-semibold">Loading data... (डेटा लोड हो रहा है...)</p>
        </div>

        <!-- User Profile Section -->
        <section class="bg-blue-500 text-white p-4 rounded-lg shadow-lg mt-1">
            <div class="flex items-center mb-2">
                <img id="userAvatarMain" src="https://placehold.co/60x60/FFFFFF/3B82F6?text=U" alt="User Avatar" class="w-12 h-12 rounded-full border-2 border-white mr-3">
                <div>
                    <h2 id="userNameMain" class="text-lg font-semibold">Guest User</h2>
                    <span id="userCoinsDisplay" class="ml-0 text-yellow-300 font-bold">(<span id="coinCount">0</span> 🪙)</span>
                    <div class="flex space-x-4 text-sm mt-1">
                        <span>ID: <span id="userIdDisplay" class="font-normal">N/A</span></span>
                    </div>
                </div>
            </div>
            <div class="mt-2 text-center">
                <span class="plumber-tag inline-block px-3 py-1 text-sm font-semibold rounded-md shadow">Plumber</span>
            </div>
        </section>

        <!-- Start Quiz Section -->
        <section class="bg-white p-5 rounded-lg shadow-lg mt-5">
            <div class="flex justify-between items-center">
                <h2 class="text-xl font-bold text-blue-700">Ncvt Online Learning</h2>
            </div>
            <button id="triggerQuizButton" class="start-now-button-original-style w-full text-white font-semibold py-3 px-4 rounded-lg mt-4 flex items-center justify-center text-lg hover:bg-pink-600 transition duration-150">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-6 h-6 mr-2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M5.25 5.653c0-.856.917-1.398 1.667-.986l11.54 6.347a1.125 1.125 0 0 1 0 1.972l-11.54 6.347a1.125 1.125 0 0 1-1.667-.986V5.653Z" />
                </svg>
                Start Now (Quiz) (अभी शुरू करें (क्विज))
            </button>
        </section>

        <!-- Mock Test Sections -->
        <section class="mt-6">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-semibold text-gray-800">All Mock Test For Your Trade (आपके ट्रेड के लिए सभी मॉक टेस्ट)</h3>
                <a href="#" class="text-blue-600 font-medium hover:underline text-sm">View All (सभी देखें)</a>
            </div>
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-5">
                <!-- Free Test Card -->
                <div id="freeTestCardPlumberEnglish" class="bg-white rounded-xl shadow-lg p-4 relative border-t-4 border-blue-500">
                    <span class="free-tag absolute top-3 right-3 px-2 py-1 text-xs font-semibold rounded">Free</span>
                    <div class="flex items-start space-x-3">
                        <div class="card-icon-placeholder">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-8 h-8 text-blue-500"><path stroke-linecap="round" stroke-linejoin="round" d="M12 6.042A8.967 8.967 0 0 0 6 3.75c-1.052 0-2.062.18-3 .512v14.25A8.987 8.987 0 0 1 6 18c2.305 0 4.408.867 6 2.292m0-14.25a8.966 8.966 0 0 1 6-2.292c1.052 0 2.062.18 3 .512v14.25A8.987 8.987 0 0 0 18 18a8.967 8.967 0 0 0-6-2.292m0 0V21M12 6.042A8.967 8.967 0 0 1 18 3.75m0 14.25V6.042" /></svg>
                        </div>
                        <div>
                            <h4 class="text-md font-bold text-gray-800">ITI Mock Test</h4>
                            <p class="text-sm text-gray-600 font-medium">Plumber All Subject</p>
                            <p class="text-xs text-gray-500">( English )</p>
                        </div>
                    </div>
                    <div class="mt-3 pt-3 border-t border-gray-200">
                        <p class="text-sm font-semibold text-blue-700 mb-2">Plumber - English Sections</p>
                        <div id="freePlumberEnglishSubCardsContainer" class="sub-card-grid">
                            <button class="sub-card free-sub-card" data-subtest="basic_concepts_en"><h5 class="font-semibold">Basic Concepts</h5><p class="text-xs">Learn fundamentals</p></button>
                            <button class="sub-card free-sub-card" data-subtest="safety_symbols_en"><h5 class="font-semibold">Safety Symbols</h5><p class="text-xs">Understand signs</p></button>
                            <button class="sub-card free-sub-card" data-subtest="measurement_tools_en"><h5 class="font-semibold">Measurement Tools</h5><p class="text-xs">Tool details</p></button>
                            <button class="sub-card free-sub-card" data-subtest="practice_drills_en"><h5 class="font-semibold">Practice Drills</h5><p class="text-xs">Quick exercises</p></button>
                        </div>
                    </div>
                </div>
                <!-- Premium Test Card -->
                <div id="premiumTestCardPlumberHindi" class="bg-slate-800 text-white rounded-xl shadow-lg p-4 relative border-t-4 border-yellow-400">
                     <span class="premium-tag absolute top-3 right-3 px-2 py-1 text-xs font-semibold rounded">Premium</span>
                     <div class="flex items-start space-x-3">
                        <div class="card-icon-placeholder bg-slate-700">
                             <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-8 h-8 text-yellow-400"><path stroke-linecap="round" stroke-linejoin="round" d="M16.5 10.5V6.75a4.5 4.5 0 1 0-9 0v3.75m-.75 11.25h10.5a2.25 2.25 0 0 0 2.25-2.25v-6.75a2.25 2.25 0 0 0-2.25-2.25H6.75a2.25 2.25 0 0 0-2.25 2.25v6.75a2.25 2.25 0 0 0 2.25 2.25Z" /></svg>
                        </div>
                        <div>
                            <h4 class="text-md font-bold text-white">ITI Mock Test (Premium Section)</h4>
                            <p class="text-sm text-slate-300 font-medium">प्लम्बर सभी विषय</p>
                            <p class="text-xs text-slate-400">( English | हिंदी )</p>
                        </div>
                    </div>
                    <div class="mt-3 pt-3 border-t border-slate-700">
                        <div id="premiumPlumberHindiStatus" class="mb-2 text-sm text-yellow-200">Loading status...</div>
                        <button id="unlockPremiumPlumberHindiButton" data-testid="premium_plumber_hindi" data-cost="500" class="mb-3 w-full bg-green-600 hover:bg-green-700 text-white font-semibold py-2 px-3 rounded-lg text-sm transition opacity-50 cursor-not-allowed" disabled>Check Status</button>
                        <div id="premiumPlumberHindiSubCardsContainer" class="sub-card-grid hidden">
                            <button class="sub-card premium-sub-card disabled" data-subtest="handwritten_notes_hi"><h5 class="font-semibold">हस्तलिखित नोट्स (PDF)</h5><p class="text-xs text-slate-400">विस्तृत नोट्स पढ़ें</p></button>
                            <button class="sub-card premium-sub-card disabled" data-subtest="theory_hi"><h5 class="font-semibold">थ्योरी</h5><p class="text-xs text-slate-400">अवधारणाएं समझें</p></button>
                            <button class="sub-card premium-sub-card disabled" data-subtest="mock_test_hi"><h5 class="font-semibold">मॉक टेस्ट (PDF)</h5><p class="text-xs text-slate-400">परीक्षा का अभ्यास करें</p></button>
                            <button class="sub-card premium-sub-card disabled" data-subtest="test_preparation_hi"><h5 class="font-semibold">टेस्ट तैयारी (1000 MCQ)</h5><p class="text-xs text-slate-400">रणनीतियाँ और सुझाव</p></button>
                            <button class="sub-card premium-sub-card disabled" data-subtest="file_making_hi"><h5 class="font-semibold">फाइल मेकिंग (Images)</h5><p class="text-xs text-slate-400">प्रैक्टिकल कार्य</p></button>
                            <button class="sub-card premium-sub-card disabled" data-subtest="tools_detail_hi"><h5 class="font-semibold">उपकरण विवरण (AI)</h5><p class="text-xs text-slate-400">उपकरणों की जानकारी</p></button>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- All Tools Section -->
        <section class="bg-white p-5 rounded-lg shadow-lg mt-6">
            <div class="flex items-center mb-4">
                <div class="card-icon-placeholder bg-cyan-100 mr-3"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-7 h-7 text-cyan-600"><path stroke-linecap="round" stroke-linejoin="round" d="M11.42 15.17 17.25 21A2.652 2.652 0 0 0 21 17.25l-5.83-5.83M11.42 15.17A3 3 0 0 1 6.344 12.74l-2.531-2.531a2.25 2.25 0 0 1 0-3.182l2.25-2.25a2.25 2.25 0 0 1 3.182 0l2.531 2.531S15 10.585 15 12.75a3 3 0 0 1-3.58 2.42Z" /></svg></div>
                <h3 class="text-lg font-semibold text-gray-800">All Tools (सभी उपकरण)</h3>
            </div>
            <div id="allToolsContainer" class="space-y-3">
                <!-- Tools will be rendered here by JavaScript -->
            </div>
        </section>

        <!-- Important Q&A Section -->
        <section class="bg-white p-5 rounded-lg shadow-lg mt-6">
            <div class="flex items-center mb-3">
                <div class="card-icon-placeholder bg-teal-100 mr-3">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-7 h-7 text-teal-500">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M9.879 7.519c1.171-1.025 3.071-1.025 4.242 0 1.172 1.025 1.172 2.687 0 3.712-.203.179-.43.326-.67.442-.745.361-1.45.999-1.45 1.827v.75M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Zm-9 5.25h.008v.008H12v-.008Z" />
                    </svg>
                </div>
                <h3 class="text-md font-semibold text-gray-800">अति महत्वपूर्ण प्रश्न और उत्तर (Very Important Q&A)</h3>
            </div>
            <button id="showRandomImpQuestionBtn" class="w-full bg-sky-500 hover:bg-sky-600 text-white font-semibold py-3 px-4 rounded-lg mt-2 flex items-center justify-center text-lg transition duration-150">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6 mr-2"><path stroke-linecap="round" stroke-linejoin="round" d="M19.5 12c0-1.232-.046-2.453-.138-3.662a4.006 4.006 0 0 0-3.7-3.7 48.678 48.678 0 0 0-7.324 0 4.006 4.006 0 0 0-3.7 3.7c-.092 1.21-.138 2.43-.138 3.662v1.515A2.25 2.25 0 0 0 5.25 15h13.5a2.25 2.25 0 0 0 2.25-2.25V12Zm-15-1.5a.75.75 0 0 0-.75.75V12a.75.75 0 0 0 .75.75h13.5a.75.75 0 0 0 .75-.75V11.25a.75.75 0 0 0-.75-.75H4.5Z" /></svg>
                अगला महत्वपूर्ण प्रश्न देखें (Show Next Important Question)
            </button>
            <div id="importantQuestionDisplayArea" class="mt-4 p-4 bg-gray-100 rounded-md min-h-[100px] text-gray-700" style="display: none;">
                <h4 id="importantQuestionText" class="font-semibold text-md mb-2"></h4>
                <p id="importantAnswerText" class="text-sm"></p>
            </div>

            <!-- Gemini Q&A Section -->
            <div class="mt-6 pt-4 border-t border-gray-200">
                <h3 class="text-md font-semibold text-gray-800 mb-2">✨ अपना सवाल Gemini से पूछें (Ask Gemini Your Question)</h3>
                <div class="flex flex-col sm:flex-row gap-2">
                    <input type="text" id="userGeminiQuestion" placeholder="अपना प्लंबिंग सवाल यहाँ लिखें..." class="flex-grow p-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                    <button id="askGeminiButton" class="bg-purple-600 hover:bg-purple-700 text-white font-semibold py-2 px-4 rounded-lg transition flex items-center justify-center">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5 mr-2"><path stroke-linecap="round" stroke-linejoin="round" d="M9.813 15.904L9 18.75l-.813-2.846a4.5 4.5 0 00-3.09-3.09L1.25 9l2.846-.813a4.5 4.5 0 003.09-3.09L9 1.25l.813 2.846a4.5 4.5 0 003.09 3.09L15.75 9l-2.846.813a4.5 4.5 0 00-3.09 3.09Z"M18.25 10.875L17.5 13.5l-.75-2.625a3.375 3.375 0 00-2.625-2.625L10.5 7.5l2.625-.75a3.375 3.375 0 002.625-2.625L17.5 1.5l.75 2.625a3.375 3.375 0 002.625 2.625L23.25 7.5l-2.625.75a3.375 3.375 0 00-2.625 2.625Z" /></svg>
                        पूछें (Ask)
                    </button>
                </div>
                <div id="geminiQALoader" class="gemini-loader mt-2">
                    <div class="gemini-spinner"></div>
                    Gemini से पूछा जा रहा है...
                </div>
                <div id="geminiAnswerArea" class="mt-3 p-3 bg-purple-50 border border-purple-200 rounded-md text-gray-700 text-sm" style="display: none;">
                    <!-- Gemini's answer will appear here -->
                </div>
            </div>
        </section>
    </div>

    <!-- Footer Navigation -->
    <footer class="fixed bottom-0 left-0 right-0 bg-white shadow-t-lg border-t border-gray-200 p-3 flex justify-around items-center z-40">
        <button class="flex flex-col items-center text-blue-600 hover:text-blue-800"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-7 h-7"><path stroke-linecap="round" stroke-linejoin="round" d="m2.25 12 8.954-8.955c.44-.439 1.152-.439 1.591 0L21.75 12M4.5 9.75v10.125c0 .621.504 1.125 1.125 1.125H9.75v-4.875c0-.621.504-1.125 1.125-1.125h2.25c.621 0 1.125.504 1.125 1.125V21h4.125c.621 0 1.125-.504 1.125-1.125V9.75M8.25 21h7.5" /></svg><span class="text-xs mt-1">Home</span></button>
        <button class="flex flex-col items-center text-gray-500 hover:text-blue-600"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-7 h-7"><path stroke-linecap="round" stroke-linejoin="round" d="M12 6.042A8.967 8.967 0 0 0 6 3.75c-1.052 0-2.062.18-3 .512v14.25A8.987 8.987 0 0 1 6 18c2.305 0 4.408.867 6 2.292m0-14.25a8.966 8.966 0 0 1 6-2.292c1.052 0 2.062.18 3 .512v14.25A8.987 8.987 0 0 0 18 18a8.967 8.967 0 0 0-6-2.292m0 0V21M12 6.042A8.967 8.967 0 0 1 18 3.75m0 14.25V6.042" /></svg><span class="text-xs mt-1">Tests</span></button>
        <button id="footerProfileButton" class="flex flex-col items-center text-gray-500 hover:text-blue-600"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-7 h-7"><path stroke-linecap="round" stroke-linejoin="round" d="M17.982 18.725A7.488 7.488 0 0 0 12 15.75a7.488 7.488 0 0 0-5.982 2.975m11.963 0a9 9 0 1 0-11.963 0m11.963 0A8.966 8.966 0 0 1 12 21a8.966 8.966 0 0 1-5.982-2.275M15 9.75a3 3 0 1 1-6 0 3 3 0 0 1 6 0Z" /></svg><span class="text-xs mt-1">Profile</span></button>
    </footer>

    <!-- Authentication Modal -->
    <div id="authModal" class="auth-modal fixed inset-0 z-[100] flex items-center justify-center p-4">
        <div class="auth-modal-content bg-slate-50 w-full max-w-md rounded-xl shadow-2xl p-6 overflow-y-auto">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold text-blue-700">Profile / Authentication (प्रोफ़ाइल / प्रमाणीकरण)</h2>
                <button id="closeAuthModalButton" class="text-gray-500 hover:text-gray-700">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-7 h-7"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg>
                </button>
            </div>
            <div id="authStatus" class="mb-4 p-3 bg-blue-100 text-blue-700 rounded-md text-sm hidden"></div>
            <div class="mb-4 border-b border-gray-200">
                <nav class="flex space-x-4" aria-label="Tabs">
                    <button id="loginTabButton" class="tab-button py-3 px-1 border-b-2 border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 text-sm font-medium active">Login (लॉग इन करें)</button>
                    <button id="signupTabButton" class="tab-button py-3 px-1 border-b-2 border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 text-sm font-medium">Signup (साइन अप करें)</button>
                </nav>
            </div>
            <form id="loginForm" class="space-y-4">
                <div><label for="loginEmail" class="block text-sm font-medium text-gray-700">Email (ईमेल)</label><input type="email" id="loginEmail" name="loginEmail" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm"></div>
                <div><label for="loginPassword" class="block text-sm font-medium text-gray-700">Password (पासवर्ड)</label><input type="password" id="loginPassword" name="loginPassword" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm"></div>
                <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-lg transition">Login</button>
                <p id="loginError" class="error-message hidden"></p>
            </form>
            <form id="signupForm" class="space-y-4 hidden">
                <div><label for="signupName" class="block text-sm font-medium text-gray-700">Full Name (पूरा नाम)</label><input type="text" id="signupName" name="signupName" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm"></div>
                <div><label for="signupEmail" class="block text-sm font-medium text-gray-700">Email (ईमेल)</label><input type="email" id="signupEmail" name="signupEmail" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm"></div>
                <div><label for="signupPassword" class="block text-sm font-medium text-gray-700">Password (पासवर्ड)</label><input type="password" id="signupPassword" name="signupPassword" required minlength="6" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm"></div>
                <button type="submit" class="w-full bg-green-500 hover:bg-green-600 text-white font-semibold py-2 px-4 rounded-lg transition">Signup</button>
                <p id="signupError" class="error-message hidden"></p>
            </form>
        </div>
    </div>

    <!-- Top Scorer Modal -->
    <div id="topScorerModal" class="top-scorer-modal fixed inset-0 z-[95] flex items-center justify-center p-4">
        <div class="top-scorer-modal-content bg-slate-50 w-11/12 max-w-2xl rounded-xl shadow-2xl p-6 overflow-y-auto">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold text-blue-700">🏆 Top Scorers (शीर्ष स्कोरर) 🏆</h2>
                <button id="closeTopScorerModalButton" class="text-gray-500 hover:text-gray-700">
                     <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-7 h-7"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg>
                </button>
            </div>
            <div id="topScorerList" class="space-y-3"></div>
            <p class="mt-6 text-sm text-gray-600 text-center">Note: Leaderboard data is fetched from Google Sheets. (लीडरबोर्ड डेटा गूगल शीट्स से प्राप्त किया जाता है।)</p>
        </div>
    </div>

    <!-- Quiz Modal -->
    <div id="quizModal" class="quiz-modal fixed inset-0 z-[70] flex items-center justify-center p-4">
        <div class="quiz-modal-content bg-slate-50 w-11/12 max-w-5xl rounded-xl shadow-2xl p-6 overflow-y-auto">
            <!-- Quiz Setup Screen -->
            <div id="quizSetupScreen">
                <h2 class="text-2xl font-bold text-center text-blue-700 mb-6">प्लंबिंग क्विज़ (Plumbing Quiz)</h2>
                <p class="text-center text-gray-700 mb-2">आप कितने प्रश्न हल करना चाहते हैं?</p>
                <div class="flex justify-center space-x-3 mb-6">
                    <button data-count="5" class="num-questions-btn bg-blue-500 hover:bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg transition">5 प्रश्न</button>
                    <button data-count="10" class="num-questions-btn bg-blue-500 hover:bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg transition">10 प्रश्न</button>
                    <button data-count="15" class="num-questions-btn bg-blue-500 hover:bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg transition">15 प्रश्न</button>
                </div>
                <p class="text-center text-xs text-gray-500 mb-4">प्रत्येक प्रश्न के लिए 1 मिनट का समय होगा।</p>
                <button id="startSelectedQuizButton" class="w-full bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-4 rounded-lg text-lg transition disabled:opacity-50" disabled>क्विज़ शुरू करें</button>
                <button id="closeQuizSetupButton" class="mt-3 w-full bg-gray-300 hover:bg-gray-400 text-gray-800 font-semibold py-2 px-4 rounded-lg transition">बंद करें</button>
            </div>
            <!-- Quiz Interface Screen -->
            <div id="quizInterfaceScreen" class="hidden">
                <div class="flex justify-between items-center mb-1">
                    <h2 class="text-xl font-bold text-blue-700">प्रश्न <span id="currentQuestionNumber"></span>/<span id="totalQuizQuestions"></span></h2>
                    <div class="flex items-center">
                        <button id="shareQuestionButton" class="mr-3 p-2 bg-yellow-400 hover:bg-yellow-500 text-white rounded-md text-xs"><i class="fas fa-share-alt mr-1"></i> Share Q</button>
                        <button id="favoriteQuestionButton" class="favorite-btn text-2xl"><i class="far fa-star"></i></button>
                        <div class="text-lg font-semibold text-red-500 ml-3">समय: <span id="quizTimer">01:00</span></div>
                    </div>
                </div>
                <div class="w-full bg-gray-300 rounded-full mb-4"><div id="questionTimerBar" class="timer-bar rounded-full"></div></div>
                <div id="questionImageContainer" class="mb-4 text-center hidden"><img id="questionImage" src="" alt="प्रश्न सम्बंधित चित्र" class="max-w-full h-auto max-h-60 sm:max-h-80 md:max-h-96 mx-auto rounded-lg shadow-md object-contain"></div>
                <p id="questionTextQuiz" class="text-lg sm:text-xl font-semibold text-gray-800 mb-5 min-h-[60px]"></p> 
                <div id="optionsContainer" class="space-y-3 mb-6"></div>
                
                <!-- AI Explanation Area -->
                <div id="geminiQuizExplanationLoader" class="gemini-loader mt-4">
                    <div class="gemini-spinner"></div>
                    AI से स्पष्टीकरण प्राप्त हो रहा है...
                </div>
                <div id="geminiQuizExplanationArea" class="quiz-ai-explanation" style="display: none;">
                    <!-- Gemini's quiz explanation will appear here -->
                </div>

                <div class="my-6"> <!-- Added margin-top and margin-bottom for spacing -->
                    <h3 class="text-md font-semibold text-gray-700 mb-2 text-center">लाइफलाइन (Lifelines):</h3>
                    <div class="flex justify-center space-x-2 sm:space-x-4">
                        <button id="lifeline5050" class="lifeline-btn bg-yellow-500 hover:bg-yellow-600 text-white font-semibold py-2 px-3 sm:px-4 rounded-lg flex items-center text-sm transition"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-5 h-5 mr-1 hidden sm:inline"><path stroke-linecap="round" stroke-linejoin="round" d="M12 6.75a.75.75 0 1 1 0-1.5.75.75 0 0 1 0 1.5ZM12 12.75a.75.75 0 1 1 0-1.5.75.75 0 0 1 0 1.5ZM12 18.75a.75.75 0 1 1 0-1.5.75.75 0 0 1 0 1.5Z" /></svg>50/50</button>
                        <button id="lifelineAudiencePoll" class="lifeline-btn bg-purple-500 hover:bg-purple-600 text-white font-semibold py-2 px-3 sm:px-4 rounded-lg flex items-center text-sm transition"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-5 h-5 mr-1 hidden sm:inline"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 6a3.75 3.75 0 1 1-7.5 0 3.75 3.75 0 0 1 7.5 0ZM4.501 20.118a7.5 7.5 0 0 1 14.998 0A17.933 17.933 0 0 1 12 21.75c-2.676 0-5.216-.584-7.499-1.632Z" /></svg>ऑडियंस पोल</button>
                    </div>
                </div>
                <div id="audiencePollResults" class="hidden mt-4 space-y-2"></div>
                <button id="nextQuestionButton" class="w-full bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-4 rounded-lg text-lg transition hidden">अगला प्रश्न</button>
                <button id="closeQuizInterfaceButton" class="mt-3 w-full bg-gray-300 hover:bg-gray-400 text-gray-800 font-semibold py-2 px-4 rounded-lg transition">क्विज़ बंद करें</button>
            </div>
            <!-- Quiz Results Screen -->
             <div id="quizResultsScreen" class="hidden text-center">
                <h2 class="text-3xl font-bold text-green-600 mb-4">क्विज़ समाप्त!</h2>
                <img src="https://placehold.co/100x100/E0F2FE/10B981?text=🏆" alt="Trophy" class="mx-auto mb-4 w-24 h-24">
                <p class="text-xl text-gray-800 mb-2">आपका स्कोर: <span id="finalScore"></span></p>
                <p class="text-lg text-gray-700 mb-2">सही उत्तर: <span id="correctAnswersCount"></span></p>
                <p class="text-lg text-gray-700 mb-6">आपने <span id="coinsEarnedInQuiz">0</span> सिक्के कमाए!</p>
                <div class="space-y-3 sm:space-y-0 sm:flex sm:space-x-4 justify-center">
                    <button id="playAgainButton" class="w-full sm:w-auto bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-6 rounded-lg text-lg transition">फिर से खेलें</button>
                    <button id="closeQuizResultsButton" class="w-full sm:w-auto bg-gray-500 hover:bg-gray-600 text-white font-semibold py-3 px-6 rounded-lg text-lg transition">बंद करें</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Confirmation Modal -->
    <div id="confirmationModal" class="confirmation-modal fixed inset-0 z-[80] flex items-center justify-center p-4">
        <div class="confirmation-modal-content bg-white w-full max-w-md rounded-xl shadow-2xl p-6">
            <h2 id="confirmationTitle" class="text-xl font-bold text-gray-800 mb-4">Confirm Purchase</h2>
            <p id="confirmationMessage" class="text-gray-700 mb-6">Are you sure?</p>
            <div class="flex justify-end space-x-3">
                <button id="cancelUnlockButton" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-semibold py-2 px-4 rounded-lg transition">Cancel</button>
                <button id="confirmUnlockButton" class="bg-green-500 hover:bg-green-600 text-white font-semibold py-2 px-4 rounded-lg transition">Confirm</button>
            </div>
        </div>
    </div>

    <!-- Content Modal (for free section items, tools, premium items, instructions) -->
    <div id="contentModal" class="content-modal-container fixed inset-0 z-[90] flex items-center justify-center p-4">
        <div class="content-modal-content bg-white w-11/12 max-w-4xl rounded-xl shadow-2xl p-6 overflow-y-auto">
            <div class="flex justify-between items-center mb-4">
                <h2 id="contentModalTitle" class="text-xl md:text-2xl font-bold text-blue-700">Content Title</h2>
                <button id="closeContentModalButton" class="text-gray-500 hover:text-gray-700">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-7 h-7"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg>
                </button>
            </div>
            <div id="contentModalImageContainer" class="mb-4 text-center hidden">
                <img id="contentModalImage" src="" alt="Content Image" class="max-w-full h-auto max-h-60 sm:max-h-80 md:max-h-96 mx-auto rounded-lg shadow-md object-contain">
            </div>
            <div id="contentModalBody" class="text-gray-700 space-y-2 text-sm sm:text-base md:text-lg">
                <!-- Content will be injected here -->
            </div>
            <button id="getAdvancedToolInfoButton" class="hidden mt-3 w-full bg-indigo-500 hover:bg-indigo-600 text-white font-semibold py-2 px-3 rounded-lg transition flex items-center justify-center text-sm">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5 mr-2"><path stroke-linecap="round" stroke-linejoin="round" d="M9.813 15.904L9 18.75l-.813-2.846a4.5 4.5 0 00-3.09-3.09L1.25 9l2.846-.813a4.5 4.5 0 003.09-3.09L9 1.25l.813 2.846a4.5 4.5 0 003.09 3.09L15.75 9l-2.846.813a4.5 4.5 0 00-3.09 3.09Z"M18.25 10.875L17.5 13.5l-.75-2.625a3.375 3.375 0 00-2.625-2.625L10.5 7.5l2.625-.75a3.375 3.375 0 002.625-2.625L17.5 1.5l.75 2.625a3.375 3.375 0 002.625 2.625L23.25 7.5l-2.625.75a3.375 3.375 0 00-2.625 2.625Z" /></svg>
                ✨ Get Advanced Details with Gemini
            </button>
            <div id="geminiToolInfoLoader" class="gemini-loader mt-2">
                <div class="gemini-spinner"></div>
                Gemini से पूछा जा रहा है...
            </div>
            <div id="geminiToolInfoArea" class="mt-2 p-2 bg-indigo-50 border border-indigo-200 rounded-md text-gray-700 text-xs" style="display: none;">
            </div>
            <button id="shareContentButton" class="mt-4 w-full bg-yellow-400 hover:bg-yellow-500 text-white font-semibold py-2 px-4 rounded-lg transition">
                <i class="fas fa-share-alt mr-2"></i> Share This Content (इस सामग्री को साझा करें)
            </button>
        </div>
    </div>

    <!-- Favorite Questions Modal -->
    <div id="favoriteQuestionsModal" class="favorite-questions-modal fixed inset-0 z-[90] flex items-center justify-center p-4">
        <div class="favorite-questions-modal-content bg-white w-11/12 max-w-3xl rounded-xl shadow-2xl p-6 overflow-y-auto">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold text-blue-700">पसंदीदा प्रश्न (Favorite Questions)</h2>
                <button id="closeFavoriteQuestionsModalButton" class="text-gray-500 hover:text-gray-700">
                     <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-7 h-7"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg>
                </button>
            </div>
            <div id="favoriteQuestionsList" class="space-y-4">
                <!-- Favorite questions will be listed here -->
            </div>
        </div>
    </div>

    <!-- Complaint Modal -->
    <div id="complaintModal" class="complaint-modal fixed inset-0 z-[90] flex items-center justify-center p-4">
        <div class="complaint-modal-content bg-white w-full max-w-lg rounded-xl shadow-2xl p-6">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold text-blue-700">अपनी शिकायत दर्ज करें (Raise Your Complaint)</h2>
                <button id="closeComplaintModalButton" class="text-gray-500 hover:text-gray-700">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-7 h-7"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg>
                </button>
            </div>
            <form id="complaintForm">
                <div class="mb-4">
                    <label for="complaintText" class="block text-sm font-medium text-gray-700 mb-1">आपकी समस्या/प्रश्न (Your Issue/Question):</label>
                    <textarea id="complaintText" name="complaintText" rows="5" required class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"></textarea>
                </div>
                <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-lg transition">शिकायत भेजें (Send Complaint)</button>
            </form>
        </div>
    </div>
    
    <!-- Share Modal -->
    <div id="shareModal" class="share-modal fixed inset-0 z-[110] flex items-center justify-center p-4">
        <div class="share-modal-content bg-white w-full max-w-sm rounded-xl shadow-2xl p-6 text-center">
            <h2 class="text-xl font-bold text-gray-800 mb-4">Share (साझा करें)</h2>
            <p id="shareModalText" class="text-gray-700 mb-4 break-all"></p>
            <div class="flex justify-center space-x-3">
                <button id="copyShareTextButton" class="bg-blue-500 hover:bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg transition">Copy Text (टेक्स्ट कॉपी करें)</button>
                <button id="closeShareModalButton" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-semibold py-2 px-4 rounded-lg transition">Close (बंद करें)</button>
            </div>
        </div>
    </div>


    <script>
        // --- Google Sheets Integration Placeholder ---
        const GOOGLE_SHEET_APP_URL = 'YOUR_GOOGLE_APPS_SCRIPT_WEB_APP_URL_HERE'; 
        // --- Gemini API Key Placeholder ---
        // API key is intentionally left blank. Canvas will provide it.
        const GEMINI_API_KEY = ""; // For models other than gemini-2.0-flash or imagen-3.0-generate-002
        const GEMINI_API_URL_TEXT = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${GEMINI_API_KEY}`;


        // --- Global User Data Store ---
        let currentUserData = {
            userId: null, 
            displayName: "Guest User",
            email: null,
            coins: 0,
            premiumAccess: {}, 
            favoriteQuestions: [], 
            isLoggedIn: false,
            isSheetUser: false 
        };
        const PRE_APPROVED_USER_EMAIL = "test@example.com";
        const PRE_APPROVED_USER_PASS = "test123";
        const PREMIUM_TEST_ID = "premium_plumber_hindi"; 
        const PREMIUM_TEST_COST = 500;


        // DOM Elements
        const userNameMainEl = document.getElementById('userNameMain');
        const userAvatarMainEl = document.getElementById('userAvatarMain');
        const userIdDisplayEl = document.getElementById('userIdDisplay');
        const coinCountEl = document.getElementById('coinCount');
        
        const authModal = document.getElementById('authModal');
        const closeAuthModalButton = document.getElementById('closeAuthModalButton');
        const loginTabButton = document.getElementById('loginTabButton');
        const signupTabButton = document.getElementById('signupTabButton');
        const loginForm = document.getElementById('loginForm');
        const signupForm = document.getElementById('signupForm');
        const loginErrorEl = document.getElementById('loginError');
        const signupErrorEl = document.getElementById('signupError');
        const authStatusEl = document.getElementById('authStatus');
        
        const sidebarProfileLink = document.getElementById('sidebarProfileLink');
        const headerUserIcon = document.getElementById('headerUserIcon');
        const footerProfileButton = document.getElementById('footerProfileButton');
        const sidebarLogoutLink = document.getElementById('sidebarLogoutLink');
        const sidebarInstructionLink = document.getElementById('sidebarInstructionLink');
        
        const topScorerModal = document.getElementById('topScorerModal');
        const sidebarTopScorerLink = document.getElementById('sidebarTopScorerLink');
        const closeTopScorerModalButton = document.getElementById('closeTopScorerModalButton');
        const topScorerListEl = document.getElementById('topScorerList');
        
        const loadingOverlay = document.getElementById('loadingOverlay');
        
        const sidebarFavoriteQuestionLink = document.getElementById('sidebarFavoriteQuestionLink');
        const favoriteQuestionsModal = document.getElementById('favoriteQuestionsModal');
        const closeFavoriteQuestionsModalButton = document.getElementById('closeFavoriteQuestionsModalButton');
        const favoriteQuestionsListEl = document.getElementById('favoriteQuestionsList');
        
        const sidebarRaiseComplaintLink = document.getElementById('sidebarRaiseComplaintLink');
        const complaintModal = document.getElementById('complaintModal');
        const closeComplaintModalButton = document.getElementById('closeComplaintModalButton');
        const complaintForm = document.getElementById('complaintForm');
        
        const sidebarInviteFriendsLink = document.getElementById('sidebarInviteFriendsLink');
        const whatsappShareHeaderBtn = document.getElementById('whatsappShareHeader');
        
        const shareModal = document.getElementById('shareModal');
        const shareModalTextEl = document.getElementById('shareModalText');
        const copyShareTextButton = document.getElementById('copyShareTextButton');
        const closeShareModalButton = document.getElementById('closeShareModalButton');
        
        const showRandomImpQuestionBtn = document.getElementById('showRandomImpQuestionBtn');
        const importantQuestionDisplayArea = document.getElementById('importantQuestionDisplayArea');
        const importantQuestionTextEl = document.getElementById('importantQuestionText');
        const importantAnswerTextEl = document.getElementById('importantAnswerText');

        const premiumTestButton = document.getElementById('unlockPremiumPlumberHindiButton');
        const premiumTestStatusEl = document.getElementById('premiumPlumberHindiStatus');
        const premiumPlumberHindiSubCardsContainer = document.getElementById('premiumPlumberHindiSubCardsContainer');

        // Gemini Q&A DOM Elements
        const userGeminiQuestionInput = document.getElementById('userGeminiQuestion');
        const askGeminiButton = document.getElementById('askGeminiButton');
        const geminiQALoader = document.getElementById('geminiQALoader');
        const geminiAnswerArea = document.getElementById('geminiAnswerArea');

        // Gemini Tool Info DOM Elements
        const getAdvancedToolInfoButton = document.getElementById('getAdvancedToolInfoButton');
        const geminiToolInfoLoader = document.getElementById('geminiToolInfoLoader');
        const geminiToolInfoArea = document.getElementById('geminiToolInfoArea');
        let currentToolForGemini = null; // To store current tool context for Gemini

        // Gemini Quiz Explanation DOM Elements
        const geminiQuizExplanationLoader = document.getElementById('geminiQuizExplanationLoader');
        const geminiQuizExplanationArea = document.getElementById('geminiQuizExplanationArea');


        // --- Google Sheets CRUD Functions ---
        async function sheetDbAction(action, payload = {}) {
            if (GOOGLE_SHEET_APP_URL === 'YOUR_GOOGLE_APPS_SCRIPT_WEB_APP_URL_HERE') {
                console.warn("Google Sheets URL is not configured. Operations will be simulated or fail. Please replace 'YOUR_GOOGLE_APPS_SCRIPT_WEB_APP_URL_HERE' in the script.");
                if (action === 'getUser') return { success: true, data: null }; 
                if (action === 'saveUser') return { success: true, data: payload };
                if (action === 'getTopScorers') return { success: true, data: [{displayName: "Test Scorer 1", coins: 1500}, {displayName: "Test Scorer 2", coins: 1200}] };
                return { success: false, error: "Google Sheets URL not configured." };
            }
            
            loadingOverlay.style.display = 'flex';
            try {
                const response = await fetch(GOOGLE_SHEET_APP_URL, {
                    method: 'POST',
                    mode: 'cors', 
                    cache: 'no-cache',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ action, ...payload }),
                    redirect: 'follow' 
                });
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error(`SheetDB Action '${action}' HTTP Error:`, response.status, errorText);
                    throw new Error(`Network response was not ok: ${response.status} - ${errorText}`);
                }
                const result = await response.json();
                console.log(`SheetDB Action '${action}' successful:`, result);
                return result;
            } catch (error) {
                console.error(`Error in sheetDbAction '${action}':`, error);
                return { success: false, error: error.message };
            } finally {
                loadingOverlay.style.display = 'none';
            }
        }
        
        async function loadUserDataFromSheet(email) {
            const result = await sheetDbAction('getUser', { email });
            if (result.success && result.data) {
                result.data.coins = parseInt(result.data.coins, 10) || 0;
                try { result.data.premiumAccess = result.data.premiumAccess ? JSON.parse(result.data.premiumAccess) : {}; } 
                catch (e) { console.warn("Could not parse premiumAccess:", e); result.data.premiumAccess = {}; }
                try { result.data.favoriteQuestions = result.data.favoriteQuestions ? JSON.parse(result.data.favoriteQuestions) : []; }
                catch (e) { console.warn("Could not parse favoriteQuestions:", e); result.data.favoriteQuestions = []; }
                return result.data;
            }
            return null;
        }

        async function saveUserDataToSheet(userDataToSave) {
            const payload = {
                ...userDataToSave,
                premiumAccess: JSON.stringify(userDataToSave.premiumAccess || {}),
                favoriteQuestions: JSON.stringify(userDataToSave.favoriteQuestions || [])
            };
            return await sheetDbAction('saveUser', payload);
        }

        async function loadTopScorersFromSheet() {
            const result = await sheetDbAction('getTopScorers');
            return (result.success && result.data) ? result.data : [];
        }

        // --- UI Update & Auth Logic ---
        function updateUIAfterAuthChange() {
            console.log("Updating UI based on auth state:", currentUserData);
            if (currentUserData.isLoggedIn) {
                userNameMainEl.textContent = currentUserData.displayName;
                userIdDisplayEl.textContent = currentUserData.email; 
                coinCountEl.textContent = currentUserData.coins;
                sidebarLogoutLink.classList.remove('hidden');
                
                authStatusEl.textContent = `Logged in as: ${currentUserData.displayName} (${currentUserData.email})`;
                authStatusEl.classList.remove('hidden');
                loginForm.classList.add('hidden'); 
                signupForm.classList.add('hidden');
                document.getElementById('loginTabButton').classList.add('hidden'); 
                document.getElementById('signupTabButton').classList.add('hidden'); 

            } else { 
                userNameMainEl.textContent = "Guest User (अतिथि)";
                userIdDisplayEl.textContent = "N/A";
                coinCountEl.textContent = 0;
                sidebarLogoutLink.classList.add('hidden');

                authStatusEl.classList.add('hidden');
                loginForm.classList.remove('hidden'); 
                signupForm.classList.add('hidden'); 
                document.getElementById('loginTabButton').classList.remove('hidden');
                document.getElementById('signupTabButton').classList.remove('hidden');
                loginTabButton.classList.add('active');
                signupTabButton.classList.remove('active');
            }
            updatePremiumTestUI(); 
            updateFavoriteQuestionIcons(); 
        }

        function openAuthModal() {
            console.log("Opening Auth Modal");
            authModal.classList.remove('hidden'); 
            setTimeout(() => authModal.classList.add('active'), 10); 
            document.body.style.overflow = 'hidden';
            loginErrorEl.classList.add('hidden');
            signupErrorEl.classList.add('hidden');
            loginForm.reset();
            signupForm.reset();
            updateUIAfterAuthChange(); 
        }
        
        closeAuthModalButton.addEventListener('click', () => {
            authModal.classList.remove('active');
            setTimeout(() => authModal.classList.add('hidden'), 300); 
            document.body.style.overflow = 'auto';
        });

        loginTabButton.addEventListener('click', () => {
            loginForm.classList.remove('hidden');
            signupForm.classList.add('hidden');
            loginTabButton.classList.add('active');
            signupTabButton.classList.remove('active');
        });

        signupTabButton.addEventListener('click', () => {
            loginForm.classList.add('hidden');
            signupForm.classList.remove('hidden');
            loginTabButton.classList.remove('active');
            signupTabButton.classList.add('active');
        });

        signupForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const name = signupForm.signupName.value.trim();
            const email = signupForm.signupEmail.value.trim().toLowerCase();
            const password = signupForm.signupPassword.value;
            signupErrorEl.classList.add('hidden');

            if (!name || !email || !password) { signupErrorEl.textContent = "All fields are required."; signupErrorEl.classList.remove('hidden'); return; }
            if (!email.includes('@')) { signupErrorEl.textContent = "Invalid email format."; signupErrorEl.classList.remove('hidden'); return; }
            if (password.length < 6) { signupErrorEl.textContent = "Password must be at least 6 characters."; signupErrorEl.classList.remove('hidden'); return; }

            loadingOverlay.style.display = 'flex';
            const existingUser = await loadUserDataFromSheet(email);
            if (existingUser) {
                signupErrorEl.textContent = "Email already exists. Please login.";
                signupErrorEl.classList.remove('hidden');
                loadingOverlay.style.display = 'none';
                return;
            }

            currentUserData = {
                userId: email, displayName: name, email: email, coins: 100, 
                premiumAccess: {}, favoriteQuestions: [], isLoggedIn: true, isSheetUser: true
            };
            
            if (email === PRE_APPROVED_USER_EMAIL) { 
                 const expiryDate = new Date(); expiryDate.setFullYear(expiryDate.getFullYear() + 1);
                 currentUserData.premiumAccess[PREMIUM_TEST_ID] = { expiresAt: expiryDate.toISOString().split('T')[0] };
                 currentUserData.coins = 1000; 
            }

            const saveResult = await saveUserDataToSheet(currentUserData);
            loadingOverlay.style.display = 'none';

            if (saveResult.success) {
                updateUIAfterAuthChange();
                closeAuthModalButton.click(); 
            } else {
                signupErrorEl.textContent = "Signup failed. " + (saveResult.error || "");
                signupErrorEl.classList.remove('hidden');
                currentUserData = { userId: null, displayName: "Guest User", email: null, coins: 0, premiumAccess: {}, favoriteQuestions: [], isLoggedIn: false, isSheetUser: false };
            }
        });

        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = loginForm.loginEmail.value.trim().toLowerCase();
            const password = loginForm.loginPassword.value;
            loginErrorEl.classList.add('hidden');

            if (!email || !password) { loginErrorEl.textContent = "Email and password are required."; loginErrorEl.classList.remove('hidden'); return; }
            
            if (email === PRE_APPROVED_USER_EMAIL && password === PRE_APPROVED_USER_PASS) {
                let userData = await loadUserDataFromSheet(email);
                if (!userData) { 
                    userData = { userId: email, displayName: "Test User (Approved)", email: email, coins: 1000, premiumAccess: {}, favoriteQuestions: [] };
                }
                const expiryDate = new Date(); expiryDate.setFullYear(expiryDate.getFullYear() + 1);
                userData.premiumAccess = { ...userData.premiumAccess, [PREMIUM_TEST_ID]: { expiresAt: expiryDate.toISOString().split('T')[0] }};
                userData.isLoggedIn = true; userData.isSheetUser = true;
                currentUserData = userData;
                await saveUserDataToSheet(currentUserData); 
                updateUIAfterAuthChange();
                closeAuthModalButton.click();
                return;
            }

            loadingOverlay.style.display = 'flex';
            const userDataFromSheet = await loadUserDataFromSheet(email);
            loadingOverlay.style.display = 'none';

            if (userDataFromSheet) {
                currentUserData = { ...userDataFromSheet, isLoggedIn: true, isSheetUser: true };
                updateUIAfterAuthChange();
                closeAuthModalButton.click();
            } else {
                loginErrorEl.textContent = "Invalid email or password / User not found.";
                loginErrorEl.classList.remove('hidden');
            }
        });
        
        sidebarLogoutLink.addEventListener('click', (e) => {
            e.preventDefault();
            currentUserData = { userId: null, displayName: "Guest User", email: null, coins: 0, premiumAccess: {}, favoriteQuestions: [], isLoggedIn: false, isSheetUser: false };
            updateUIAfterAuthChange();
            if (sidebar.classList.contains('open')) { toggleSidebar(); }
        });

        sidebarProfileLink.addEventListener('click', (e) => { e.preventDefault(); openAuthModal(); });
        headerUserIcon.addEventListener('click', openAuthModal);
        footerProfileButton.addEventListener('click', openAuthModal);

        sidebarTopScorerLink.addEventListener('click', async (e) => {
            e.preventDefault();
            topScorerModal.classList.remove('hidden');
            setTimeout(() => topScorerModal.classList.add('active'), 10);
            document.body.style.overflow = 'hidden';
            topScorerListEl.innerHTML = '<p class="text-center text-gray-500">Loading...</p>';
            const scorers = await loadTopScorersFromSheet();
            topScorerListEl.innerHTML = ''; 
            if (scorers && scorers.length > 0) {
                scorers.forEach((scorer, index) => {
                    const scorerDiv = document.createElement('div');
                    scorerDiv.className = 'flex items-center justify-between p-3 bg-white rounded-lg shadow-sm border border-gray-200';
                    let medal = index === 0 ? '🥇 1.' : index === 1 ? '🥈 2.' : index === 2 ? '🥉 3.' : `${index + 1}.`;
                    scorerDiv.innerHTML = `
                        <div class="flex items-center">
                            <span class="text-lg font-semibold mr-3 ${index < 3 ? (index === 0 ? 'text-yellow-500' : index === 1 ? 'text-gray-400' : 'text-orange-400') : 'text-gray-700'}">${medal}</span>
                            <img src="https://placehold.co/40x40/${Math.random().toString(16).substr(-6)}/${Math.random().toString(16).substr(-6)}?text=${scorer.displayName ? scorer.displayName.charAt(0).toUpperCase() : 'U'}" alt="User" class="w-10 h-10 rounded-full mr-3">
                            <span class="font-medium text-gray-800">${scorer.displayName || 'Anonymous'}</span>
                        </div>
                        <span class="font-semibold text-blue-600">${scorer.coins || 0} 🪙</span>`;
                    topScorerListEl.appendChild(scorerDiv);
                });
            } else {
                topScorerListEl.innerHTML = '<p class="text-center text-gray-500">No scorers data.</p>';
            }
        });
        closeTopScorerModalButton.addEventListener('click', () => {
            topScorerModal.classList.remove('active');
            setTimeout(() => topScorerModal.classList.add('hidden'), 300);
            document.body.style.overflow = 'auto';
        });

        function updatePremiumTestUI() {
            const testAccessData = currentUserData.premiumAccess?.[PREMIUM_TEST_ID];
            const userCoins = currentUserData.coins;
            
            premiumPlumberHindiSubCardsContainer.classList.add('hidden'); 
            premiumPlumberHindiSubCardsContainer.querySelectorAll('.premium-sub-card').forEach(card => {
                card.classList.add('disabled'); card.onclick = null;
            });

            if (testAccessData && testAccessData.expiresAt) {
                const expiryDate = new Date(testAccessData.expiresAt + "T23:59:59");
                if (expiryDate > new Date()) {
                    premiumTestStatusEl.textContent = `Unlocked! Expires: ${testAccessData.expiresAt}`;
                    premiumTestButton.textContent = "View Content";
                    premiumTestButton.className = "mb-3 w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-3 rounded-lg text-sm transition";
                    premiumTestButton.disabled = true; 
                    premiumPlumberHindiSubCardsContainer.classList.remove('hidden');
                    premiumPlumberHindiSubCardsContainer.querySelectorAll('.premium-sub-card').forEach(card => {
                        card.classList.remove('disabled');
                        card.onclick = () => openContentModalGeneric(card.dataset.subtest, true, false); 
                    });
                    return; 
                } else { premiumTestStatusEl.textContent = `Premium access expired.`; }
            } else { premiumTestStatusEl.textContent = `Cost: ${PREMIUM_TEST_COST} coins. You have ${userCoins}.`; }
            
            premiumTestButton.className = "mb-3 w-full bg-green-600 hover:bg-green-700 text-white font-semibold py-2 px-3 rounded-lg text-sm transition";
            
            if (currentUserData.isLoggedIn) { 
                if (userCoins >= PREMIUM_TEST_COST) {
                    premiumTestButton.textContent = `Unlock Section for ${PREMIUM_TEST_COST} 🪙`;
                    premiumTestButton.disabled = false;
                    premiumTestButton.classList.remove('opacity-50', 'cursor-not-allowed');
                    premiumTestButton.onclick = () => handleUnlockPremiumTest(PREMIUM_TEST_ID, PREMIUM_TEST_COST);
                } else {
                    premiumTestButton.textContent = `Need ${PREMIUM_TEST_COST - userCoins} more 🪙`;
                    premiumTestButton.disabled = true;
                    premiumTestButton.classList.add('opacity-50', 'cursor-not-allowed');
                    premiumTestButton.onclick = null;
                }
            } else { 
                premiumTestButton.textContent = `Login to Unlock (Cost: ${PREMIUM_TEST_COST} 🪙)`;
                premiumTestButton.disabled = true;
                premiumTestButton.classList.add('opacity-50', 'cursor-not-allowed');
                premiumTestButton.onclick = openAuthModal; 
            }
        }

        async function handleUnlockPremiumTest(testId, cost) {
            if (!currentUserData.isLoggedIn) { openAuthModal(); return; }
            if (currentUserData.coins < cost) { premiumTestStatusEl.textContent = "Not enough coins."; return; }
            
            const confirmationModalEl = document.getElementById('confirmationModal');
            document.getElementById('confirmationTitle').textContent = "Confirm Purchase";
            document.getElementById('confirmationMessage').textContent = `Unlock this section for ${cost} coins? This will grant access for 1 month.`;
            
            confirmationModalEl.classList.remove('hidden');
            setTimeout(() => confirmationModalEl.classList.add('active'), 10);

            document.getElementById('confirmUnlockButton').onclick = async () => {
                confirmationModalEl.classList.remove('active');
                setTimeout(() => confirmationModalEl.classList.add('hidden'), 300);
                
                currentUserData.coins -= cost;
                const expiryDate = new Date(); expiryDate.setMonth(expiryDate.getMonth() + 1);
                currentUserData.premiumAccess[testId] = { expiresAt: expiryDate.toISOString().split('T')[0] };
                
                const saveResult = await saveUserDataToSheet(currentUserData);
                if (!saveResult.success) { 
                    currentUserData.coins += cost; 
                    delete currentUserData.premiumAccess[testId];
                    premiumTestStatusEl.textContent = "Error unlocking. Please try again.";
                }
                updateUIAfterAuthChange(); 
            };
            document.getElementById('cancelUnlockButton').onclick = () => {
                confirmationModalEl.classList.remove('active');
                setTimeout(() => confirmationModalEl.classList.add('hidden'), 300);
            };
        }
        
        async function updateUserCoins(amount) {
            if (!currentUserData.isLoggedIn || !currentUserData.isSheetUser) {
                if (currentUserData.isLoggedIn) { currentUserData.coins += amount; updateUIAfterAuthChange(); }
                return;
            }
            currentUserData.coins += amount;
            const saveResult = await saveUserDataToSheet(currentUserData);
            if (!saveResult.success) { currentUserData.coins -= amount; } 
            updateUIAfterAuthChange(); 
        }

        const sidebar = document.getElementById('sidebar');
        const sidebarOverlay = document.getElementById('sidebarOverlay');
        const hamburgerButton = document.getElementById('hamburgerButton');
        function toggleSidebar() {
            sidebar.classList.toggle('open');
            sidebarOverlay.classList.toggle('hidden');
            if (sidebar.classList.contains('open')) {
                document.body.style.overflow = 'hidden'; 
            } else {
                document.body.style.overflow = 'auto';
            }
        }
        hamburgerButton.addEventListener('click', toggleSidebar);
        sidebarOverlay.addEventListener('click', toggleSidebar);

        const importantQuestions = [
            { q: "भारत में प्लंबिंग के लिए आमतौर पर किस प्रकार के पाइप का उपयोग किया जाता है?", a: "आमतौर पर पीवीसी (PVC), सीपीवीसी (CPVC), यूपीवीसी (UPVC), जीआई (GI - Galvanized Iron), और तांबे (Copper) के पाइप का उपयोग किया जाता है।" },
            { q: "पानी के रिसाव को रोकने के लिए सबसे अच्छा तरीका क्या है?", a: "नियमित रूप से पाइप और फिटिंग की जांच करें, उच्च गुणवत्ता वाली सामग्री का उपयोग करें, और सही स्थापना सुनिश्चित करें।" },
            { q: "एक 'वाटर हैमर अरेस्टर' क्या करता है?", a: "यह पाइपों में पानी के प्रवाह के अचानक रुकने या बदलने से होने वाले 'वाटर हैमर' (तेज आवाज और कंपन) को अवशोषित करता है।" },
            { q: "सुरक्षा के लिए गैस पाइपलाइन पर काम करते समय क्या सावधानियां बरतनी चाहिए?", a: "मुख्य गैस आपूर्ति बंद करें, क्षेत्र को हवादार करें, ज्वलनशील पदार्थों को दूर रखें, और चिंगारी पैदा करने वाले उपकरणों का उपयोग न करें।" }
        ];
        let lastDisplayedImpQIndex = -1;

        function displayRandomImportantQuestion() {
            if (importantQuestions.length === 0) return;
            let randomIndex;
            if (importantQuestions.length === 1) { randomIndex = 0; } 
            else { do { randomIndex = Math.floor(Math.random() * importantQuestions.length); } while (randomIndex === lastDisplayedImpQIndex); }
            lastDisplayedImpQIndex = randomIndex;
            const item = importantQuestions[randomIndex];
            importantQuestionTextEl.textContent = `प्रश्न: ${item.q}`;
            importantAnswerTextEl.textContent = `उत्तर: ${item.a}`;
            importantQuestionDisplayArea.style.display = 'block';
        }
        showRandomImpQuestionBtn.addEventListener('click', displayRandomImportantQuestion);

        const triggerQuizButton = document.getElementById('triggerQuizButton');
        const quizModalEl = document.getElementById('quizModal'); 
        const quizSetupScreen = document.getElementById('quizSetupScreen');
        const quizInterfaceScreen = document.getElementById('quizInterfaceScreen');
        const quizResultsScreen = document.getElementById('quizResultsScreen');
        const numQuestionsButtons = document.querySelectorAll('.num-questions-btn');
        const startSelectedQuizButton = document.getElementById('startSelectedQuizButton');
        const closeQuizSetupButton = document.getElementById('closeQuizSetupButton');
        const currentQuestionNumberEl = document.getElementById('currentQuestionNumber');
        const totalQuizQuestionsEl = document.getElementById('totalQuizQuestions');
        const quizTimerEl = document.getElementById('quizTimer');
        const questionTimerBar = document.getElementById('questionTimerBar');
        const questionImageContainer = document.getElementById('questionImageContainer');
        const questionImageEl = document.getElementById('questionImage');
        const questionTextQuizEl = document.getElementById('questionTextQuiz'); 
        const optionsContainer = document.getElementById('optionsContainer');
        const lifeline5050Button = document.getElementById('lifeline5050');
        const lifelineAudiencePollButton = document.getElementById('lifelineAudiencePoll');
        const audiencePollResultsEl = document.getElementById('audiencePollResults');
        const nextQuestionButton = document.getElementById('nextQuestionButton');
        const closeQuizInterfaceButton = document.getElementById('closeQuizInterfaceButton');
        const finalScoreEl = document.getElementById('finalScore');
        const correctAnswersCountEl = document.getElementById('correctAnswersCount');
        const playAgainButton = document.getElementById('playAgainButton');
        const closeQuizResultsButton = document.getElementById('closeQuizResultsButton');
        const coinsEarnedInQuizEl = document.getElementById('coinsEarnedInQuiz');
        const favoriteQuestionButton = document.getElementById('favoriteQuestionButton');
        const shareQuestionButton = document.getElementById('shareQuestionButton');

        let allPlumbingQuestions = [
            { id: "pq1", text: "चित्र में दिखाए गए उपकरण का नाम क्या है? (What is the name of the tool shown in the picture?)", image: "https://placehold.co/300x200/E0F2FE/3B82F6?text=Pipe+Wrench", options: [{ text: "पाइप रिंच (Pipe Wrench)", correct: true },{ text: "समायोज्य रिंच (Adjustable Wrench)", correct: false },{ text: "सॉकेट रिंच (Socket Wrench)", correct: false },{ text: "टॉर्क रिंच (Torque Wrench)", correct: false }]},
            { id: "pq2", text: "पानी के रिसाव को रोकने के लिए पाइप थ्रेड्स पर आमतौर पर किस सामग्री का उपयोग किया जाता है? (What material is commonly used on pipe threads to prevent water leaks?)", image: null, options: [{ text: "टेफ्लॉन टेप (Teflon Tape)", correct: true },{ text: "डक्ट टेप (Duct Tape)", correct: false },{ text: "रबर सीमेंट (Rubber Cement)", correct: false },{ text: "सिलिकॉन सीलेंट (Silicone Sealant)", correct: false }]},
            { id: "pq3", text: "पीवीसी का पूर्ण रूप क्या है? (What is the full form of PVC?)", image: null, options: [{ text: "पॉलीविनाइल क्लोराइड (Polyvinyl Chloride)", correct: true }, { text: "पॉलीविनाइल कार्बन (Polyvinyl Carbon)", correct: false }, { text: "प्रेसर वाल्व कंट्रोल (Pressure Valve Control)", correct: false }, { text: "पाइप वेरिफ़िकेशन कोड (Pipe Verification Code)", correct: false }]},
            { id: "pq4", text: "नाली की रुकावट को साफ करने के लिए किस उपकरण का उपयोग किया जाता है? (Which tool is used to clear a drain blockage?)", image: "https://placehold.co/300x200/E0F2FE/3B82F6?text=Drain+Auger", options: [{ text: "ड्रेन औगर (Drain Auger/Plunger)", correct: true }, { text: "हथौड़ा (Hammer)", correct: false }, { text: "पेंचकस (Screwdriver)", correct: false }, { text: "आरी (Saw)", correct: false }]}
        ];
        let currentQuizQuestions = [];
        let currentQuestionIndex = 0;
        let score = 0;
        let correctAnswers = 0;
        let coinsThisQuiz = 0; 
        let timeLeft = 60; 
        let timerInterval;
        let selectedNumOfQuestions = 0;
        let lifelines = { fiftyFiftyUsed: false, audiencePollUsed: false };

        triggerQuizButton.addEventListener('click', () => {
            if (!currentUserData.isLoggedIn) {
                openAuthModal();
                return;
            }
            console.log("Triggering quiz button");
            quizModalEl.classList.remove('hidden');
            setTimeout(() => quizModalEl.classList.add('active'), 10);
            document.body.style.overflow = 'hidden';
            showQuizScreen('setup');
        });

        function closeQuizModal() {
            quizModalEl.classList.remove('active');
            setTimeout(() => quizModalEl.classList.add('hidden'), 300);
            document.body.style.overflow = 'auto';
            if (timerInterval) clearInterval(timerInterval);
        }
        closeQuizSetupButton.addEventListener('click', closeQuizModal);
        closeQuizInterfaceButton.addEventListener('click', closeQuizModal);
        closeQuizResultsButton.addEventListener('click', closeQuizModal);

        numQuestionsButtons.forEach(button => {
            button.addEventListener('click', () => {
                selectedNumOfQuestions = parseInt(button.dataset.count);
                numQuestionsButtons.forEach(btn => btn.classList.remove('bg-green-500', 'text-white'));
                button.classList.add('bg-green-500', 'text-white');
                startSelectedQuizButton.disabled = false;
                startSelectedQuizButton.classList.remove('disabled:opacity-50');
            });
        });

        startSelectedQuizButton.addEventListener('click', () => {
            if (selectedNumOfQuestions > 0) {
                initializeQuiz();
                showQuizScreen('interface');
            }
        });
        
        function shuffleArray(array) { for (let i = array.length - 1; i > 0; i--) { const j = Math.floor(Math.random() * (i + 1)); [array[i], array[j]] = [array[j], array[i]]; } }

        function initializeQuiz() {
            currentQuizQuestions = [...allPlumbingQuestions];
            shuffleArray(currentQuizQuestions);
            currentQuizQuestions = currentQuizQuestions.slice(0, selectedNumOfQuestions);
            currentQuestionIndex = 0;
            score = 0;
            correctAnswers = 0;
            coinsThisQuiz = 0;
            lifelines = { fiftyFiftyUsed: false, audiencePollUsed: false };
            updateLifelineButtons();
        }

        function showQuizScreen(screenName) {
            quizSetupScreen.classList.add('hidden');
            quizInterfaceScreen.classList.add('hidden');
            quizResultsScreen.classList.add('hidden');

            if (screenName === 'setup') {
                quizSetupScreen.classList.remove('hidden');
                startSelectedQuizButton.disabled = true;
                startSelectedQuizButton.classList.add('disabled:opacity-50');
                numQuestionsButtons.forEach(btn => btn.classList.remove('bg-green-500', 'text-white'));
            } else if (screenName === 'interface') {
                quizInterfaceScreen.classList.remove('hidden');
                loadQuestion();
            } else if (screenName === 'results') {
                quizResultsScreen.classList.remove('hidden');
                finalScoreEl.textContent = `${score} / ${currentQuizQuestions.length * 10}`;
                correctAnswersCountEl.textContent = `${correctAnswers} / ${currentQuizQuestions.length}`;
                coinsThisQuiz = correctAnswers * 5; 
                coinsEarnedInQuizEl.textContent = coinsThisQuiz;
                updateUserCoins(coinsThisQuiz);
            }
        }
        
        function loadQuestion() {
            if (currentQuestionIndex >= currentQuizQuestions.length) {
                showQuizScreen('results');
                return;
            }
            const question = currentQuizQuestions[currentQuestionIndex];
            currentQuestionNumberEl.textContent = currentQuestionIndex + 1;
            totalQuizQuestionsEl.textContent = currentQuizQuestions.length;
            questionTextQuizEl.textContent = question.text;

            if (question.image) {
                questionImageEl.src = question.image;
                questionImageContainer.classList.remove('hidden');
            } else {
                questionImageContainer.classList.add('hidden');
            }

            optionsContainer.innerHTML = '';
            const shuffledOptions = [...question.options];
            shuffleArray(shuffledOptions); 

            shuffledOptions.forEach(option => {
                const button = document.createElement('button');
                button.className = 'quiz-option block w-full text-left p-3 border-2 border-gray-300 rounded-lg hover:bg-blue-100 transition';
                button.textContent = option.text;
                button.onclick = () => handleAnswer(option.correct, button, Array.from(optionsContainer.children), option.text);
                optionsContainer.appendChild(button);
            });
            
            updateFavoriteQuestionButton(question.id);
            nextQuestionButton.classList.add('hidden');
            geminiQuizExplanationArea.style.display = 'none'; // Hide previous explanation
            geminiQuizExplanationArea.innerHTML = '';
            resetTimer();
            startTimer();
            audiencePollResultsEl.classList.add('hidden');
            optionsContainer.querySelectorAll('.quiz-option').forEach(opt => opt.classList.remove('disabled'));
        }

        function handleAnswer(isCorrect, selectedButton, allDisplayedOptions, selectedOptionText) {
            if (timerInterval) clearInterval(timerInterval);
            allDisplayedOptions.forEach(opt => {
                opt.classList.add('disabled'); 
                const originalOption = currentQuizQuestions[currentQuestionIndex].options.find(o => o.text === opt.textContent);
                if (originalOption) {
                    if (originalOption.correct) opt.classList.add('correct');
                    else if (opt === selectedButton) opt.classList.add('incorrect'); 
                }
            });

            if (isCorrect) {
                score += 10;
                correctAnswers++;
                if(selectedButton) { 
                    selectedButton.classList.remove('incorrect'); 
                    selectedButton.classList.add('correct');
                }
            } else {
                if(selectedButton) selectedButton.classList.add('incorrect');
            }
            
            // Get AI Explanation
            const currentQuestion = currentQuizQuestions[currentQuestionIndex];
            getQuizExplanationFromGemini(currentQuestion, selectedOptionText, isCorrect);

            nextQuestionButton.classList.remove('hidden');
        }

        async function getQuizExplanationFromGemini(question, selectedOptionText, isCorrect) {
            geminiQuizExplanationLoader.classList.add('active');
            geminiQuizExplanationArea.style.display = 'none';
            geminiQuizExplanationArea.innerHTML = '';

            const correctAnswerText = question.options.find(opt => opt.correct).text;
            let prompt;
            if (isCorrect) {
                prompt = `प्रश्न है: "${question.text}". उपयोगकर्ता ने सही उत्तर चुना: "${selectedOptionText}". कृपया स्पष्ट करें कि यह उत्तर सही क्यों है। प्लंबिंग के संदर्भ में सरल हिंदी में समझाएं।`;
            } else {
                prompt = `प्रश्न है: "${question.text}". उपयोगकर्ता ने गलत उत्तर चुना: "${selectedOptionText}". सही उत्तर है: "${correctAnswerText}". कृपया स्पष्ट करें कि उपयोगकर्ता का उत्तर गलत क्यों था और सही उत्तर (${correctAnswerText}) सही क्यों है। प्लंबिंग के संदर्भ में सरल हिंदी में समझाएं।`;
            }
            
            await callGeminiAPI(prompt, geminiQuizExplanationLoader, geminiQuizExplanationArea, true);
        }


        nextQuestionButton.addEventListener('click', () => {
            currentQuestionIndex++;
            loadQuestion();
        });

        function startTimer() {
            timeLeft = 60;
            quizTimerEl.textContent = `01:00`;
            questionTimerBar.style.width = '100%';
            questionTimerBar.style.backgroundColor = '#3B82F6'; 

            timerInterval = setInterval(() => {
                timeLeft--;
                const minutes = Math.floor(timeLeft / 60);
                const seconds = timeLeft % 60;
                quizTimerEl.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                questionTimerBar.style.width = `${(timeLeft / 60) * 100}%`;

                if (timeLeft <= 10 && timeLeft > 5) questionTimerBar.style.backgroundColor = '#F59E0B'; 
                else if (timeLeft <= 5) questionTimerBar.style.backgroundColor = '#EF4444'; 

                if (timeLeft <= 0) {
                    clearInterval(timerInterval);
                    quizTimerEl.textContent = "00:00";
                    const firstOptionText = currentQuizQuestions[currentQuestionIndex].options[0].text; // Default to first option if timer runs out
                    handleAnswer(false, null, Array.from(optionsContainer.children), firstOptionText); 
                }
            }, 1000);
        }
        function resetTimer() { if (timerInterval) clearInterval(timerInterval); }

        lifeline5050Button.addEventListener('click', () => {
            if (lifelines.fiftyFiftyUsed || !optionsContainer.children.length) return;
            const question = currentQuizQuestions[currentQuestionIndex];
            let incorrectOptions = Array.from(optionsContainer.children).filter(btn => {
                const optText = btn.textContent;
                return !question.options.find(o => o.text === optText && o.correct);
            });
            shuffleArray(incorrectOptions);
            for (let i = 0; i < 2 && incorrectOptions.length > 0; i++) {
                if(incorrectOptions[i]) incorrectOptions[i].classList.add('hidden');
            }
            lifelines.fiftyFiftyUsed = true;
            updateLifelineButtons();
        });

        lifelineAudiencePollButton.addEventListener('click', () => {
            if (lifelines.audiencePollUsed || !optionsContainer.children.length) return;
            audiencePollResultsEl.innerHTML = '';
            const question = currentQuizQuestions[currentQuestionIndex];
            const options = Array.from(optionsContainer.children).filter(opt => !opt.classList.contains('hidden')); 
            
            let totalVotes = 0;
            const votes = options.map(opt => {
                const originalOption = question.options.find(o => o.text === opt.textContent);
                let votePercent = Math.floor(Math.random() * 30) + 5; 
                if (originalOption && originalOption.correct) {
                    votePercent += Math.floor(Math.random() * 40) + 20; 
                }
                totalVotes += votePercent;
                return { text: opt.textContent, percent: votePercent };
            });

            votes.forEach(vote => {
                const barDiv = document.createElement('div');
                barDiv.className = 'flex items-center justify-between text-sm';
                const normalizedPercent = totalVotes > 0 ? Math.round((vote.percent / totalVotes) * 100) : 0;
                barDiv.innerHTML = `
                    <span>${vote.text}</span>
                    <div class="w-3/5 bg-gray-200 rounded-full h-4 dark:bg-gray-700">
                        <div class="audience-poll-bar h-4 rounded-full text-xs text-white text-center leading-4" style="width: ${normalizedPercent}%">${normalizedPercent}%</div>
                    </div>`;
                audiencePollResultsEl.appendChild(barDiv);
            });

            audiencePollResultsEl.classList.remove('hidden');
            lifelines.audiencePollUsed = true;
            updateLifelineButtons();
        });

        function updateLifelineButtons() {
            lifeline5050Button.disabled = lifelines.fiftyFiftyUsed;
            lifelineAudiencePollButton.disabled = lifelines.audiencePollUsed;
            if(lifelines.fiftyFiftyUsed) lifeline5050Button.classList.add('disabled'); else lifeline5050Button.classList.remove('disabled');
            if(lifelines.audiencePollUsed) lifelineAudiencePollButton.classList.add('disabled'); else lifelineAudiencePollButton.classList.remove('disabled');
        }
        playAgainButton.addEventListener('click', () => { showQuizScreen('setup'); });

        favoriteQuestionButton.addEventListener('click', () => {
            if (!currentUserData.isLoggedIn || !currentQuizQuestions[currentQuestionIndex]) return;
            const question = currentQuizQuestions[currentQuestionIndex];
            toggleFavoriteQuestion(question);
        });

        async function toggleFavoriteQuestion(question) {
            const questionId = question.id;
            const isFavorited = currentUserData.favoriteQuestions.some(fav => fav.id === questionId);
            if (isFavorited) {
                currentUserData.favoriteQuestions = currentUserData.favoriteQuestions.filter(fav => fav.id !== questionId);
            } else {
                currentUserData.favoriteQuestions.push({ id: question.id, text: question.text, image: question.image });
            }
            updateFavoriteQuestionButton(questionId);
            if (currentUserData.isSheetUser) { await saveUserDataToSheet(currentUserData); }
        }

        function updateFavoriteQuestionButton(questionId) {
            if (!currentUserData.isLoggedIn) {
                 favoriteQuestionButton.innerHTML = '<i class="far fa-star"></i>'; 
                 favoriteQuestionButton.classList.remove('favorited'); return;
            }
            const isFavorited = currentUserData.favoriteQuestions.some(fav => fav.id === questionId);
            favoriteQuestionButton.innerHTML = isFavorited ? '<i class="fas fa-star"></i>' : '<i class="far fa-star"></i>';
            if(isFavorited) favoriteQuestionButton.classList.add('favorited'); else favoriteQuestionButton.classList.remove('favorited');
        }
        
        function updateFavoriteQuestionIcons() { 
            if (quizInterfaceScreen.style.display !== 'hidden' && currentQuizQuestions.length > 0 && currentQuizQuestions[currentQuestionIndex]) {
                updateFavoriteQuestionButton(currentQuizQuestions[currentQuestionIndex].id);
            }
        }

        sidebarFavoriteQuestionLink.addEventListener('click', (e) => {
            e.preventDefault();
            if (!currentUserData.isLoggedIn) { openAuthModal(); return; }
            favoriteQuestionsListEl.innerHTML = ''; 
            if (currentUserData.favoriteQuestions.length === 0) {
                favoriteQuestionsListEl.innerHTML = '<p class="text-center text-gray-500">No favorite questions saved.</p>';
            } else {
                currentUserData.favoriteQuestions.forEach(favQuestion => {
                    const div = document.createElement('div');
                    div.className = 'p-3 border rounded-md bg-blue-50 shadow-sm';
                    div.innerHTML = `<h4 class="font-semibold text-blue-700">${favQuestion.text}</h4> 
                                     ${favQuestion.image ? `<img src="${favQuestion.image}" alt="Fav Q Img" class="max-w-xs h-auto my-2 rounded">` : ''}
                                     <button data-id="${favQuestion.id}" class="remove-favorite-btn mt-2 text-xs text-red-500 hover:text-red-700">Remove</button>`;
                    favoriteQuestionsListEl.appendChild(div);
                });
                document.querySelectorAll('.remove-favorite-btn').forEach(btn => {
                    btn.addEventListener('click', async function() {
                        const idToRemove = this.dataset.id;
                        currentUserData.favoriteQuestions = currentUserData.favoriteQuestions.filter(q => q.id !== idToRemove);
                        if (currentUserData.isSheetUser) { await saveUserDataToSheet(currentUserData); }
                        sidebarFavoriteQuestionLink.click(); 
                        updateFavoriteQuestionIcons(); 
                    });
                });
            }
            favoriteQuestionsModal.classList.remove('hidden');
            setTimeout(() => favoriteQuestionsModal.classList.add('active'), 10);
            document.body.style.overflow = 'hidden';
        });
        closeFavoriteQuestionsModalButton.addEventListener('click', () => {
            favoriteQuestionsModal.classList.remove('active');
            setTimeout(() => favoriteQuestionsModal.classList.add('hidden'), 300);
            document.body.style.overflow = 'auto';
        });

        sidebarRaiseComplaintLink.addEventListener('click', (e) => {
            e.preventDefault();
            complaintModal.classList.remove('hidden');
            setTimeout(() => complaintModal.classList.add('active'), 10);
            document.body.style.overflow = 'hidden';
        });
        closeComplaintModalButton.addEventListener('click', () => {
            complaintModal.classList.remove('active');
            setTimeout(() => complaintModal.classList.add('hidden'), 300);
            document.body.style.overflow = 'auto';
        });
        complaintForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const complaintText = document.getElementById('complaintText').value.trim();
            if (!complaintText) { alert("Please write your complaint."); return; }
            const subject = "Mock Test App Complaint/Feedback";
            const body = `User Email: ${currentUserData.email || 'Not Logged In'}\nUser ID: ${currentUserData.userId || 'N/A'}\n\nComplaint:\n${complaintText}`;
            const mailtoLink = `mailto:kidsfation@gmail.com?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
            window.location.href = mailtoLink;
            complaintForm.reset();
            closeComplaintModalButton.click();
        });

        function setupShareButtons() {
            const appUrl = window.location.href;
            const shareMessage = `Check out this Mock Test App for ITI Plumbers: ${appUrl}`;

            sidebarInviteFriendsLink.addEventListener('click', async (e) => {
                e.preventDefault();
                if (navigator.share) {
                    try { await navigator.share({ title: 'ITI Mock Test App', text: shareMessage, url: appUrl }); } 
                    catch (err) { openShareModal(shareMessage); }
                } else { openShareModal(shareMessage); }
            });
            whatsappShareHeaderBtn.href = `https://api.whatsapp.com/send?text=${encodeURIComponent(shareMessage)}`;
            shareQuestionButton.addEventListener('click', async () => {
                if (!currentQuizQuestions[currentQuestionIndex]) return;
                const q = currentQuizQuestions[currentQuestionIndex];
                const correctOpt = q.options.find(opt => opt.correct);
                const questionShareText = `Plumber Quiz Q: ${q.text}\nOptions: ${q.options.map((opt, i) => `${String.fromCharCode(65+i)}. ${opt.text}`).join('\n')}\nCorrect: ${correctOpt ? correctOpt.text : 'N/A'}\n\nTry this app: ${appUrl}`;
                if (navigator.share) {
                    try { await navigator.share({ title: 'Plumbing Quiz Question', text: questionShareText }); } 
                    catch (err) { openShareModal(questionShareText); }
                } else { openShareModal(questionShareText); }
            });
            document.getElementById('shareContentButton').addEventListener('click', async () => {
                const title = document.getElementById('contentModalTitle').textContent;
                const contentShareText = `Check out: "${title}" on ITI Mock Test App: ${appUrl}`;
                 if (navigator.share) {
                    try { await navigator.share({ title: title, text: contentShareText, url: appUrl }); } 
                    catch (err) { openShareModal(contentShareText); }
                } else { openShareModal(contentShareText); }
            });
        }

        function openShareModal(textToShare) {
            shareModalTextEl.textContent = textToShare;
            shareModal.classList.remove('hidden');
            setTimeout(() => shareModal.classList.add('active'), 10);
        }
        copyShareTextButton.addEventListener('click', () => {
            navigator.clipboard.writeText(shareModalTextEl.textContent)
                .then(() => alert("Text copied!"))
                .catch(err => console.error('Failed to copy: ', err));
        });
        closeShareModalButton.addEventListener('click', () => {
            shareModal.classList.remove('active');
            setTimeout(() => shareModal.classList.add('hidden'), 300);
        });

        const contentModalEl = document.getElementById('contentModal'); 
        const contentModalTitle = document.getElementById('contentModalTitle');
        const contentModalImageContainer = document.getElementById('contentModalImageContainer');
        const contentModalImage = document.getElementById('contentModalImage');
        const contentModalBody = document.getElementById('contentModalBody');
        const closeContentModalButton = document.getElementById('closeContentModalButton');
        
        const freeContentData = {
            "basic_concepts_en": { title: "Basic Plumbing Concepts", image: "https://placehold.co/300x150/E0F2FE/0284C7?text=Basic+Concepts", content: "<p>Water supply systems, drainage systems, types of pipes (PVC, CPVC, GI, Copper), common fittings and their uses.</p><p>Understanding pressure and flow.</p>" },
            "safety_symbols_en": { title: "Safety Symbols in Plumbing", image: "https://placehold.co/300x150/E0F2FE/0284C7?text=Safety+Symbols", content: "<p>Common safety signs: Danger, Warning, Caution. PPE symbols. Emergency shutdown symbols.</p>" },
            "measurement_tools_en": { title: "Measurement Tools", image: "https://placehold.co/300x150/E0F2FE/0284C7?text=Measuring+Tools", content: "<p>Measuring tapes, rulers, calipers, levels. How to use them accurately for pipe cutting and alignment.</p>" },
            "practice_drills_en": { title: "Practice Drills", image: "https://placehold.co/300x150/E0F2FE/0284C7?text=Drills", content: "<p>Simple exercises: Identify fittings, match tools to tasks, basic pipe joining techniques (conceptual).</p>" },
            "instructions_sidebar": { title: "Instructions (निर्देश)", image: "https://placehold.co/300x150/E0F2FE/1D4ED8?text=निर्देश", content: "<h3>Welcome to the ITI Plumber Mock Test App!</h3><p>This application is designed to help ITI Plumber trade students prepare for their exams.</p><ul><li>Practice with mock tests.</li><li>Learn about various plumbing tools and concepts.</li><li>Track your progress and compete with others.</li><li>Use lifelines in quizzes to help you out.</li><li>Ask Gemini AI for explanations and advanced details.</li></ul><p><strong>This application is developed by Suleiman ITI Topper.</strong></p><p>We hope this app helps you succeed in your studies!</p>" }
        };
        const premiumContentData = {
            "handwritten_notes_hi": { title: "प्लंबिंग हस्तलिखित नोट्स (PDF)", image: "https://placehold.co/300x150/FEF3C7/D97706?text=हस्तलिखित+नोट्स", content: "<p>विस्तृत हस्तलिखित नोट्स विभिन्न प्लंबिंग विषयों पर।</p><p>पानी की आपूर्ति, जल निकासी व्यवस्था, पाइप फिटिंग, सुरक्षा सावधानियां।</p><p><strong>(यह सुविधा जल्द ही उपलब्ध होगी - PDF अपलोड किए जाएंगे।)</strong></p>" },
            "theory_hi": { title: "प्लंबिंग थ्योरी (सिद्धांत)", image: "https://placehold.co/300x150/FEF3C7/D97706?text=थ्योरी", content: "<p>प्लंबिंग के महत्वपूर्ण सिद्धांत और अवधारणाएं।</p><p>द्रव यांत्रिकी के मूल सिद्धांत, विभिन्न प्रकार के वाल्व और उनके कार्य।</p>" },
            "mock_test_hi": { title: "प्लंबिंग मॉक टेस्ट (PDF)", image: "https://placehold.co/300x150/FEF3C7/D97706?text=मॉक+टेस्ट", content: "<p>परीक्षा पैटर्न पर आधारित मॉक टेस्ट।</p><p>समय प्रबंधन और प्रश्न हल करने का अभ्यास करें।</p><p><strong>(यह सुविधा जल्द ही उपलब्ध होगी - PDF आधारित मॉक टेस्ट जोड़े जाएंगे।)</strong></p>" },
            "test_preparation_hi": { title: "परीक्षा की तैयारी (1000 MCQ)", image: "https://placehold.co/300x150/FEF3C7/D97706?text=1000+MCQ", content: "<p>परीक्षा में सफलता के लिए महत्वपूर्ण टिप्स और रणनीतियाँ।</p><p>इस सेक्शन में जल्द ही 1000+ महत्वपूर्ण बहुविकल्पीय प्रश्न (MCQ) जोड़े जाएंगे।</p>" },
            "file_making_hi": { title: "प्रैक्टिकल फाइल मेकिंग (Images)", image: "https://placehold.co/300x150/FEF3C7/D97706?text=फाइल+मेकिंग", content: "<p>आईटीआई प्रैक्टिकल फाइल बनाने के लिए मार्गदर्शन।</p><p>आवश्यक चित्र और प्रक्रियाएं।</p><p><strong>(यह सुविधा जल्द ही उपलब्ध होगी - प्रैक्टिकल फाइल से संबंधित चित्र अपलोड किए जाएंगे।)</strong></p>" },
            "tools_detail_hi": { title: "प्लंबिंग उपकरण विवरण (AI)", image: "https://placehold.co/300x150/FEF3C7/D97706?text=उपकरण+AI", content: "<p>विभिन्न प्लंबिंग उपकरणों का विस्तृत विवरण और उनके उपयोग।</p><p>पाइप रिंच, कटर, थ्रेडिंग मशीन, आदि। AI द्वारा उत्पन्न उन्नत विवरण के लिए बटन का उपयोग करें।</p>" }
        };

        const allToolsData = {
            "hand_tools": {
                name: "Hand Tools (हस्त उपकरण)",
                icon: "fas fa-tools",
                subcategories: {
                    "wrenches": { name: "Wrenches (रिंच)", items: [ { name: "Pipe Wrench (पाइप रिंच)", desc: "Used for gripping and turning pipes." }, { name: "Adjustable Wrench (समायोज्य रिंच)", desc: "Versatile for different nut/bolt sizes." } ] },
                    "cutters": { name: "Cutters (कटर)", items: [ { name: "PVC Pipe Cutter (पीवीसी पाइप कटर)", desc: "For clean cuts on PVC pipes." }, { name: "Hacksaw (हैकसॉ)", desc: "For cutting metal pipes." } ] }
                }
            },
            "power_tools": {
                name: "Power Tools (शक्ति उपकरण)",
                icon: "fas fa-bolt",
                subcategories: {
                    "drills": { name: "Drills (ड्रिल)", items: [ { name: "Cordless Drill (ताररहित ड्रिल)", desc: "For drilling holes and driving screws." } ] },
                    "threading_machines": { name: "Threading Machines (थ्रेडिंग मशीन)", items: [ { name: "Pipe Threading Machine (पाइप थ्रेडिंग मशीन)", desc: "For creating threads on pipes." } ] }
                }
            },
             "safety_equipment": {
                name: "Safety Equipment (सुरक्षा उपकरण)",
                icon: "fas fa-hard-hat",
                subcategories: {
                    "personal_ppe": { name: "Personal Protective Equipment (व्यक्तिगत सुरक्षा उपकरण)", items: [ { name: "Safety Glasses (सुरक्षा चश्मा)", desc: "Protect eyes from debris." }, { name: "Gloves (दस्ताने)", desc: "Protect hands from cuts and chemicals." }, { name: "Hard Hat (हार्ड हैट)", desc: "Protect head from falling objects." } ] }
                }
            }
        };
        
        const allToolsContainer = document.getElementById('allToolsContainer');

        function renderAllTools() {
            allToolsContainer.innerHTML = ''; 
            for (const categoryKey in allToolsData) {
                const category = allToolsData[categoryKey];
                const categoryDiv = document.createElement('div');
                categoryDiv.className = 'mb-3 border border-gray-200 rounded-lg shadow-sm';

                const header = document.createElement('div');
                header.className = 'tool-category-header bg-gray-100 p-3 flex justify-between items-center rounded-t-lg';
                header.innerHTML = `
                    <h4 class="font-semibold text-gray-700 flex items-center">
                        <i class="${category.icon} mr-2 text-blue-500"></i> ${category.name}
                    </h4>
                    <i class="fas fa-chevron-down text-gray-500 transform transition-transform"></i>`;
                
                const listContainer = document.createElement('div');
                listContainer.className = 'tool-list-container bg-white p-3 rounded-b-lg';

                for (const subCategoryKey in category.subcategories) {
                    const subCategory = category.subcategories[subCategoryKey];
                    const subCatHeader = document.createElement('div');
                    subCatHeader.className = 'tool-subcategory-header p-2 my-1 bg-blue-50 rounded flex justify-between items-center';
                    subCatHeader.innerHTML = `
                        <h5 class="font-medium text-blue-700">${subCategory.name}</h5>
                        <i class="fas fa-plus text-blue-400 transform transition-transform text-sm"></i>`;
                    
                    const subCatItemsContainer = document.createElement('div');
                    subCatItemsContainer.className = 'tool-subcategory-container pl-2 border-l-2 border-blue-200 ml-1';

                    subCategory.items.forEach(item => {
                        const itemDiv = document.createElement('div');
                        itemDiv.className = 'tool-item p-2 hover:bg-blue-50 rounded cursor-pointer';
                        itemDiv.textContent = item.name;
                        itemDiv.onclick = () => openContentModalGeneric(item.name, false, true, item);
                        subCatItemsContainer.appendChild(itemDiv);
                    });
                    
                    subCatHeader.onclick = (e) => {
                        e.stopPropagation(); 
                        subCatItemsContainer.classList.toggle('open');
                        subCatHeader.querySelector('i').classList.toggle('fa-plus');
                        subCatHeader.querySelector('i').classList.toggle('fa-minus');
                    };
                    listContainer.appendChild(subCatHeader);
                    listContainer.appendChild(subCatItemsContainer);
                }
                
                header.onclick = () => {
                    listContainer.classList.toggle('open');
                    const icon = header.querySelector('i.fas');
                    icon.classList.toggle('fa-chevron-down');
                    icon.classList.toggle('fa-chevron-up');
                };

                categoryDiv.appendChild(header);
                categoryDiv.appendChild(listContainer);
                allToolsContainer.appendChild(categoryDiv);
            }
        }
        
        function openContentModalGeneric(contentKey, isPremium = false, isTool = false, toolData = null, isInstruction = false) {
            let data;
            currentToolForGemini = null; 
            geminiToolInfoArea.style.display = 'none'; 
            geminiToolInfoArea.innerHTML = '';
            getAdvancedToolInfoButton.classList.add('hidden');


            if (isTool && toolData) {
                data = { title: toolData.name, content: `<p>${toolData.desc}</p>`, image: `https://placehold.co/300x150/E0F2FE/0284C7?text=${encodeURIComponent(toolData.name.substring(0,15))}` };
                currentToolForGemini = toolData; 
                getAdvancedToolInfoButton.classList.remove('hidden'); 
            } else if (isInstruction) {
                 data = freeContentData[contentKey];
            }
            else {
                data = isPremium ? premiumContentData[contentKey] : freeContentData[contentKey];
            }

            if (!data) { console.error("Content not found for key:", contentKey); return; }

            contentModalTitle.textContent = data.title;
            contentModalBody.innerHTML = data.content; 
            if (data.image) {
                contentModalImage.src = data.image;
                contentModalImageContainer.classList.remove('hidden');
            } else {
                contentModalImageContainer.classList.add('hidden');
            }
            contentModalEl.classList.remove('hidden');
            setTimeout(() => contentModalEl.classList.add('active'), 10);
            document.body.style.overflow = 'hidden';
        }
        
        document.querySelectorAll('#freePlumberEnglishSubCardsContainer .free-sub-card').forEach(card => {
            card.addEventListener('click', () => openContentModalGeneric(card.dataset.subtest, false, false));
        });

        sidebarInstructionLink.addEventListener('click', (e) => {
            e.preventDefault();
            openContentModalGeneric('instructions_sidebar', false, false, null, true);
            if (sidebar.classList.contains('open')) { toggleSidebar(); }
        });
        
        closeContentModalButton.addEventListener('click', () => {
            contentModalEl.classList.remove('active');
            setTimeout(() => contentModalEl.classList.add('hidden'), 300);
            document.body.style.overflow = 'auto';
        });
        contentModalEl.addEventListener('click', (event) => { 
            if (event.target === contentModalEl) { closeContentModalButton.click(); }
        });

        // --- Gemini API Integration ---
        async function callGeminiAPI(promptText, loaderElement, answerElement, isQuizExplanation = false) {
            if (!promptText) {
                answerElement.textContent = "Please enter a question or provide content for Gemini.";
                answerElement.style.display = 'block';
                return;
            }

            loaderElement.classList.add('active');
            answerElement.style.display = 'none';
            answerElement.textContent = '';

            const payload = {
                contents: [{ role: "user", parts: [{ text: promptText }] }]
            };

            try {
                const response = await fetch(GEMINI_API_URL_TEXT, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    const errorResult = await response.json();
                    console.error('Gemini API Error:', errorResult);
                    throw new Error(`Gemini API request failed: ${errorResult.error?.message || response.statusText}`);
                }

                const result = await response.json();

                if (result.candidates && result.candidates.length > 0 &&
                    result.candidates[0].content && result.candidates[0].content.parts &&
                    result.candidates[0].content.parts.length > 0) {
                    const text = result.candidates[0].content.parts[0].text;
                    let htmlText = text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>'); 
                    htmlText = htmlText.replace(/\n/g, '<br>'); 
                    answerElement.innerHTML = htmlText;
                } else {
                    answerElement.textContent = "Sorry, I couldn't get a response from Gemini. (माफ़ कीजिए, मुझे Gemini से कोई जवाब नहीं मिला।)";
                    console.warn("Unexpected Gemini API response structure:", result);
                }
            } catch (error) {
                console.error('Error calling Gemini API:', error);
                answerElement.textContent = `Error: ${error.message}. Check console for details. (त्रुटि: ${error.message}) Konsol dekhen.`;
            } finally {
                loaderElement.classList.remove('active');
                answerElement.style.display = 'block';
            }
        }

        askGeminiButton.addEventListener('click', () => {
            const userQuestion = userGeminiQuestionInput.value.trim();
            const prompt = `You are a helpful assistant for ITI Plumber trade students in India. Answer the following plumbing-related question clearly and concisely, in simple Hindi if possible, otherwise in English: "${userQuestion}"`;
            callGeminiAPI(prompt, geminiQALoader, geminiAnswerArea);
        });
        
        getAdvancedToolInfoButton.addEventListener('click', () => {
            if (currentToolForGemini) {
                const toolName = currentToolForGemini.name;
                const toolDesc = currentToolForGemini.desc;
                const prompt = `You are a helpful assistant for ITI Plumber trade students in India. Provide advanced details for the plumbing tool: "${toolName}". Its basic description is: "${toolDesc}". Include common problems encountered with this tool, safety precautions, and any advanced usage tips. Provide the answer in simple Hindi if possible, otherwise in English. Format the response with headings for 'Common Problems', 'Safety Precautions', and 'Advanced Usage Tips'.`;
                callGeminiAPI(prompt, geminiToolInfoLoader, geminiToolInfoArea);
            }
        });


        // --- Initial Setup ---
        document.addEventListener('DOMContentLoaded', () => {
            console.log("DOM fully loaded and parsed");
            updateUIAfterAuthChange(); 
            renderAllTools();
            displayRandomImportantQuestion();
            setupShareButtons();
            updatePremiumTestUI(); 
        });

    </script>

</body>
</html>
